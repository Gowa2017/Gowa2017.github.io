<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="退思园" type="application/atom+xml">
  <meta name="google-site-verification" content="EDvvZZUFkxy_QUzZTaqwsG_9VHqFthY-NhQE4j6WL-s">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: 'LHD9LWONQ3',
      apiKey: '23a113c49e36d8cc93f61239cb530b43',
      indexName: 'gowa.club',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="最近才有机会来看一下这个东西，虽然非常的喜欢Lua，但是现有的项目还是懒得去转换成Lua了，毕竟 Cocos Creator 还是很好用的至少简单，所以来理一理其工作流程。">
<meta name="keywords" content="Cocos Creator">
<meta property="og:type" content="article">
<meta property="og:title" content="Cocos Creator生成项目的启动工作流程">
<meta property="og:url" content="https://gowa.club/Cocos-Creator/Cocos Creator生成项目的启动工作流程.html">
<meta property="og:site_name" content="退思园">
<meta property="og:description" content="最近才有机会来看一下这个东西，虽然非常的喜欢Lua，但是现有的项目还是懒得去转换成Lua了，毕竟 Cocos Creator 还是很好用的至少简单，所以来理一理其工作流程。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-02T02:46:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cocos Creator生成项目的启动工作流程">
<meta name="twitter:description" content="最近才有机会来看一下这个东西，虽然非常的喜欢Lua，但是现有的项目还是懒得去转换成Lua了，毕竟 Cocos Creator 还是很好用的至少简单，所以来理一理其工作流程。">

<link rel="canonical" href="https://gowa.club/Cocos-Creator/Cocos Creator生成项目的启动工作流程.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Cocos Creator生成项目的启动工作流程 | 退思园</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137245514-1"></script>
    <script>
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-137245514-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">退思园</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">烦恼一般都是想太多了。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-soft">

    <a href="/soft/" rel="section"><i class="fa fa-fw fa-rocket"></i>soft</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input" id="search-input"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gowa.club/Cocos-Creator/Cocos Creator生成项目的启动工作流程.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Gowa2017 Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="退思园">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cocos Creator生成项目的启动工作流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-02 10:46:11" itemprop="dateCreated datePublished" datetime="2018-09-02T10:46:11+08:00">2018-09-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cocos-Creator/" itemprop="url" rel="index">
                    <span itemprop="name">Cocos Creator</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Cocos-Creator/Cocos Creator生成项目的启动工作流程.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Cocos-Creator/Cocos Creator生成项目的启动工作流程.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近才有机会来看一下这个东西，虽然非常的喜欢Lua，但是现有的项目还是懒得去转换成Lua了，毕竟 Cocos Creator 还是很好用的至少简单，所以来理一理其工作流程。</p>
<a id="more"></a>
<h1 id="js-绑定"><a href="#js-绑定" class="headerlink" title="js 绑定"></a>js 绑定</h1><p>Cocos Creator 使用的是 Cocos2d-X 引擎的 js 绑定，开发语言也是 js 了。这里顺带提一下，关于用 Lua 还是 js 绑定的问题。主要的方式如下：<strong>引擎开启一个 脚本运行（ Lua 是 Lua State，JavaScript 用的是 V8 等等），然后把 C++ 写的代码，注入到这个引擎内。这样，引擎内就可以以调用注入函数的形式，调用底层代码。</strong></p>
<p>而对于我们的用户而言，所看到的据，我们所编写的 Js/Lua 脚本，居然能够产生就跟原生代码一样的效果。</p>
<h1 id="安卓的启动"><a href="#安卓的启动" class="headerlink" title="安卓的启动"></a>安卓的启动</h1><p>我们用 Cocos Creator 打包好的安卓项目内，与通常的安卓项目没有什么太大的差异，不过是利用了一些 Jni 技术来加载底层代码。但我们现在只关注启动的流程。</p>
<p>启动的 Activity 是一个叫做 AppActivity 的东西，在其 <code>onCreate()</code> 函数内进行了 SDK 的初始化：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// Workaround in https://stackoverflow.com/questions/16283079/re-launch-of-activity-on-home-button-but-only-the-first-time/16447508</span></span><br><span class="line">    <span class="keyword">if</span> (!isTaskRoot()) &#123;</span><br><span class="line">        <span class="comment">// Android launched another instance of the root activity into an existing task</span></span><br><span class="line">        <span class="comment">//  so just quietly finish and go away, dropping the user back into the activity</span></span><br><span class="line">        <span class="comment">//  at the top of the stack (ie: the last state of this task)</span></span><br><span class="line">        <span class="comment">// Don't need to finish it again since it's finished in super.onCreate .</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// DO OTHER INITIALIZATION BELOW</span></span><br><span class="line">    </span><br><span class="line">    SDKWrapper.getInstance().init(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SDKWrapper 也是由项目自动生成的类，我们可以看一下其内调用到的函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (PACKAGE_AS) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			mClass.getMethod(<span class="string">"init"</span>, Context<span class="class">.<span class="keyword">class</span>).<span class="title">invoke</span>(<span class="title">mClass</span>, <span class="title">context</span>)</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		SDKWrapper.nativeLoadAllPlugins();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeLoadAllPlugins</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>对于 Jni 技术不是很了解，但是我只想看一下其主要过程就行了。最终都会执行到引擎的 C++ 类： <code>AppDelegate.cpp</code>。</p>
<p>在其中的一个方法内就能看到，加载初始化的代码：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> AppDelegate::applicationDidFinishLaunching()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CC_TARGET_PLATFORM == CC_PLATFORM_IOS &amp;&amp; PACKAGE_AS</span></span><br><span class="line">    SDKManager::getInstance()-&gt;loadAllPlugins();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// initialize director</span></span><br><span class="line">    <span class="keyword">auto</span> director = Director::getInstance();</span><br><span class="line">    <span class="keyword">auto</span> glview = director-&gt;getOpenGLView();</span><br><span class="line">    <span class="keyword">if</span>(!glview) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span>(CC_TARGET_PLATFORM == CC_PLATFORM_WP8) || (CC_TARGET_PLATFORM == CC_PLATFORM_WINRT)</span></span><br><span class="line">        glview = GLViewImpl::create(<span class="string">"SCMJ"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        glview = GLViewImpl::createWithRect(<span class="string">"SCMJ"</span>, cocos2d::Rect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">900</span>,<span class="number">640</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        director-&gt;setOpenGLView(glview);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set FPS. the default value is 1.0/60 if you don't call this</span></span><br><span class="line">    director-&gt;setAnimationInterval(<span class="number">1.0</span> / <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">    ScriptingCore* sc = ScriptingCore::getInstance();</span><br><span class="line">    ScriptEngineManager::getInstance()-&gt;setScriptEngine(sc);</span><br><span class="line"></span><br><span class="line">    se::ScriptEngine* se = se::ScriptEngine::getInstance();</span><br><span class="line"></span><br><span class="line">    jsb_set_xxtea_key(<span class="string">"0d948dcc-c014-46"</span>);</span><br><span class="line">    jsb_init_file_operation_delegate();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(COCOS2D_DEBUG) &amp;&amp; (COCOS2D_DEBUG &gt; 0)</span></span><br><span class="line">    <span class="comment">// Enable debugger here</span></span><br><span class="line">    jsb_enable_debugger(<span class="string">"0.0.0.0"</span>, <span class="number">5086</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    se-&gt;setExceptionCallback([](<span class="keyword">const</span> <span class="keyword">char</span>* location, <span class="keyword">const</span> <span class="keyword">char</span>* message, <span class="keyword">const</span> <span class="keyword">char</span>* <span class="built_in">stack</span>)&#123;</span><br><span class="line">        <span class="comment">// Send exception information to server like Tencent Bugly.</span></span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    jsb_register_all_modules();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID || CC_TARGET_PLATFORM == CC_PLATFORM_IOS) &amp;&amp; PACKAGE_AS</span></span><br><span class="line">    se-&gt;addRegisterCallback(register_all_anysdk_framework);</span><br><span class="line">    se-&gt;addRegisterCallback(register_all_anysdk_manual);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    se-&gt;start();</span><br><span class="line"></span><br><span class="line">    jsb_run_script(<span class="string">"main.js"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的解释据：</p>
<ol>
<li>初始化 openGL 视图。</li>
<li>初始化脚本核心引擎。</li>
<li>注入所有模块。</li>
<li>启动脚本引擎</li>
<li>执行脚本 <em>main.js</em>。</li>
</ol>
<p>这样就将控制权转交给了脚本引擎中的 <em>main.js</em>。</p>
<h1 id="main-js"><a href="#main-js" class="headerlink" title="main.js"></a>main.js</h1><p>每个项目都会生成一个 <em>main.js</em> 文件。我是也 link 方式生成的项目，所以位于 build/jsb-link/main.js 。这个脚本，才会进行加载我们用 Cocos Creator 建立的项目内容。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.jsb) &#123;</span><br><span class="line">     <span class="built_in">require</span>(<span class="string">'src/settings.js'</span>);</span><br><span class="line">     <span class="built_in">require</span>(<span class="string">'src/jsb_polyfill.js'</span>);</span><br><span class="line">     boot();</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码，会在加载了我们的设置内容，统一接口文件后，开始进行启动操作。</p>
<p>这 boot() 函数，我们可以看到，进入初始场景（ settings 设置），加载项目相关的 js 然后启动游戏的代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">            <span class="comment">// load scene</span></span><br><span class="line">            cc.director.loadScene(launchScene, <span class="literal">null</span>,</span><br><span class="line">                <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (cc.sys.isBrowser) &#123;</span><br><span class="line">                        <span class="comment">// show canvas</span></span><br><span class="line">                        canvas.style.visibility = <span class="string">''</span>;</span><br><span class="line">                        <span class="keyword">var</span> div = <span class="built_in">document</span>.getElementById(<span class="string">'GameDiv'</span>);</span><br><span class="line">                        <span class="keyword">if</span> (div) &#123;</span><br><span class="line">                            div.style.backgroundImage = <span class="string">''</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    cc.loader.onProgress = <span class="literal">null</span>;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'Success to load scene: '</span> + launchScene);</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jsList</span></span><br><span class="line">        <span class="keyword">var</span> jsList = settings.jsList;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> bundledScript = settings.debug ? <span class="string">'src/project.dev.js'</span> : <span class="string">'src/project.js'</span>;</span><br><span class="line">            <span class="keyword">if</span> (jsList) &#123;</span><br><span class="line">                jsList = jsList.map(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">'src/'</span> + x;</span><br><span class="line">                &#125;);</span><br><span class="line">                jsList.push(bundledScript);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                jsList = [bundledScript];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// anysdk scripts</span></span><br><span class="line">        <span class="keyword">if</span> (cc.sys.isNative &amp;&amp; cc.sys.isMobile) &#123;</span><br><span class="line"><span class="comment">//            jsList = jsList.concat(['src/anysdk/jsb_anysdk.js', 'src/anysdk/jsb_anysdk_constants.js']);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> option = &#123;</span><br><span class="line">            <span class="comment">//width: width,</span></span><br><span class="line">            <span class="comment">//height: height,</span></span><br><span class="line">            id: <span class="string">'GameCanvas'</span>,</span><br><span class="line">            scenes: settings.scenes,</span><br><span class="line">            debugMode: settings.debug ? cc.DebugMode.INFO : cc.DebugMode.ERROR,</span><br><span class="line">            showFPS: (!<span class="literal">false</span> &amp;&amp; !<span class="literal">false</span>) &amp;&amp; settings.debug,</span><br><span class="line">            frameRate: <span class="number">60</span>,</span><br><span class="line">            jsList: jsList,</span><br><span class="line">            groupList: settings.groupList,</span><br><span class="line">            collisionMatrix: settings.collisionMatrix,</span><br><span class="line">            renderMode: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cc.game.run(option, onStart);</span><br></pre></td></tr></table></figure>
<p>当加载完我们项目相关的 js 后，就会把这些参数，传递给给 引擎的 game 对象 run 方法。启动游戏了</p>
<h1 id="jsb-register-all-modules-将相关的底层接口注册到js引擎"><a href="#jsb-register-all-modules-将相关的底层接口注册到js引擎" class="headerlink" title="jsb_register_all_modules 将相关的底层接口注册到js引擎"></a>jsb_register_all_modules 将相关的底层接口注册到js引擎</h1><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">jsb_register_all_modules</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    se::ScriptEngine* se = se::ScriptEngine::getInstance();</span><br><span class="line"></span><br><span class="line">    se-&gt;addBeforeInitHook([]()&#123;</span><br><span class="line">        JSBClassType::init();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    se-&gt;addBeforeCleanupHook([se]()&#123;</span><br><span class="line">        se-&gt;garbageCollect();</span><br><span class="line">        PoolManager::getInstance()-&gt;getCurrentPool()-&gt;<span class="built_in">clear</span>();</span><br><span class="line">        se-&gt;garbageCollect();</span><br><span class="line">        PoolManager::getInstance()-&gt;getCurrentPool()-&gt;<span class="built_in">clear</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    se-&gt;addRegisterCallback(jsb_register_global_variables);</span><br><span class="line"></span><br><span class="line">    se-&gt;addRegisterCallback(run_prepare_script);</span><br><span class="line"></span><br><span class="line">    se-&gt;addRegisterCallback(register_all_cocos2dx);</span><br><span class="line">    se-&gt;addRegisterCallback(jsb_register_Node_manual);</span><br><span class="line">    se-&gt;addRegisterCallback(register_all_cocos2dx_manual);</span><br><span class="line">    se-&gt;addRegisterCallback(JSB_register_opengl);</span><br><span class="line"></span><br><span class="line">...&#125;</span><br></pre></td></tr></table></figure>
<p>在这个函数中，首先获取一个 ScriptEngine(se) 的实例，然后就会进行一系列的加载操作。暂时我们不用关心一些与我们可能会使用到的东西无关的内容。我们关注一下，对于导出的 js 接口是怎么样导入的。</p>
<h2 id="se-gt-addRegisterCallback-run-prepare-script"><a href="#se-gt-addRegisterCallback-run-prepare-script" class="headerlink" title="se-&gt;addRegisterCallback(run_prepare_script);"></a>se-&gt;addRegisterCallback(run_prepare_script);</h2><p>在引擎启动前，会预先的准备一个 jsb 环境，这个环境的建立，是使用 js 脚本编写的，存在于 <em>jsb_prepare.js</em> 中。</p>
<p>在脚本  <em>jsb_prepare.js</em> 中，定义了命名空间 <strong>cc, jsb</strong> 定义了 cc 中的一些方法，如 <code>cc.clone()</code>；定义了 <em>cc.Class</em> ，一个用来构造类的基类及其相关方法。以及更多内容。更详细的内容可以查看源码。</p>
<h2 id="se-gt-addRegisterCallback-register-all-cocos2dx"><a href="#se-gt-addRegisterCallback-register-all-cocos2dx" class="headerlink" title="se-&gt;addRegisterCallback(register_all_cocos2dx);"></a>se-&gt;addRegisterCallback(register_all_cocos2dx);</h2><p>注册很多很多函数了。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">register_all_cocos2dx</span><span class="params">(se::Object* obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Get the ns</span></span><br><span class="line">    se::Value nsVal;</span><br><span class="line">    <span class="keyword">if</span> (!obj-&gt;getProperty(<span class="string">"cc"</span>, &amp;nsVal))</span><br><span class="line">    &#123;</span><br><span class="line">        se::<span class="function">HandleObject <span class="title">jsobj</span><span class="params">(se::Object::createPlainObject())</span></span>;</span><br><span class="line">        nsVal.setObject(jsobj);</span><br><span class="line">        obj-&gt;setProperty(<span class="string">"cc"</span>, nsVal);</span><br><span class="line">    &#125;</span><br><span class="line">    se::Object* ns = nsVal.toObject();</span><br><span class="line"></span><br><span class="line">    js_register_cocos2dx_Acceleration(ns);</span><br><span class="line">    js_register_cocos2dx_Action(ns);</span><br><span class="line">    js_register_cocos2dx_FiniteTimeAction(ns);</span><br><span class="line">    js_register_cocos2dx_ActionInstant(ns);</span><br><span class="line">    js_register_cocos2dx_Hide(ns);</span><br><span class="line">    js_register_cocos2dx_TMXObjectGroupInfo(ns);</span><br><span class="line">    js_register_cocos2dx_Node(ns);</span><br><span class="line">    js_register_cocos2dx_ParticleSystem(ns);</span><br><span class="line">    js_register_cocos2dx_ParticleSystemQuad(ns);</span><br><span class="line">    js_register_cocos2dx_ParticleSpiral(ns);</span><br><span class="line">    js_register_cocos2dx_ActionInterval(ns);</span><br><span class="line">    js_register_cocos2dx_MoveBy(ns);</span><br><span class="line">    js_register_cocos2dx_MoveTo(ns);</span><br><span class="line">    ....</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这首先会把从 se 对象获取 <em>cc</em> 属性，如果获取的 <em>cc</em> 属性为空，就会新建一个。 同时，很直白的把这个属性的值，称呼为 ns ，也就是命名空间的意思。</p>
<p>接着，就会一个个的注入各个模块了。我们来看一下 Director 模块。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">js_register_cocos2dx_Director</span><span class="params">(se::Object* obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> cls = se::Class::create(<span class="string">"Director"</span>, obj, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    cls-&gt;defineFunction(<span class="string">"pause"</span>, _SE(js_cocos2dx_Director_pause));</span><br><span class="line">    cls-&gt;defineFunction(<span class="string">"isPurgeDirectorInNextLoop"</span>, _SE(js_cocos2dx_Director_isPurgeDirectorInNextLoop));</span><br><span class="line">    cls-&gt;defineFunction(<span class="string">"setEventDispatcher"</span>, _SE(js_cocos2dx_Director_setEventDispatcher));</span><br><span class="line">    cls-&gt;defineFunction(<span class="string">"setContentScaleFactor"</span>, _SE(js_cocos2dx_Director_setContentScaleFactor));</span><br><span class="line">    cls-&gt;defineFunction(<span class="string">"getDeltaTime"</span>, _SE(js_cocos2dx_Director_getDeltaTime));</span><br><span class="line">    cls-&gt;defineFunction(<span class="string">"getContentScaleFactor"</span>, _SE(js_cocos2dx_Director_getContentScaleFactor));</span><br><span class="line">    cls-&gt;defineFunction(<span class="string">"getWinSizeInPixels"</span>, _SE(js_cocos2dx_Director_getWinSizeInPixels));</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先会 cc 的对象建立一个类，然后对类定义各个函数映射。就是这么简单的过程。</p>
<h2 id="se-gt-addRegisterCallback-run-boot-script"><a href="#se-gt-addRegisterCallback-run-boot-script" class="headerlink" title="se-&gt;addRegisterCallback(run_boot_script);"></a>se-&gt;addRegisterCallback(run_boot_script);</h2><p>注入完成后，就会运行我们的启动脚本 <em>jsb_boot.js</em>。 这个函数会定义  <em>cc.sys</em> 空间，加载 <em>jsb.js</em> 脚本。已经定义一些单例的类。详细的内容还是需要自己看脚本哈。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_initSys();</span><br><span class="line"></span><br><span class="line"><span class="comment">//+++++++++++++++++++++++++something about CCGame end+++++++++++++++++++++++++++++</span></span><br><span class="line"></span><br><span class="line">jsb.urlRegExp = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"^(?:https?|ftp)://\\S*$"</span>, <span class="string">"i"</span>);</span><br><span class="line"></span><br><span class="line">cc._engineLoaded = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">"script/jsb.js"</span>);</span><br><span class="line">    cc._engineLoaded = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(cc.ENGINE_VERSION);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<h2 id="jsb-js"><a href="#jsb-js" class="headerlink" title="jsb.js"></a>jsb.js</h2><p>这个脚本才是把我们各种常用的函数给加载起来的。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JavaScript Bindings helper file</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DO NOT ALTER THE ORDER</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'script/jsb_cocos2d.js'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'script/jsb_common.js'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'script/jsb_property_impls.js'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'script/jsb_property_apis.js'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'script/jsb_create_apis.js'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'script/extension/jsb_cocos2d_extension.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.ccui) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'script/ccui/jsb_cocos2d_ui.js'</span>);</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'script/ccui/jsb_ccui_property_impls.js'</span>);</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'script/ccui/jsb_ccui_property_apis.js'</span>);</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'script/ccui/jsb_ccui_create_apis.js'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'script/jsb_opengl_constants.js'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'script/jsb_opengl.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.sp) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'script/jsb_spine.js'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.dragonBones) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'script/jsb_dragonbones.js'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">"script/jsb_audioengine.js"</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"script/jsb_cocosanalytics.js"</span>);</span><br></pre></td></tr></table></figure>
<p>在此之后，才正式进入我们的项目的 <em>main.js</em> 启动环节。</p>
<h1 id="Cocos-Creator-专有内容"><a href="#Cocos-Creator-专有内容" class="headerlink" title="Cocos Creator 专有内容"></a>Cocos Creator 专有内容</h1><p>我一直很纳闷，在 <em>main.js</em> 内用 <code>cc.game.run()</code> 启动游戏，到底是在哪里实现的这个方法，一直没有找到。后面谷歌良久，才发现，这是在 Cocos Creator 实现的。</p>
<p>在 <a href="https://github.com/cocos-creator/engine/tree/44d068bea8120146521ec334827cb5b67a7d9b8f/cocos2d/core" target="_blank" rel="noopener">Cocos Creator Code</a> 目录下，有几个提供给 Cocos Creator 使用的 js 模块。</p>
<p>我们以 <a href="https://github.com/cocos-creator/engine/blob/44d068bea8120146521ec334827cb5b67a7d9b8f/cocos2d/core/CCGame.js" target="_blank" rel="noopener">cc.game</a> 为例来看一下。</p>
<p>最后一句 <code>cc.game = module.exports = game;</code> 表明了，将这个模块导出到了 cc.game 。</p>
<h1 id="cc-game-run"><a href="#cc-game-run" class="headerlink" title="cc.game.run()"></a>cc.game.run()</h1><p>对于我们启动游戏的逻辑 <code>cc.game.run()</code>，其代码定义如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">run: <span class="function"><span class="keyword">function</span> (<span class="params">config, onStart</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._initConfig(config);</span><br><span class="line">    <span class="keyword">this</span>.onStart = onStart;</span><br><span class="line">    <span class="keyword">this</span>.prepare(game.onStart &amp;&amp; game.onStart.bind(game));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中  onStart() 是我们自己定义的（也是系统生成的，但我们可以进行修改）。我们把配置信息传递过来后 game 就会保留这些信息。然后运行 prepare() 方法。</p>
<h1 id="prepare-cb"><a href="#prepare-cb" class="headerlink" title="prepare(cb)"></a>prepare(cb)</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">prepare (cb) &#123;</span><br><span class="line">       <span class="comment">// Already prepared</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>._prepared) &#123;</span><br><span class="line">           <span class="keyword">if</span> (cb) cb();</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Load game scripts</span></span><br><span class="line">       <span class="keyword">let</span> jsList = <span class="keyword">this</span>.config.jsList;</span><br><span class="line">       <span class="keyword">if</span> (jsList &amp;&amp; jsList.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">           cc.loader.load(jsList, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (err) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="built_in">JSON</span>.stringify(err));</span><br><span class="line">               self._prepareFinished(cb);</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>._prepareFinished(cb);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个很简单了，其实就是把我们配置好的 jsList 全部通过 loader 加载进来。然后就完成了。</p>
<p>之后，执行 准备结束函数 </p>
<h2 id="prepareFinished-cb"><a href="#prepareFinished-cb" class="headerlink" title="_prepareFinished(cb)"></a>_prepareFinished(cb)</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_prepareFinished (cb) &#123;</span><br><span class="line">    <span class="keyword">this</span>._prepared = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Init engine</span></span><br><span class="line">    <span class="keyword">this</span>._initEngine();</span><br><span class="line">    <span class="comment">// Log engine version</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Cocos Creator v'</span> + cc.ENGINE_VERSION);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>._setAnimFrame();</span><br><span class="line">    <span class="keyword">this</span>._runMainLoop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.emit(<span class="keyword">this</span>.EVENT_GAME_INITED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cb) cb();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="initEngine"><a href="#initEngine" class="headerlink" title="_initEngine()"></a>_initEngine()</h3><p>_initEngine() 只是开启渲染这么一个作用：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_initEngine () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._rendererInitialized) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>._initRenderer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!CC_EDITOR) &#123;</span><br><span class="line">        <span class="keyword">this</span>._initEvents();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.emit(<span class="keyword">this</span>.EVENT_ENGINE_INITED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="initRenderer"><a href="#initRenderer" class="headerlink" title="_initRenderer"></a>_initRenderer</h4><p>这个方法干的事情可就多了。具体我也不是很会解释了。对图形不是很懂。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_initRenderer () &#123;</span><br><span class="line">       <span class="comment">// Avoid setup to be called twice.</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>._rendererInitialized) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> el = <span class="keyword">this</span>.config.id,</span><br><span class="line">           width, height,</span><br><span class="line">           localCanvas, localContainer,</span><br><span class="line">           isWeChatGame = cc.sys.platform === cc.sys.WECHAT_GAME,</span><br><span class="line">           isQQPlay = cc.sys.platform === cc.sys.QQ_PLAY;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (isWeChatGame || CC_JSB) &#123;</span><br><span class="line">           <span class="keyword">this</span>.container = localContainer = <span class="built_in">document</span>.createElement(<span class="string">"DIV"</span>);</span><br><span class="line">           <span class="keyword">this</span>.frame = localContainer.parentNode === <span class="built_in">document</span>.body ? <span class="built_in">document</span>.documentElement : localContainer.parentNode;</span><br><span class="line">           <span class="keyword">if</span> (cc.sys.browserType === cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB) &#123;</span><br><span class="line">               localCanvas = wx.getSharedCanvas();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (CC_JSB) &#123;</span><br><span class="line">               localCanvas = <span class="built_in">window</span>.__cccanvas;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               localCanvas = canvas;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.canvas = localCanvas;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (isQQPlay) &#123;</span><br><span class="line">           <span class="keyword">this</span>.container = cc.container = <span class="built_in">document</span>.createElement(<span class="string">"DIV"</span>);</span><br><span class="line">           <span class="keyword">this</span>.frame = <span class="built_in">document</span>.documentElement;</span><br><span class="line">           <span class="keyword">this</span>.canvas = localCanvas = canvas;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">var</span> element = (el <span class="keyword">instanceof</span> HTMLElement) ? el : (<span class="built_in">document</span>.querySelector(el) || <span class="built_in">document</span>.querySelector(<span class="string">'#'</span> + el));</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (element.tagName === <span class="string">"CANVAS"</span>) &#123;</span><br><span class="line">               width = element.width;</span><br><span class="line">               height = element.height;</span><br><span class="line"></span><br><span class="line">               <span class="comment">//it is already a canvas, we wrap it around with a div</span></span><br><span class="line">               <span class="keyword">this</span>.canvas = localCanvas = element;</span><br><span class="line">               <span class="keyword">this</span>.container = localContainer = <span class="built_in">document</span>.createElement(<span class="string">"DIV"</span>);</span><br><span class="line">               <span class="keyword">if</span> (localCanvas.parentNode)</span><br><span class="line">                   localCanvas.parentNode.insertBefore(localContainer, localCanvas);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//we must make a new canvas and place into this element</span></span><br><span class="line">               <span class="keyword">if</span> (element.tagName !== <span class="string">"DIV"</span>) &#123;</span><br><span class="line">                   cc.warnID(<span class="number">3819</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               width = element.clientWidth;</span><br><span class="line">               height = element.clientHeight;</span><br><span class="line">               <span class="keyword">this</span>.canvas = localCanvas = <span class="built_in">document</span>.createElement(<span class="string">"CANVAS"</span>);</span><br><span class="line">               <span class="keyword">this</span>.container = localContainer = <span class="built_in">document</span>.createElement(<span class="string">"DIV"</span>);</span><br><span class="line">               element.appendChild(localContainer);</span><br><span class="line">           &#125;</span><br><span class="line">           localContainer.setAttribute(<span class="string">'id'</span>, <span class="string">'Cocos2dGameContainer'</span>);</span><br><span class="line">           localContainer.appendChild(localCanvas);</span><br><span class="line">           <span class="keyword">this</span>.frame = (localContainer.parentNode === <span class="built_in">document</span>.body) ? <span class="built_in">document</span>.documentElement : localContainer.parentNode;</span><br><span class="line"></span><br><span class="line">           <span class="function"><span class="keyword">function</span> <span class="title">addClass</span> (<span class="params">element, name</span>) </span>&#123;</span><br><span class="line">               <span class="keyword">var</span> hasClass = (<span class="string">' '</span> + element.className + <span class="string">' '</span>).indexOf(<span class="string">' '</span> + name + <span class="string">' '</span>) &gt; <span class="number">-1</span>;</span><br><span class="line">               <span class="keyword">if</span> (!hasClass) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (element.className) &#123;</span><br><span class="line">                       element.className += <span class="string">" "</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   element.className += name;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           addClass(localCanvas, <span class="string">"gameCanvas"</span>);</span><br><span class="line">           localCanvas.setAttribute(<span class="string">"width"</span>, width || <span class="number">480</span>);</span><br><span class="line">           localCanvas.setAttribute(<span class="string">"height"</span>, height || <span class="number">320</span>);</span><br><span class="line">           localCanvas.setAttribute(<span class="string">"tabindex"</span>, <span class="number">99</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>._determineRenderType();</span><br><span class="line">       <span class="comment">// WebGL context created successfully</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.renderType === <span class="keyword">this</span>.RENDER_TYPE_WEBGL) &#123;</span><br><span class="line">           <span class="keyword">var</span> opts = &#123;</span><br><span class="line">               <span class="string">'stencil'</span>: <span class="literal">true</span>,</span><br><span class="line">               <span class="comment">// MSAA is causing serious performance dropdown on some browsers.</span></span><br><span class="line">               <span class="string">'antialias'</span>: cc.macro.ENABLE_WEBGL_ANTIALIAS,</span><br><span class="line">               <span class="string">'alpha'</span>: cc.macro.ENABLE_TRANSPARENT_CANVAS</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">if</span> (isWeChatGame) &#123;</span><br><span class="line">               opts[<span class="string">'preserveDrawingBuffer'</span>] = <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           renderer.initWebGL(localCanvas, opts);</span><br><span class="line">           <span class="keyword">this</span>._renderContext = renderer.device._gl;</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// Enable dynamic atlas manager by default</span></span><br><span class="line">           <span class="keyword">if</span> (!cc.macro.CLEANUP_IMAGE_CACHE) &#123;</span><br><span class="line">               cc.dynamicAtlasManager.enabled = <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">this</span>._renderContext) &#123;</span><br><span class="line">           <span class="keyword">this</span>.renderType = <span class="keyword">this</span>.RENDER_TYPE_CANVAS;</span><br><span class="line">           <span class="comment">// Could be ignored by module settings</span></span><br><span class="line">           renderer.initCanvas(localCanvas);</span><br><span class="line">           <span class="keyword">this</span>._renderContext = renderer.device._ctx;</span><br><span class="line">       &#125;</span><br><span class="line">       cc.renderer = renderer;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.canvas.oncontextmenu = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (!cc._isContextMenuEnable) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>._rendererInitialized = <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="setAnimFrame"><a href="#setAnimFrame" class="headerlink" title="_setAnimFrame"></a>_setAnimFrame</h3><p>这玩意看起来是设置一下帧频率的？</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_setAnimFrame: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._lastTime = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">        <span class="keyword">var</span> frameRate = game.config.frameRate;</span><br><span class="line">        <span class="keyword">this</span>._frameTime = <span class="number">1000</span> / frameRate;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CC_JSB) &#123;</span><br><span class="line">            jsb.setPreferredFramesPerSecond(frameRate);</span><br><span class="line">            <span class="built_in">window</span>.requestAnimFrame = <span class="built_in">window</span>.requestAnimationFrame;</span><br><span class="line">            <span class="built_in">window</span>.cancelAnimFrame = <span class="built_in">window</span>.cancelAnimationFrame;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (frameRate !== <span class="number">60</span> &amp;&amp; frameRate !== <span class="number">30</span>) &#123;</span><br><span class="line">                <span class="built_in">window</span>.requestAnimFrame = <span class="keyword">this</span>._stTime;</span><br><span class="line">                <span class="built_in">window</span>.cancelAnimFrame = <span class="keyword">this</span>._ctTime;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">window</span>.requestAnimFrame = <span class="built_in">window</span>.requestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.webkitRequestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.mozRequestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.oRequestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.msRequestAnimationFrame ||</span><br><span class="line">                <span class="keyword">this</span>._stTime;</span><br><span class="line">                <span class="built_in">window</span>.cancelAnimFrame = <span class="built_in">window</span>.cancelAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.cancelRequestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.msCancelRequestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.mozCancelRequestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.oCancelRequestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.webkitCancelRequestAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.msCancelAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.mozCancelAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.webkitCancelAnimationFrame ||</span><br><span class="line">                <span class="built_in">window</span>.oCancelAnimationFrame ||</span><br><span class="line">                <span class="keyword">this</span>._ctTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    _stTime: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> currTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">        <span class="keyword">var</span> timeToCall = <span class="built_in">Math</span>.max(<span class="number">0</span>, game._frameTime - (currTime - game._lastTime));</span><br><span class="line">        <span class="keyword">var</span> id = <span class="built_in">window</span>.setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; callback(); &#125;,</span><br><span class="line">            timeToCall);</span><br><span class="line">        game._lastTime = currTime + timeToCall;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;,</span><br><span class="line">    _ctTime: <span class="function"><span class="keyword">function</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">window</span>.clearTimeout(id);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<h3 id="runMainLoop"><a href="#runMainLoop" class="headerlink" title="_runMainLoop"></a>_runMainLoop</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_runMainLoop: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>, callback, config = self.config,</span><br><span class="line">        director = cc.director,</span><br><span class="line">        skip = <span class="literal">true</span>, frameRate = config.frameRate;</span><br><span class="line"></span><br><span class="line">    debug.setDisplayStats(config.showFPS);</span><br><span class="line"></span><br><span class="line">    callback = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!self._paused) &#123;</span><br><span class="line">            self._intervalId = <span class="built_in">window</span>.requestAnimFrame(callback);</span><br><span class="line">            <span class="keyword">if</span> (frameRate === <span class="number">30</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (skip = !skip) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            director.mainLoop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    self._intervalId = <span class="built_in">window</span>.requestAnimFrame(callback);</span><br><span class="line">    self._paused = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>等这些执行完毕后，才会执行什么开启的函数。</p>
<h1 id="main-js-1"><a href="#main-js-1" class="headerlink" title="main.js"></a>main.js</h1><p>我们生成项目的 <strong>main.js</strong> 会先加载配置文件，加载 <em>jsb_polyfill.js</em> 文件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.jsb) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'src/settings.js'</span>);</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'src/jsb_polyfill.js'</span>);</span><br><span class="line">    boot();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后启动 boot 函数：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">boot</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="comment">// 这个settings 在 settings.js 里面获取</span></span><br><span class="line">        <span class="keyword">var</span> settings = <span class="built_in">window</span>._CCSettings;</span><br><span class="line">        <span class="built_in">window</span>._CCSettings = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//  在非debug的时候执行</span></span><br><span class="line">        <span class="keyword">if</span> ( !settings.debug ) &#123;</span><br><span class="line">            <span class="keyword">var</span> uuids = settings.uuids;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> rawAssets = settings.rawAssets;</span><br><span class="line">            <span class="keyword">var</span> assetTypes = settings.assetTypes;</span><br><span class="line">            <span class="keyword">var</span> realRawAssets = settings.rawAssets = &#123;&#125;;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> mount <span class="keyword">in</span> rawAssets) &#123;</span><br><span class="line">                <span class="keyword">var</span> entries = rawAssets[mount];</span><br><span class="line">                <span class="keyword">var</span> realEntries = realRawAssets[mount] = &#123;&#125;;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> entries) &#123;</span><br><span class="line">                    <span class="keyword">var</span> entry = entries[id];</span><br><span class="line">                    <span class="keyword">var</span> type = entry[<span class="number">1</span>];</span><br><span class="line">                    <span class="comment">// retrieve minified raw asset</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'number'</span>) &#123;</span><br><span class="line">                        entry[<span class="number">1</span>] = assetTypes[type];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// retrieve uuid</span></span><br><span class="line">                    realEntries[uuids[id] || id] = entry;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> scenes = settings.scenes;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; scenes.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">var</span> scene = scenes[i];</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> scene.uuid === <span class="string">'number'</span>) &#123;</span><br><span class="line">                    scene.uuid = uuids[scene.uuid];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> packedAssets = settings.packedAssets;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> packId <span class="keyword">in</span> packedAssets) &#123;</span><br><span class="line">                <span class="keyword">var</span> packedIds = packedAssets[packId];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; packedIds.length; ++j) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> packedIds[j] === <span class="string">'number'</span>) &#123;</span><br><span class="line">                        packedIds[j] = uuids[packedIds[j]];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// init engine</span></span><br><span class="line">        <span class="keyword">var</span> canvas;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 在浏览器下，是利用了一个特定的画布</span></span><br><span class="line">        <span class="keyword">if</span> (cc.sys.isBrowser) &#123;</span><br><span class="line">            canvas = <span class="built_in">document</span>.getElementById(<span class="string">'GameCanvas'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> ORIENTATIONS = &#123;</span><br><span class="line">                <span class="string">'portrait'</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">'landscape left'</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="string">'landscape right'</span>: <span class="number">3</span></span><br><span class="line">            &#125;;</span><br><span class="line">            BK.Director.screenMode = ORIENTATIONS[settings.orientation];</span><br><span class="line">            initAdapter();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">setLoadingDisplay</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// Loading splash scene</span></span><br><span class="line">            <span class="keyword">var</span> splash = <span class="built_in">document</span>.getElementById(<span class="string">'splash'</span>);</span><br><span class="line">            <span class="keyword">var</span> progressBar = splash.querySelector(<span class="string">'.progress-bar span'</span>);</span><br><span class="line">            cc.loader.onProgress = <span class="function"><span class="keyword">function</span> (<span class="params">completedCount, totalCount, item</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> percent = <span class="number">100</span> * completedCount / totalCount;</span><br><span class="line">                <span class="keyword">if</span> (progressBar) &#123;</span><br><span class="line">                    progressBar.style.width = percent.toFixed(<span class="number">2</span>) + <span class="string">'%'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            splash.style.display = <span class="string">'block'</span>;</span><br><span class="line">            progressBar.style.width = <span class="string">'0%'</span>;</span><br><span class="line"></span><br><span class="line">            cc.director.once(cc.Director.EVENT_AFTER_SCENE_LAUNCH, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                splash.style.display = <span class="string">'none'</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> onStart = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">                BK.Script.loadlib();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cc.view.resizeWithBrowserSize(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="literal">false</span> &amp;&amp; !<span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="comment">// UC browser on many android devices have performance issue with retina display</span></span><br><span class="line">                <span class="keyword">if</span> (cc.sys.os !== cc.sys.OS_ANDROID || cc.sys.browserType !== cc.sys.BROWSER_TYPE_UC) &#123;</span><br><span class="line">                    cc.view.enableRetina(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cc.sys.isBrowser) &#123;</span><br><span class="line">                    setLoadingDisplay();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cc.sys.isMobile) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (settings.orientation === <span class="string">'landscape'</span>) &#123;</span><br><span class="line">                        cc.view.setOrientation(cc.macro.ORIENTATION_LANDSCAPE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (settings.orientation === <span class="string">'portrait'</span>) &#123;</span><br><span class="line">                        cc.view.setOrientation(cc.macro.ORIENTATION_PORTRAIT);</span><br><span class="line">                    &#125;</span><br><span class="line">                    cc.view.enableAutoFullScreen([</span><br><span class="line">                        cc.sys.BROWSER_TYPE_BAIDU,</span><br><span class="line">                        cc.sys.BROWSER_TYPE_WECHAT,</span><br><span class="line">                        cc.sys.BROWSER_TYPE_MOBILE_QQ,</span><br><span class="line">                        cc.sys.BROWSER_TYPE_MIUI,</span><br><span class="line">                    ].indexOf(cc.sys.browserType) &lt; <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Limit downloading max concurrent task to 2,</span></span><br><span class="line">                <span class="comment">// more tasks simultaneously may cause performance draw back on some android system / brwosers.</span></span><br><span class="line">                <span class="comment">// You can adjust the number based on your own test result, you have to set it before any loading process to take effect.</span></span><br><span class="line">                <span class="keyword">if</span> (cc.sys.isBrowser &amp;&amp; cc.sys.os === cc.sys.OS_ANDROID) &#123;</span><br><span class="line">                    cc.macro.DOWNLOAD_MAX_CONCURRENT = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// init assets</span></span><br><span class="line">            cc.AssetLibrary.init(&#123;</span><br><span class="line">                libraryPath: <span class="string">'res/import'</span>,</span><br><span class="line">                rawAssetsBase: <span class="string">'res/raw-'</span>,</span><br><span class="line">                rawAssets: settings.rawAssets,</span><br><span class="line">                packedAssets: settings.packedAssets,</span><br><span class="line">                md5AssetsMap: settings.md5AssetsMap</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">                cc.Pipeline.Downloader.PackDownloader._doPreload(<span class="string">"WECHAT_SUBDOMAIN"</span>, settings.WECHAT_SUBDOMAIN_DATA);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> launchScene = settings.launchScene;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// load scene</span></span><br><span class="line">            cc.director.loadScene(launchScene, <span class="literal">null</span>,</span><br><span class="line">                <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (cc.sys.isBrowser) &#123;</span><br><span class="line">                        <span class="comment">// show canvas</span></span><br><span class="line">                        canvas.style.visibility = <span class="string">''</span>;</span><br><span class="line">                        <span class="keyword">var</span> div = <span class="built_in">document</span>.getElementById(<span class="string">'GameDiv'</span>);</span><br><span class="line">                        <span class="keyword">if</span> (div) &#123;</span><br><span class="line">                            div.style.backgroundImage = <span class="string">''</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    cc.loader.onProgress = <span class="literal">null</span>;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'Success to load scene: '</span> + launchScene);</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jsList</span></span><br><span class="line">        <span class="keyword">var</span> jsList = settings.jsList;</span><br><span class="line">			<span class="comment">// 这个就用来加载工程内的 js 了</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> bundledScript = settings.debug ? <span class="string">'src/project.dev.js'</span> : <span class="string">'src/project.js'</span>;</span><br><span class="line">            <span class="keyword">if</span> (jsList) &#123;</span><br><span class="line">                jsList = jsList.map(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">'src/'</span> + x;</span><br><span class="line">                &#125;);</span><br><span class="line">                jsList.push(bundledScript);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                jsList = [bundledScript];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// anysdk scripts</span></span><br><span class="line">        <span class="keyword">if</span> (cc.sys.isNative &amp;&amp; cc.sys.isMobile) &#123;</span><br><span class="line"><span class="comment">//            jsList = jsList.concat(['src/anysdk/jsb_anysdk.js', 'src/anysdk/jsb_anysdk_constants.js']);</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// 游戏运行选项</span></span><br><span class="line">        <span class="keyword">var</span> option = &#123;</span><br><span class="line">            <span class="comment">//width: width,</span></span><br><span class="line">            <span class="comment">//height: height,</span></span><br><span class="line">            id: <span class="string">'GameCanvas'</span>,</span><br><span class="line">            scenes: settings.scenes,</span><br><span class="line">            debugMode: settings.debug ? cc.DebugMode.INFO : cc.DebugMode.ERROR,</span><br><span class="line">            showFPS: (!<span class="literal">false</span> &amp;&amp; !<span class="literal">false</span>) &amp;&amp; settings.debug,</span><br><span class="line">            frameRate: <span class="number">60</span>,</span><br><span class="line">            jsList: jsList,</span><br><span class="line">            groupList: settings.groupList,</span><br><span class="line">            collisionMatrix: settings.collisionMatrix,</span><br><span class="line">            renderMode: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cc.game.run(option, onStart);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Cocos-Creator/" rel="tag"># Cocos Creator</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/Cocos-Creator/Cocos-Creator浏览器正常，打包apk错误的问题.html" rel="next" title="Cocos-Creator浏览器正常，打包apk错误的问题">
                  <i class="fa fa-chevron-left"></i> Cocos-Creator浏览器正常，打包apk错误的问题
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/Python/TensorFlow的环境安装.html" rel="prev" title="TensorFlow的环境安装">
                  TensorFlow的环境安装 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#js-绑定"><span class="nav-number">1.</span> <span class="nav-text">js 绑定</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安卓的启动"><span class="nav-number">2.</span> <span class="nav-text">安卓的启动</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#main-js"><span class="nav-number">3.</span> <span class="nav-text">main.js</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jsb-register-all-modules-将相关的底层接口注册到js引擎"><span class="nav-number">4.</span> <span class="nav-text">jsb_register_all_modules 将相关的底层接口注册到js引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#se-gt-addRegisterCallback-run-prepare-script"><span class="nav-number">4.1.</span> <span class="nav-text">se-&gt;addRegisterCallback(run_prepare_script);</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#se-gt-addRegisterCallback-register-all-cocos2dx"><span class="nav-number">4.2.</span> <span class="nav-text">se-&gt;addRegisterCallback(register_all_cocos2dx);</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#se-gt-addRegisterCallback-run-boot-script"><span class="nav-number">4.3.</span> <span class="nav-text">se-&gt;addRegisterCallback(run_boot_script);</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jsb-js"><span class="nav-number">4.4.</span> <span class="nav-text">jsb.js</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Cocos-Creator-专有内容"><span class="nav-number">5.</span> <span class="nav-text">Cocos Creator 专有内容</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cc-game-run"><span class="nav-number">6.</span> <span class="nav-text">cc.game.run()</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#prepare-cb"><span class="nav-number">7.</span> <span class="nav-text">prepare(cb)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#prepareFinished-cb"><span class="nav-number">7.1.</span> <span class="nav-text">_prepareFinished(cb)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#initEngine"><span class="nav-number">7.1.1.</span> <span class="nav-text">_initEngine()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#initRenderer"><span class="nav-number">7.1.1.1.</span> <span class="nav-text">_initRenderer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setAnimFrame"><span class="nav-number">7.1.2.</span> <span class="nav-text">_setAnimFrame</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#runMainLoop"><span class="nav-number">7.1.3.</span> <span class="nav-text">_runMainLoop</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#main-js-1"><span class="nav-number">8.</span> <span class="nav-text">main.js</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Gowa2017 Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">318</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">133</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gowa2017" title="GitHub → https://github.com/gowa2017" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shouzheng.zhang@gmail.com" title="E-Mail → mailto:shouzheng.zhang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-json"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gowa2017 Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js"></script><script src="/js/algolia-search.js"></script>














  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://gowa-1.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://gowa.club/Cocos-Creator/Cocos Creator生成项目的启动工作流程.html",
            identifier: "Cocos-Creator/Cocos Creator生成项目的启动工作流程.html",
            title: "Cocos Creator生成项目的启动工作流程"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://gowa-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    window.addEventListener('load', loadComments, false);
</script>

</body>
</html>
