<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="退思园" type="application/atom+xml">
  <meta name="google-site-verification" content="EDvvZZUFkxy_QUzZTaqwsG_9VHqFthY-NhQE4j6WL-s">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: 'LHD9LWONQ3',
      apiKey: '23a113c49e36d8cc93f61239cb530b43',
      indexName: 'gowa.club',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="了解一下最经典的 MUD 架构实现。 fluffos/mudosdriver_main作为一个启动引导函数，用来初始化各种环境。 init_maindriver_main 最先调用的就是 init_main 了。 主要工作还是：  读取配置文件 read_config(argv[i]); 初始化 libevent auto base = init_backend(); 初始化虚拟机 vm_init">
<meta name="keywords" content="MUD">
<meta property="og:type" content="article">
<meta property="og:title" content="FluffOS的简单架构分析">
<meta property="og:url" content="https://gowa.club/MUD/FluffOS的简单架构分析.html">
<meta property="og:site_name" content="退思园">
<meta property="og:description" content="了解一下最经典的 MUD 架构实现。 fluffos/mudosdriver_main作为一个启动引导函数，用来初始化各种环境。 init_maindriver_main 最先调用的就是 init_main 了。 主要工作还是：  读取配置文件 read_config(argv[i]); 初始化 libevent auto base = init_backend(); 初始化虚拟机 vm_init">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-05-11T09:04:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="FluffOS的简单架构分析">
<meta name="twitter:description" content="了解一下最经典的 MUD 架构实现。 fluffos/mudosdriver_main作为一个启动引导函数，用来初始化各种环境。 init_maindriver_main 最先调用的就是 init_main 了。 主要工作还是：  读取配置文件 read_config(argv[i]); 初始化 libevent auto base = init_backend(); 初始化虚拟机 vm_init">

<link rel="canonical" href="https://gowa.club/MUD/FluffOS的简单架构分析.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>FluffOS的简单架构分析 | 退思园</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137245514-1"></script>
    <script>
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-137245514-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">退思园</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">烦恼一般都是想太多了。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-soft">

    <a href="/soft/" rel="section"><i class="fa fa-fw fa-rocket"></i>soft</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input" id="search-input"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gowa.club/MUD/FluffOS的简单架构分析.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Gowa2017 Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="退思园">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          FluffOS的简单架构分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-11 17:04:08" itemprop="dateCreated datePublished" datetime="2020-05-11T17:04:08+08:00">2020-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MUD/" itemprop="url" rel="index">
                    <span itemprop="name">MUD</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/MUD/FluffOS的简单架构分析.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="MUD/FluffOS的简单架构分析.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>了解一下最经典的 MUD 架构实现。</p>
<h1 id="fluffos-mudos"><a href="#fluffos-mudos" class="headerlink" title="fluffos/mudos"></a>fluffos/mudos</h1><h1 id="driver-main"><a href="#driver-main" class="headerlink" title="driver_main"></a>driver_main</h1><p>作为一个启动引导函数，用来初始化各种环境。</p>
<h1 id="init-main"><a href="#init-main" class="headerlink" title="init_main"></a>init_main</h1><p><code>driver_main</code> 最先调用的就是 <code>init_main</code> 了。</p>
<p>主要工作还是：</p>
<ol>
<li>读取配置文件 <code>read_config(argv[i]);</code></li>
<li>初始化 <em>libevent</em> <code>auto base = init_backend();</code></li>
<li>初始化虚拟机 <code>vm_init()</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">struct event_base *<span class="title">init_main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  init_locale();</span><br><span class="line">  init_tz();</span><br><span class="line"></span><br><span class="line">  print_sep();</span><br><span class="line">  print_commandline(argc, argv);</span><br><span class="line">  print_version_and_time();</span><br><span class="line">  incrase_fd_rlimit();</span><br><span class="line">  print_rlimit();</span><br><span class="line">  print_sep();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* read in the configuration file */</span></span><br><span class="line">  <span class="keyword">bool</span> got_config = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (argv[i][<span class="number">0</span>] == <span class="string">'-'</span>) &#123;</span><br><span class="line">      <span class="comment">// skip --flag val .</span></span><br><span class="line">      <span class="keyword">if</span> (argv[i][<span class="number">1</span>] == <span class="string">'-'</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    read_config(argv[i]);</span><br><span class="line">    got_config = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!got_config) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: %s config_file\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug_message(<span class="string">"Initializing internal stuff ....\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize libevent, This should be done before executing LPC.</span></span><br><span class="line">  <span class="keyword">auto</span> base = init_backend();</span><br><span class="line">  init_dns_event_base(base);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize VM layer</span></span><br><span class="line">  vm_init();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="init-backend"><a href="#init-backend" class="headerlink" title="init_backend"></a>init_backend</h2><p>主要主要就是初始化 libevent 库，用来进行事件调度，当有事件触发事，执行对应的回调函数。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">event_base *<span class="title">init_backend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  event_set_log_callback(libevent_log);</span><br><span class="line">  evdns_set_log_fn(libevent_dns_log);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">  event_enable_debug_mode();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">  evthread_use_windows_threads();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  evthread_use_pthreads();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  g_event_base = event_base_new();</span><br><span class="line">  debug_message(<span class="string">"Event backend in use: %s\n"</span>, event_base_get_method(g_event_base));</span><br><span class="line">  <span class="keyword">return</span> g_event_base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="vm-init"><a href="#vm-init" class="headerlink" title="vm_init"></a>vm_init</h2><p>初始化一个虚拟机。这玩意用来干什么呢？我们看代码</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vm_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  boot_time = get_current_time();</span><br><span class="line"></span><br><span class="line">  init_eval(); <span class="comment">/* in eval.cc * 定时器/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  init_strings();     /* in stralloc.c 字符串 hash 表*/</span></span><br><span class="line">  init_identifiers(); <span class="comment">/* in lex.c 虚拟机有特殊意义的符号表，再加上 efun，相当于虚拟机自定义的内部函数*/</span></span><br><span class="line">  init_locals();      <span class="comment">/* in compiler.c 本地变量环境*/</span></span><br><span class="line"></span><br><span class="line">  max_eval_cost = CONFIG_INT(__MAX_EVAL_COST__);</span><br><span class="line">  set_inc_list(CONFIG_STR(__INCLUDE_DIRS__));</span><br><span class="line"></span><br><span class="line">  add_predefines();</span><br><span class="line">  reset_machine(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  set_eval(max_eval_cost);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="vm-start"><a href="#vm-start" class="headerlink" title="vm_start"></a>vm_start</h1><p>这个时候开始启动虚拟机了.</p>
<p>主要工作：</p>
<ol>
<li>初始化仿真函数 <code>init_simul_efun</code></li>
<li>初始化 master 对象 <code>init_master</code></li>
<li>预加载对象 <code>preload_objects</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vm_start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">error_context_t</span> econ;</span><br><span class="line">  save_context(&amp;econ);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    init_simul_efun(CONFIG_STR(__SIMUL_EFUN_FILE__));</span><br><span class="line">    init_master(CONFIG_STR(__MASTER_FILE__));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">const</span> <span class="keyword">char</span> *) &#123;</span><br><span class="line">    debug_message(<span class="string">"The simul_efun (%s) and master (%s) objects must be loadable.\n"</span>,</span><br><span class="line">                  CONFIG_STR(__SIMUL_EFUN_FILE__), CONFIG_STR(__MASTER_FILE__));</span><br><span class="line">    debug_message(<span class="string">"Please check log files for exact error. \n"</span>);</span><br><span class="line">    restore_context(&amp;econ);</span><br><span class="line">    pop_context(&amp;econ);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  pop_context(&amp;econ);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> move this to correct location.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PACKAGE_MUDLIB_STATS</span></span><br><span class="line">  restore_stat_files();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  preload_objects();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里可以窥见 LPC 是如何从一个文件，来构造对象的。</p>
<h2 id="init-simul-efun"><a href="#init-simul-efun" class="headerlink" title="init_simul_efun"></a>init_simul_efun</h2><p>首先，会检查文件是否存在，然后调用 <code>load_object(buff,1)</code> 函数。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_simul_efun</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">512</span>];</span><br><span class="line">  <span class="keyword">object_t</span> *new_ob;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!file || !file[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"No simul_efun\n"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!filename_to_obname(file, buf, <span class="keyword">sizeof</span> buf)) &#123;</span><br><span class="line">    error(<span class="string">"Illegal simul_efun file name '%s'\n"</span>, file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (file[<span class="built_in">strlen</span>(file) - <span class="number">2</span>] != <span class="string">'.'</span>) &#123;</span><br><span class="line">    <span class="built_in">strcat</span>(buf, <span class="string">".c"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  new_ob = load_object(buf, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (new_ob == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"The simul_efun file %s was not loaded.\n"</span>, buf);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  set_simul_efun(new_ob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="load-object"><a href="#load-object" class="headerlink" title="load_object"></a>load_object</h2><p><code>load_object</code> 应该是一个灵魂函数了。其加载文件，然后编译文件。此函数位于 <code>vm/internal/simulate.cc</code> 中。其主要工作就是从一个文件加载一个对象，如果此文件继承了其他并没有加载到内存中的对象，那么就会想加载这个未继承的对象，再重新加载此文件。</p>
<h2 id="init-master"><a href="#init-master" class="headerlink" title="init_master"></a>init_master</h2><p>先构造一个 master 对象</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_master</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *master_file)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">512</span>];</span><br><span class="line">  <span class="keyword">object_t</span> *new_ob;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!filename_to_obname(master_file, buf, <span class="keyword">sizeof</span> buf)) &#123;</span><br><span class="line">    error(<span class="string">"Illegal master file name '%s'\n"</span>, master_file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  new_ob = load_object(buf, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (new_ob == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"The master file %s was not loaded.\n"</span>, master_file);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  set_master(new_ob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后设置为全局对象，并将 master_obj 可 apply 的函数读取出来，只有可以用 <code>apply_master_ob(fun,numargs)</code> 来进行调用</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_master</span><span class="params">(<span class="keyword">object_t</span> *ob)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(PACKAGE_UIDS) || defined(PACKAGE_MUDLIB_STATS)</span></span><br><span class="line">  <span class="keyword">int</span> first_load = (!master_ob);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">svalue_t</span> *ret;</span><br><span class="line"></span><br><span class="line">  get_master_applies(ob);</span><br><span class="line">  master_ob = ob;  <span class="comment">// from here on apply_master_ob returns -1 only as return from the apply</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make sure master_ob is never made a dangling pointer. */</span></span><br><span class="line">  add_ref(master_ob, <span class="string">"set_master"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PACKAGE_UIDS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PACKAGE_MUDLIB_STATS</span></span><br><span class="line">  <span class="keyword">if</span> (first_load) &#123;</span><br><span class="line">    <span class="comment">// 'master::domain_file' should return an apropriate "domain" for each</span></span><br><span class="line">    <span class="comment">// file (directory), as such we should get the backbone domain by</span></span><br><span class="line">    <span class="comment">// asking for 'master::domain_file("/")'</span></span><br><span class="line">    push_constant_string(<span class="string">"/"</span>);</span><br><span class="line">    ret = apply_master_ob(APPLY_DOMAIN_FILE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span> || ret-&gt;type != T_STRING) &#123;</span><br><span class="line">      <span class="comment">// we didn't got the expected value?</span></span><br><span class="line">      <span class="comment">// emit warning and fall back to old behavior</span></span><br><span class="line">      debug_message(</span><br><span class="line">          <span class="string">"%s() in the master file does not work, using 'BACKBONE' as fallback (see %s.4)\n"</span>,</span><br><span class="line">          applies_table[APPLY_DOMAIN_FILE], applies_table[APPLY_DOMAIN_FILE]);</span><br><span class="line">      set_backbone_domain(<span class="string">"BACKBONE"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      set_backbone_domain(ret-&gt;u.<span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 'master::author_file' should return an apropriate "author" for each</span></span><br><span class="line">    <span class="comment">// file (directory), as such we should get the master author by</span></span><br><span class="line">    <span class="comment">// asking for 'master::author_file(__MASTER_FILE__)'</span></span><br><span class="line">    push_malloced_string(add_slash(CONFIG_STR(__MASTER_FILE__)));</span><br><span class="line">    ret = apply_master_ob(APPLY_AUTHOR_FILE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span> || ret-&gt;type != T_STRING) &#123;</span><br><span class="line">      <span class="comment">// we didn't got the expected value?</span></span><br><span class="line">      <span class="comment">// emit warning and fall back to old behavior</span></span><br><span class="line">      debug_message(</span><br><span class="line">          <span class="string">"%s() in the master file does not work, using 'NONAME' as fallback (see %s.4)\n"</span>,</span><br><span class="line">          applies_table[APPLY_AUTHOR_FILE], applies_table[APPLY_AUTHOR_FILE]);</span><br><span class="line">      set_master_author(<span class="string">"NONAME"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      set_master_author(ret-&gt;u.<span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  ret = apply_master_ob(APPLY_GET_ROOT_UID, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">    debug_message(</span><br><span class="line">        <span class="string">"No function %s() in master object; possibly the mudlib doesn't want "</span></span><br><span class="line">        <span class="string">"PACKAGE_UIDS to be defined.\n"</span>,</span><br><span class="line">        applies_table[APPLY_GET_ROOT_UID]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ret-&gt;type != T_STRING) &#123;</span><br><span class="line">    debug_message(<span class="string">"%s() in master object does not work.\n"</span>, applies_table[APPLY_GET_ROOT_UID]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (first_load) &#123;</span><br><span class="line">    master_ob-&gt;uid = set_root_uid(ret-&gt;u.<span class="built_in">string</span>);</span><br><span class="line">    master_ob-&gt;euid = master_ob-&gt;uid;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PACKAGE_MUDLIB_STATS</span></span><br><span class="line">    <span class="comment">// 'master::author_file' should return an apropriate "author" for each</span></span><br><span class="line">    <span class="comment">// file (directory), as such we should get the master author by</span></span><br><span class="line">    <span class="comment">// asking for 'master::author_file(__MASTER_FILE__)'</span></span><br><span class="line">    push_malloced_string(add_slash(CONFIG_STR(__MASTER_FILE__)));</span><br><span class="line">    ret = apply_master_ob(APPLY_AUTHOR_FILE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="literal">nullptr</span> || ret-&gt;type != T_STRING) &#123;</span><br><span class="line">      <span class="comment">// we didn't got the expected value?</span></span><br><span class="line">      <span class="comment">// emit warning and fall back to old behavior</span></span><br><span class="line">      debug_message(</span><br><span class="line">          <span class="string">"%s() in the master file does not work, using root_uid as fallback (see %s.4)\n"</span>,</span><br><span class="line">          applies_table[APPLY_AUTHOR_FILE], applies_table[APPLY_AUTHOR_FILE]);</span><br><span class="line">      set_master_author(master_ob-&gt;uid-&gt;name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      set_master_author(ret-&gt;u.<span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ret = apply_master_ob(APPLY_GET_BACKBONE_UID, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="literal">nullptr</span> || ret-&gt;type != T_STRING) &#123;</span><br><span class="line">      debug_message(<span class="string">"%s() in the master file does not work\n"</span>,</span><br><span class="line">                    applies_table[APPLY_GET_BACKBONE_UID]);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    set_backbone_uid(ret-&gt;u.<span class="built_in">string</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PACKAGE_MUDLIB_STATS</span></span><br><span class="line">    <span class="comment">// 'master::domain_file' should return an apropriate "domain" for each</span></span><br><span class="line">    <span class="comment">// file (directory), as such we should get the backbone domain by</span></span><br><span class="line">    <span class="comment">// asking for 'master::domain_file("/")'</span></span><br><span class="line">    push_constant_string(<span class="string">"/"</span>);</span><br><span class="line">    ret = apply_master_ob(APPLY_DOMAIN_FILE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="literal">nullptr</span> || ret-&gt;type != T_STRING) &#123;</span><br><span class="line">      <span class="comment">// we didn't got the expected value?</span></span><br><span class="line">      <span class="comment">// emit warning and fall back to old behavior</span></span><br><span class="line">      debug_message(<span class="string">"%s() in the master file does not work, using bb_ui as fallback (see %s.4)d\n"</span>,</span><br><span class="line">                    applies_table[APPLY_DOMAIN_FILE], applies_table[APPLY_DOMAIN_FILE]);</span><br><span class="line">      set_backbone_domain(backbone_uid-&gt;name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      set_backbone_domain(ret-&gt;u.<span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    master_ob-&gt;uid = add_uid(ret-&gt;u.<span class="built_in">string</span>);</span><br><span class="line">    master_ob-&gt;euid = master_ob-&gt;uid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="preload-objects"><a href="#preload-objects" class="headerlink" title="preload_objects"></a>preload_objects</h2><p>这首先会获取需要进行预加载的文件列表（<code>epilog</code> 方法）。</p>
<p>然后应用 (<code>preload</code>)方法进行实际的加载。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* The epilog() in master.c is supposed to return an array of files to load.</span></span><br><span class="line"><span class="comment"> * The preload() in master object called to do the actual loading.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preload_objects</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Legacy: epilog() has a int param to make it to avoid load anything.</span></span><br><span class="line">  <span class="comment">// I'm not sure who would use that.</span></span><br><span class="line">  push_number(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">auto</span> ret = safe_apply_master_ob(APPLY_EPILOG, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((ret == <span class="literal">nullptr</span>) || (ret == (<span class="keyword">svalue_t</span> *)<span class="number">-1</span>) || (ret-&gt;type != T_ARRAY)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> prefiles = ret-&gt;u.arr;</span><br><span class="line">  <span class="keyword">if</span> ((prefiles == <span class="literal">nullptr</span>) || (prefiles-&gt;size &lt; <span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// prefiles (the global apply return value) would have been freed on next apply call.</span></span><br><span class="line">  <span class="comment">// so we have to increase ref here to make sure it is around.</span></span><br><span class="line">  prefiles-&gt;ref++;</span><br><span class="line"></span><br><span class="line">  debug_message(<span class="string">"\nLoading preload files ...\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; prefiles-&gt;size; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prefiles-&gt;item[i].type != T_STRING) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    debug_message(<span class="string">"%s...\n"</span>, prefiles-&gt;item[i].u.<span class="built_in">string</span>);</span><br><span class="line"></span><br><span class="line">    push_svalue(&amp;prefiles-&gt;item[i]);</span><br><span class="line">    set_eval(max_eval_cost);</span><br><span class="line">    safe_apply_master_ob(APPLY_PRELOAD, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  free_array(prefiles);</span><br><span class="line">&#125; <span class="comment">/* preload_objects() */</span></span><br></pre></td></tr></table></figure>
<h1 id="init-user-conn"><a href="#init-user-conn" class="headerlink" title="init_user_conn"></a>init_user_conn</h1><p>这函数没啥说的，就是监听套接字，然后把新连接事件交给 libevent 进行回调</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Listen on connection event</span></span><br><span class="line"><span class="keyword">auto</span> conn = evconnlistener_new(</span><br><span class="line">    g_event_base, new_user_handler, &amp;i,</span><br><span class="line">    LEV_OPT_REUSEABLE | LEV_OPT_CLOSE_ON_FREE | LEV_OPT_CLOSE_ON_EXEC, <span class="number">1024</span>, fd);</span><br></pre></td></tr></table></figure>
<h2 id="new-user-handler"><a href="#new-user-handler" class="headerlink" title="new_user_handler"></a>new_user_handler</h2><p>当用户连接后，那么就会初始化一个数据结构出来。这个数据结构，我更愿意把他叫做 <code>连接</code>，比如说当前的 C/S 架构里面会说的 <code>Session</code>。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> user = new_user(port, fd, addr, addrlen); <span class="comment">// 这个时候，实际上 user 这个数据结构的对象还是 master_obj</span></span><br><span class="line">new_user_event_listener(base, user); <span class="comment">// 缓冲区事件回调设置</span></span><br><span class="line"><span class="keyword">if</span> (user-&gt;connection_type == PORT_TELNET) &#123;</span><br><span class="line">  user-&gt;telnet = net_telnet_init(user);</span><br><span class="line">  send_initial_telnet_negotiations(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">event_base_once(</span><br><span class="line">    base, <span class="number">-1</span>, EV_TIMEOUT,</span><br><span class="line">    [](<span class="keyword">evutil_socket_t</span> fd, short what, <span class="keyword">void</span> *arg) &#123;</span><br><span class="line">      <span class="keyword">auto</span> user = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">interactive_t</span> *&gt;(arg);</span><br><span class="line">      on_user_logon(user);</span><br><span class="line">    &#125;,</span><br><span class="line">    (<span class="keyword">void</span> *)user, <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interactive_t</span> *user_add() &#123;</span><br><span class="line">  <span class="keyword">auto</span> user = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">interactive_t</span> *&gt;(</span><br><span class="line">      DMALLOC(<span class="keyword">sizeof</span>(<span class="keyword">interactive_t</span>), TAG_INTERACTIVE, <span class="string">"new_user_handler"</span>));</span><br><span class="line">  <span class="built_in">memset</span>(user, <span class="number">0</span>, <span class="keyword">sizeof</span>(*user));</span><br><span class="line">  all_users.push_back(user);</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个新的 User 结构（注意，这不是 VM 的对象），这个结构实际上代表了一玩家本身（连接，交互等）。注意与 Player 进行区别。</p>
<p>接着，就把用户调度到登录流程了。</p>
<h2 id="on-user-logon"><a href="#on-user-logon" class="headerlink" title="on_user_logon"></a>on_user_logon</h2><p>在这里，会在 master_obj 上应用  <code>connect</code> 函数，这个函数的返回，由我们自己定义，在 lpctest 项目中，其会返回一个 <code>login.c</code> 对象。</p>
<p>接着就会调用 <code>login.c</code> 对象的 <code>LOGON</code> 方法，实现登录逻辑。然后将 User 绑定一个 Logon 对象 。</p>
<p>然后对这个 Logon 对象，apply logon 方法，让玩家从登录对象，转到游戏对象，然后，就将这个对象移动到游戏世界了。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">on_user_logon</span><span class="params">(<span class="keyword">interactive_t</span> *user)</span> </span>&#123;</span><br><span class="line">  set_command_giver(master_ob);</span><br><span class="line">  master_ob-&gt;flags |= O_ONCE_INTERACTIVE;</span><br><span class="line">  master_ob-&gt;interactive = user;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * The user object has one extra reference. It is asserted that the</span></span><br><span class="line"><span class="comment">   * master_ob is loaded.  Save a pointer to the master ob incase it</span></span><br><span class="line"><span class="comment">   * changes during APPLY_CONNECT.  We want to free the reference on</span></span><br><span class="line"><span class="comment">   * the right copy of the object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">object_t</span> *master, *ob;</span><br><span class="line">  <span class="keyword">svalue_t</span> *ret;</span><br><span class="line"></span><br><span class="line">  master = master_ob;</span><br><span class="line">  add_ref(master_ob, <span class="string">"new_user"</span>);</span><br><span class="line">  push_number(user-&gt;local_port);</span><br><span class="line">  set_eval(max_eval_cost);</span><br><span class="line">  ret = safe_apply_master_ob(APPLY_CONNECT, <span class="number">1</span>);</span><br><span class="line">  <span class="comment">/* master_ob-&gt;interactive can be zero if the master object self</span></span><br><span class="line"><span class="comment">   destructed in the above (don't ask) */</span></span><br><span class="line">  set_command_giver(<span class="literal">nullptr</span>);</span><br><span class="line">  <span class="keyword">if</span> (ret == <span class="literal">nullptr</span> || ret == (<span class="keyword">svalue_t</span> *)<span class="number">-1</span> || ret-&gt;type != T_OBJECT || !master_ob-&gt;interactive) &#123;</span><br><span class="line">    debug_message(<span class="string">"Can not accept connection from %s due to error in connect().\n"</span>,</span><br><span class="line">                  sockaddr_to_string(<span class="keyword">reinterpret_cast</span>&lt;sockaddr *&gt;(&amp;user-&gt;addr), user-&gt;addrlen));</span><br><span class="line">    <span class="keyword">if</span> (master_ob-&gt;interactive) &#123;</span><br><span class="line">      remove_interactive(master_ob, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * There was an object returned from connect(). Use this as the user</span></span><br><span class="line"><span class="comment">   * object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ob = ret-&gt;u.ob;</span><br><span class="line">  ob-&gt;interactive = master_ob-&gt;interactive;</span><br><span class="line">  ob-&gt;interactive-&gt;ob = ob;</span><br><span class="line">  ob-&gt;flags |= O_ONCE_INTERACTIVE;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * assume the existance of write_prompt and process_input in user.c</span></span><br><span class="line"><span class="comment">   * until proven wrong (after trying to call them).</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ob-&gt;interactive-&gt;iflags |= (HAS_WRITE_PROMPT | HAS_PROCESS_INPUT);</span><br><span class="line"></span><br><span class="line">  free_object(&amp;master, <span class="string">"new_user"</span>);</span><br><span class="line"></span><br><span class="line">  master_ob-&gt;flags &amp;= ~O_ONCE_INTERACTIVE;</span><br><span class="line">  master_ob-&gt;interactive = <span class="literal">nullptr</span>;</span><br><span class="line">  add_ref(ob, <span class="string">"new_user"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// start reverse DNS probing.</span></span><br><span class="line">  query_name_by_addr(ob);</span><br><span class="line"></span><br><span class="line">  set_command_giver(ob);</span><br><span class="line"></span><br><span class="line">  set_prompt(<span class="string">"&gt; "</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call logon() on the object.</span></span><br><span class="line">  set_eval(max_eval_cost);</span><br><span class="line">  ret = safe_apply(APPLY_LOGON, ob, <span class="number">0</span>, ORIGIN_DRIVER);</span><br><span class="line">  <span class="keyword">if</span> (ret == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    debug_message(<span class="string">"new_user_handler: logon() on object %s has failed, the user is disconnected.\n"</span>,</span><br><span class="line">                  ob-&gt;obname);</span><br><span class="line">    remove_interactive(ob, <span class="literal">false</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ob-&gt;flags &amp; O_DESTRUCTED) &#123;</span><br><span class="line">    <span class="comment">// logon() may decide not to allow user connect by destroying objects.</span></span><br><span class="line">    remove_interactive(ob, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  set_command_giver(<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*****************************************************************************</span></span><br><span class="line"><span class="comment">Copyright: 2019, Mud.Ren</span></span><br><span class="line"><span class="comment">File name: login_ob.c</span></span><br><span class="line"><span class="comment">Description: 玩家登录连线对象</span></span><br><span class="line"><span class="comment">Author: xuefeng</span></span><br><span class="line"><span class="comment">Version: v1.0</span></span><br><span class="line"><span class="comment">Date: 2019-04-18</span></span><br><span class="line"><span class="comment">*****************************************************************************/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WELCOME <span class="meta-string">"/system/etc/motd"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">(<span class="built_in">string</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    object from, to;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!arg || arg == <span class="string">""</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">write</span>(<span class="string">"ID不能为空，请重新输入："</span>);</span><br><span class="line">        input_to(<span class="string">"setup"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        from = this_object();</span><br><span class="line">        to = <span class="keyword">new</span>(USER_OB, arg);</span><br><span class="line">        exec(to, from);</span><br><span class="line">        <span class="comment">// destruct(from);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">logon</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">write</span>(read_file(WELCOME));</span><br><span class="line">    <span class="built_in">write</span>(<span class="string">"请输入你的ID："</span>);</span><br><span class="line">    input_to(<span class="string">"setup"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再之后，如果用户进行输入了信息，那么就需要进行调度了。我们之前已经把 User 的回调设置为了 <code>on_user_read</code>。</p>
<h2 id="on-user-read"><a href="#on-user-read" class="headerlink" title="on_user_read"></a>on_user_read</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">on_user_read</span><span class="params">(bufferevent *bev, <span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> user = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">interactive_t</span> *&gt;(arg);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (user == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    fatal(<span class="string">"on_user_read: user == NULL, Driver BUG."</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read user input</span></span><br><span class="line">  get_user_data(user);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> currently get_user_data() will schedule command execution.</span></span><br><span class="line">  <span class="comment">// should probably move it here.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这最终会让输入的指令执行起来。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers"></a>setup_signal_handlers</h1><h1 id="backend"><a href="#backend" class="headerlink" title="backend"></a>backend</h1><p>为 libevent 设置很多可事器事件来清理虚拟机内的内容：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backend</span><span class="params">(struct event_base *base)</span> </span>&#123;</span><br><span class="line">  clear_state();</span><br><span class="line">  g_current_gametick = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Register various tick events</span></span><br><span class="line">  add_gametick_event(<span class="built_in">std</span>::chrono::seconds(<span class="number">0</span>), tick_event::callback_type(call_heart_beat));</span><br><span class="line">  add_gametick_event(<span class="built_in">std</span>::chrono::minutes(<span class="number">5</span>), tick_event::callback_type(look_for_objects_to_swap));</span><br><span class="line">  add_gametick_event(<span class="built_in">std</span>::chrono::minutes(<span class="number">30</span>),</span><br><span class="line">                     tick_event::callback_type([] &#123; <span class="keyword">return</span> reclaim_objects(<span class="literal">true</span>); &#125;));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PACKAGE_MUDLIB_STATS</span></span><br><span class="line">  add_gametick_event(<span class="built_in">std</span>::chrono::minutes(<span class="number">60</span>), tick_event::callback_type(mudlib_stats_decay));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  add_gametick_event(<span class="built_in">std</span>::chrono::minutes(<span class="number">5</span>),</span><br><span class="line">                     tick_event::callback_type(call_remove_destructed_objects));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> we don't use EV_PERSITENT here because that use fix-rate scheduling.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Schedule a repeating tick for advancing virtual time.</span></span><br><span class="line">  <span class="comment">// Gametick provides a fixed-delay scheduling with a guaranteed minimum delay for</span></span><br><span class="line">  <span class="comment">// heartbeats, callouts, and various cleaning function.</span></span><br><span class="line">  g_ev_tick = evtimer_new(base, on_game_tick, &amp;g_ev_tick);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> t = gametick_timeval();</span><br><span class="line">  event_add(g_ev_tick, &amp;t);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    event_base_loop(base, <span class="number">0</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (...) &#123;  <span class="comment">// catch everything</span></span><br><span class="line">    fatal(<span class="string">"BUG: jumped out of event loop!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// We've reached here meaning we are in shutdown sequence.</span></span><br><span class="line">  shutdownMudOS(<span class="number">-1</span>);</span><br><span class="line">&#125; <span class="comment">/* backend() */</span></span><br></pre></td></tr></table></figure>
<h1 id="分层架构"><a href="#分层架构" class="headerlink" title="分层架构"></a>分层架构</h1><div class="language-dot">
digraph {
compound=true
subgraph cluster_driver{
label=Driver
libevent
efuns
interactive
o[style=invis]
socket -> libevent -> interactive
}
subgraph cluster_vm{
label=VM
master_ob
simul_funs
subgraph cluster_lib{
label=MUDLib
daemon
LOGON_OB
USER_OB
"...."
}
}

interactive -> {master_ob LOGON_OB USER_OB}[style=dashed,dir=both]
efuns -> simul_funs[style=dashed,lhead=cluster_vm,label=register]
simul_funs -> daemon[style=dashed,lhead=cluster_lib]
o -> master_ob[label=apply,lhead=cluster_vm]
}
</div>
<h1 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h1><div class="language-dot">
digraph {
compound=true
subgraph cluster_driver{
label=DRIVER
EV[label=libevent]
U[label="USER(interactive)"]
S[label=Socket]
C[label=Client]
BEV[label=BufferEvent]
subgraph cluster_comm{
label="COMM函数库"
new_user_handler
on_user_read on_user_write on_user_events
on_user_logon
get_user_data
process_input
new_user_handler -> BEV[label="2. new_user_event_listener"]
new_user_handler -> on_user_logon[label="3"]
on_user_read -> get_user_data

}

C -> S[label=connect]
S -> EV
EV -> new_user_handler
new_user_handler -> U[label="1.new_user"]
BEV -> {on_user_read on_user_write on_user_events}


}


subgraph cluster_vm{
label=VM
vm_init -> init_identifiers -> efuns[label=加载]
efuns
master_obj
simul_efun
objects -> {simul_efun efuns}[label=使用]
subgraph cluster_preload{
label=preload_objects
LOGON_OB
USER_OB
}
master_obj -> LOGON_OB[label=ret]
}

on_user_logon -> master_obj[label="apply_connect"]
on_user_logon -> LOGON_OB[label="apply_logon"]

LOGON_OB -> USER_OB[label=exec]
get_user_data -> master_obj[lhead=cluster_vm,label="apply"]
}
</div>
<h1 id="apply-与-efun"><a href="#apply-与-efun" class="headerlink" title="apply 与 efun"></a>apply 与 efun</h1><p>apply 是 VM 提供给 DRIVER 层使用的 API，用以操纵 VM 内的对象。</p>
<p>而 efuns 则是 DRIVER 提供给 VM 层使用的函数。相当于底层函数库。</p>
<p>sim_efuns 则是在 VM 层内用 LPC 封装好的函数库。</p>
<script src="https://unpkg.com/viz.js@2.1.2/viz.js"></script><script src="https://unpkg.com/viz.js@2.1.2/full.render.js"></script>                <script>
                // graphviz init
                let graphviz_engines = ["circo",
                    "dot",
                    "fdp",
                    "neato",
                    "osage",
                    "twopi"];

                function doGraphviz(engine) {
                    let domAllDot = document.querySelectorAll('.language-' + engine);
                    for (let i = 0; i < domAllDot.length; i++) {
                        let dom = domAllDot[i];
                        let graphSource = dom.innerText || dom.textContent;

                        try {
                           let viz = new Viz();
                             viz.renderSVGElement(graphSource, {engine: engine})
                                 .then(r => {
                            dom.innerHTML ='';dom.append(r); });
                        } catch (e) {
                            console.error("Error when parsing node:", dom, e);
                        } 
                    }
                } 

                let init = function () {
                    for (let i = 0; i < graphviz_engines.length; i++) {
                        doGraphviz(graphviz_engines[i]);
                    }
                };
                if (typeof window.addEventListener != "undefined") {
                    window.addEventListener("load", init, false);
                } else {
                    window.attachEvent("onload", init);
                }
                </script>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MUD/" rel="tag"># MUD</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/Cocos-Creator/关于使用PureMVC及FairyGUI在CocosCreator中进行开发的一个架构.html" rel="next" title="关于使用PureMVC及FairyGUI在CocosCreator中进行开发的一个架构">
                  <i class="fa fa-chevron-left"></i> 关于使用PureMVC及FairyGUI在CocosCreator中进行开发的一个架构
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#fluffos-mudos"><span class="nav-number">1.</span> <span class="nav-text">fluffos/mudos</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#driver-main"><span class="nav-number">2.</span> <span class="nav-text">driver_main</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#init-main"><span class="nav-number">3.</span> <span class="nav-text">init_main</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#init-backend"><span class="nav-number">3.1.</span> <span class="nav-text">init_backend</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vm-init"><span class="nav-number">3.2.</span> <span class="nav-text">vm_init</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#vm-start"><span class="nav-number">4.</span> <span class="nav-text">vm_start</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#init-simul-efun"><span class="nav-number">4.1.</span> <span class="nav-text">init_simul_efun</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#load-object"><span class="nav-number">4.2.</span> <span class="nav-text">load_object</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#init-master"><span class="nav-number">4.3.</span> <span class="nav-text">init_master</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#preload-objects"><span class="nav-number">4.4.</span> <span class="nav-text">preload_objects</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#init-user-conn"><span class="nav-number">5.</span> <span class="nav-text">init_user_conn</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#new-user-handler"><span class="nav-number">5.1.</span> <span class="nav-text">new_user_handler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#on-user-logon"><span class="nav-number">5.2.</span> <span class="nav-text">on_user_logon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#on-user-read"><span class="nav-number">5.3.</span> <span class="nav-text">on_user_read</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#setup-signal-handlers"><span class="nav-number">6.</span> <span class="nav-text">setup_signal_handlers</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#backend"><span class="nav-number">7.</span> <span class="nav-text">backend</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分层架构"><span class="nav-number">8.</span> <span class="nav-text">分层架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#架构图"><span class="nav-number">9.</span> <span class="nav-text">架构图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#apply-与-efun"><span class="nav-number">10.</span> <span class="nav-text">apply 与 efun</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Gowa2017 Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">142</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gowa2017" title="GitHub → https://github.com/gowa2017" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shouzheng.zhang@gmail.com" title="E-Mail → mailto:shouzheng.zhang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-json"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gowa2017 Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js"></script><script src="/js/algolia-search.js"></script>














  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://gowa-1.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://gowa.club/MUD/FluffOS的简单架构分析.html",
            identifier: "MUD/FluffOS的简单架构分析.html",
            title: "FluffOS的简单架构分析"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://gowa-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    window.addEventListener('load', loadComments, false);
</script>

</body>
</html>
