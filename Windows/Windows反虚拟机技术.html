<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="退思园" type="application/atom+xml">
  <meta name="google-site-verification" content="EDvvZZUFkxy_QUzZTaqwsG_9VHqFthY-NhQE4j6WL-s">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: 'LHD9LWONQ3',
      apiKey: '23a113c49e36d8cc93f61239cb530b43',
      indexName: 'gowa.club',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="转载，原文地址。恶意代码编写者经常使用反虚拟机技术逃避分析，这种技术可以检测自己是否运行在虚拟机中。如果恶意代码探测到自己在虚拟机中运行，它会执行与其本身行为不同的行为，其中最简单的行为是停止自身运行。近年来，随着虚拟化技术的使用不断增加，采用反虚拟机技术的恶意代码数量逐渐下降。恶意代码编写者已经开始意识到，目标主机是虚拟机，也并不意味着它就没有攻击价值。随着虚拟化技术的不断发展和普通应用，反虚拟">
<meta name="keywords" content="Windows,逆向">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows反虚拟机技术">
<meta property="og:url" content="https://gowa.club/Windows/Windows反虚拟机技术.html">
<meta property="og:site_name" content="退思园">
<meta property="og:description" content="转载，原文地址。恶意代码编写者经常使用反虚拟机技术逃避分析，这种技术可以检测自己是否运行在虚拟机中。如果恶意代码探测到自己在虚拟机中运行，它会执行与其本身行为不同的行为，其中最简单的行为是停止自身运行。近年来，随着虚拟化技术的使用不断增加，采用反虚拟机技术的恶意代码数量逐渐下降。恶意代码编写者已经开始意识到，目标主机是虚拟机，也并不意味着它就没有攻击价值。随着虚拟化技术的不断发展和普通应用，反虚拟">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://gowa.club/res/20161016175206702.png">
<meta property="og:image" content="https://gowa.club/res/20161020193107820.png">
<meta property="og:image" content="https://gowa.club/res/20161016175120217.png">
<meta property="og:image" content="https://gowa.club/res/20161019195924802.png">
<meta property="og:image" content="https://gowa.club/res/20161016175531597.png">
<meta property="og:image" content="https://gowa.club/res/20161020192917319.png">
<meta property="og:image" content="https://gowa.club/res/20161019165025407.png">
<meta property="og:image" content="https://gowa.club/res/20161020232227265.png">
<meta property="og:updated_time" content="2019-10-24T13:47:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Windows反虚拟机技术">
<meta name="twitter:description" content="转载，原文地址。恶意代码编写者经常使用反虚拟机技术逃避分析，这种技术可以检测自己是否运行在虚拟机中。如果恶意代码探测到自己在虚拟机中运行，它会执行与其本身行为不同的行为，其中最简单的行为是停止自身运行。近年来，随着虚拟化技术的使用不断增加，采用反虚拟机技术的恶意代码数量逐渐下降。恶意代码编写者已经开始意识到，目标主机是虚拟机，也并不意味着它就没有攻击价值。随着虚拟化技术的不断发展和普通应用，反虚拟">
<meta name="twitter:image" content="https://gowa.club/res/20161016175206702.png">

<link rel="canonical" href="https://gowa.club/Windows/Windows反虚拟机技术.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Windows反虚拟机技术 | 退思园</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137245514-1"></script>
    <script>
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-137245514-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">退思园</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">烦恼一般都是想太多了。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-soft">

    <a href="/soft/" rel="section"><i class="fa fa-fw fa-rocket"></i>soft</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input" id="search-input"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gowa.club/Windows/Windows反虚拟机技术.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Gowa2017 Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="退思园">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Windows反虚拟机技术
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-24 21:47:46" itemprop="dateCreated datePublished" datetime="2019-10-24T21:47:46+08:00">2019-10-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Windows/" itemprop="url" rel="index">
                    <span itemprop="name">Windows</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Windows/Windows反虚拟机技术.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Windows/Windows反虚拟机技术.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>转载，<a href="https://blog.csdn.net/qq_32400847/article/details/52830990" target="_blank" rel="noopener">原文地址</a>。恶意代码编写者经常使用反虚拟机技术逃避分析，这种技术可以检测自己是否运行在虚拟机中。如果恶意代码探测到自己在虚拟机中运行，它会执行与其本身行为不同的行为，其中最简单的行为是停止自身运行。近年来，随着虚拟化技术的使用不断增加，采用反虚拟机技术的恶意代码数量逐渐下降。恶意代码编写者已经开始意识到，目标主机是虚拟机，也并不意味着它就没有攻击价值。随着虚拟化技术的不断发展和普通应用，反虚拟机技术可能变得更加少见。这里研究最常见的反虚拟机技术(包括VMware、virtualbox和virtualpc，重点是最常用的VMware)，并且介绍一些如何防御它们的办法。</p>
<a id="more"></a>
<h1 id="一、检测虚拟机痕迹"><a href="#一、检测虚拟机痕迹" class="headerlink" title="一、检测虚拟机痕迹"></a>一、检测虚拟机痕迹</h1><h2 id="1、根据MAC地址"><a href="#1、根据MAC地址" class="headerlink" title="1、根据MAC地址"></a>1、根据MAC地址</h2><p>通常，MAC地址的前三个字节标识一个提供商。以00:05:69、00:0c:29和00:50:56开始的MAC地址与VMware相对应；以00:03:ff开始的MAC地址与virtualpc对应；以08:00:27开始的MAC地址与virtualbox对应。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> mac;</span><br><span class="line">    get_3part_mac(mac);</span><br><span class="line">    <span class="keyword">if</span> (mac==<span class="string">"00-05-69"</span> || mac==<span class="string">"00-0c-29"</span> || mac==<span class="string">"00-50-56"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualPC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> mac;</span><br><span class="line">    get_3part_mac(mac);</span><br><span class="line">    <span class="keyword">if</span> (mac==<span class="string">"00-03-ff"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> mac;</span><br><span class="line">    get_3part_mac(mac);</span><br><span class="line">    <span class="keyword">if</span> (mac==<span class="string">"08-00-27"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ASTAT_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ADAPTER_STATUS adapt;</span><br><span class="line">	NAME_BUFFER NameBuff[<span class="number">30</span>];</span><br><span class="line">&#125; ASTAT, *PASTAT;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_3part_mac</span><span class="params">(<span class="built_in">string</span> &amp;mac)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NCB Ncb;</span><br><span class="line">	ASTAT Adapter;</span><br><span class="line">	UCHAR uRetCode;</span><br><span class="line">	LANA_ENUM lenum;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;Ncb, <span class="number">0</span>, <span class="keyword">sizeof</span>(Ncb));</span><br><span class="line">	Ncb.ncb_command = NCBENUM;</span><br><span class="line">	Ncb.ncb_buffer = (UCHAR *)&amp;lenum;</span><br><span class="line">	Ncb.ncb_length = <span class="keyword">sizeof</span>(lenum);</span><br><span class="line">	uRetCode = Netbios(&amp;Ncb);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lenum.length; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;Ncb, <span class="number">0</span>, <span class="keyword">sizeof</span>(Ncb));</span><br><span class="line">		Ncb.ncb_command = NCBRESET;</span><br><span class="line">		Ncb.ncb_lana_num = lenum.lana[i];</span><br><span class="line">		uRetCode = Netbios(&amp;Ncb);</span><br><span class="line">		<span class="built_in">memset</span>(&amp;Ncb, <span class="number">0</span>, <span class="keyword">sizeof</span>(Ncb));</span><br><span class="line">		Ncb.ncb_command = NCBASTAT;</span><br><span class="line">		Ncb.ncb_lana_num = lenum.lana[i];</span><br><span class="line">		<span class="built_in">strcpy</span>((<span class="keyword">char</span> *)Ncb.ncb_callname, <span class="string">"*"</span>);</span><br><span class="line">		Ncb.ncb_buffer = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)&amp;Adapter;</span><br><span class="line">		Ncb.ncb_length = <span class="keyword">sizeof</span>(Adapter);</span><br><span class="line">		uRetCode = Netbios(&amp;Ncb);</span><br><span class="line">		<span class="keyword">if</span> (uRetCode == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">char</span> tmp[<span class="number">128</span>];</span><br><span class="line">			<span class="built_in">sprintf</span>(tmp, <span class="string">"%02x-%02x-%02x"</span>,</span><br><span class="line">				Adapter.adapt.adapter_address[<span class="number">0</span>],</span><br><span class="line">				Adapter.adapt.adapter_address[<span class="number">1</span>],</span><br><span class="line">				Adapter.adapt.adapter_address[<span class="number">2</span>]</span><br><span class="line">			);</span><br><span class="line">			mac = tmp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2、基于主板序列号、主机型号、系统盘所在磁盘名称等其他硬件信息"><a href="#2、基于主板序列号、主机型号、系统盘所在磁盘名称等其他硬件信息" class="headerlink" title="2、基于主板序列号、主机型号、系统盘所在磁盘名称等其他硬件信息"></a>2、基于主板序列号、主机型号、系统盘所在磁盘名称等其他硬件信息</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//通过WMI获取主机信息</span></span><br><span class="line"><span class="function">BOOL <span class="title">ManageWMIInfo</span><span class="params">(<span class="built_in">string</span> &amp;result, <span class="built_in">string</span> table, <span class="built_in">wstring</span> wcol)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HRESULT hres;</span><br><span class="line">	<span class="keyword">char</span> bord[<span class="number">1024</span>];</span><br><span class="line">	<span class="comment">//初始化COM</span></span><br><span class="line">	hres = CoInitialize(<span class="number">0</span>);</span><br><span class="line">	<span class="comment">//获得WMI连接COM接口</span></span><br><span class="line">	IWbemLocator *pLoc = <span class="literal">NULL</span>;</span><br><span class="line">	hres = CoCreateInstance(</span><br><span class="line">		CLSID_WbemLocator,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		CLSCTX_INPROC_SERVER,</span><br><span class="line">		IID_IWbemLocator, (LPVOID *) &amp;pLoc);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hres))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Failed to create IWbemLocator object."</span></span><br><span class="line">			&lt;&lt; <span class="string">"Err code = 0x"</span></span><br><span class="line">			&lt;&lt; hex &lt;&lt; hres &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		CoUninitialize();</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//通过连接接口连接WMI的内核对象名ROOT//CIMV2</span></span><br><span class="line">	IWbemServices *pSvc = <span class="literal">NULL</span>;</span><br><span class="line">	hres = pLoc-&gt;ConnectServer(</span><br><span class="line">		<span class="keyword">_bstr_t</span>(<span class="string">L"ROOT\\CIMV2"</span>), <span class="comment">// Object path of WMI namespace</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// User name. NULL = current user</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// User password. NULL = current</span></span><br><span class="line">		<span class="number">0</span>, <span class="comment">// Locale. NULL indicates current</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// Security flags.</span></span><br><span class="line">		<span class="number">0</span>, <span class="comment">// Authority (e.g. Kerberos)</span></span><br><span class="line">		<span class="number">0</span>, <span class="comment">// Context object</span></span><br><span class="line">		&amp;pSvc <span class="comment">// pointer to IWbemServices proxy</span></span><br><span class="line">		);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hres))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not connect. Error code = 0x"</span></span><br><span class="line">			&lt;&lt; hex &lt;&lt; hres &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		pLoc-&gt;Release();</span><br><span class="line">		CoUninitialize();</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置请求代理的安全级别</span></span><br><span class="line">	hres = CoSetProxyBlanket(</span><br><span class="line">		pSvc, <span class="comment">// Indicates the proxy to set</span></span><br><span class="line">		RPC_C_AUTHN_WINNT, <span class="comment">// RPC_C_AUTHN_xxx</span></span><br><span class="line">		RPC_C_AUTHZ_NONE, <span class="comment">// RPC_C_AUTHZ_xxx</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// Server principal name</span></span><br><span class="line">		RPC_C_AUTHN_LEVEL_CALL, <span class="comment">// RPC_C_AUTHN_LEVEL_xxx</span></span><br><span class="line">		RPC_C_IMP_LEVEL_IMPERSONATE, <span class="comment">// RPC_C_IMP_LEVEL_xxx</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// client identity</span></span><br><span class="line">		EOAC_NONE <span class="comment">// proxy capabilities</span></span><br><span class="line">		);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hres))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not set proxy blanket. Error code = 0x"</span></span><br><span class="line">			&lt;&lt; hex &lt;&lt; hres &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		pSvc-&gt;Release();</span><br><span class="line">		pLoc-&gt;Release();</span><br><span class="line">		CoUninitialize();</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//通过请求代理来向WMI发送请求</span></span><br><span class="line">	IEnumWbemClassObject* pEnumerator = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="built_in">string</span> select = <span class="string">"SELECT * FROM "</span>+ table;</span><br><span class="line">	hres = pSvc-&gt;ExecQuery(</span><br><span class="line">		<span class="keyword">bstr_t</span>(<span class="string">"WQL"</span>),</span><br><span class="line">		<span class="keyword">bstr_t</span>(select.c_str()),</span><br><span class="line">		WBEM_FLAG_FORWARD_ONLY | WBEM_FLAG_RETURN_IMMEDIATELY,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		&amp;pEnumerator);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hres))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Query for Network Adapter Configuration failed."</span></span><br><span class="line">			&lt;&lt; <span class="string">" Error code = 0x”"</span></span><br><span class="line">			&lt;&lt; hex &lt;&lt; hres &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		pSvc-&gt;Release();</span><br><span class="line">		pLoc-&gt;Release();</span><br><span class="line">		CoUninitialize();</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//循环枚举所有的结果对象</span></span><br><span class="line">	ULONG uReturn = <span class="number">0</span>;</span><br><span class="line">	IWbemClassObject *pclsObj;</span><br><span class="line">	<span class="keyword">while</span> (pEnumerator)</span><br><span class="line">	&#123;</span><br><span class="line">		HRESULT hr = pEnumerator-&gt;Next(WBEM_INFINITE, <span class="number">1</span>,</span><br><span class="line">			&amp;pclsObj, &amp;uReturn);</span><br><span class="line">		<span class="keyword">if</span>(<span class="number">0</span> == uReturn)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		VARIANT vtProp;</span><br><span class="line">		VariantInit(&amp;vtProp);</span><br><span class="line">		hr = pclsObj-&gt;Get(wcol.c_str(), <span class="number">0</span>, &amp;vtProp, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>(!FAILED(hr))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="function">CW2A <span class="title">tmpstr1</span><span class="params">(vtProp.bstrVal)</span></span>;</span><br><span class="line">			strcpy_s(bord,<span class="number">200</span>,tmpstr1);</span><br><span class="line">			result = bord;</span><br><span class="line">		&#125;</span><br><span class="line">		VariantClear(&amp;vtProp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//释放资源</span></span><br><span class="line">	pSvc-&gt;Release();</span><br><span class="line">	pLoc-&gt;Release();</span><br><span class="line">	pEnumerator-&gt;Release();</span><br><span class="line">	pclsObj-&gt;Release();</span><br><span class="line">	CoUninitialize();</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> table = <span class="string">"Win32_BaseBoard"</span>;</span><br><span class="line">	<span class="built_in">wstring</span> wcol = <span class="string">L"SerialNumber"</span>;</span><br><span class="line">	<span class="built_in">string</span> ret;</span><br><span class="line">	ManageWMIInfo(ret, table, wcol);</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="string">"None"</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> table = <span class="string">"Win32_DiskDrive"</span>;</span><br><span class="line">	<span class="built_in">wstring</span> wcol = <span class="string">L"Caption"</span>;</span><br><span class="line">	<span class="built_in">string</span> ret;</span><br><span class="line">	ManageWMIInfo(ret, table, wcol);</span><br><span class="line">	<span class="keyword">if</span> (ret.<span class="built_in">find</span>(<span class="string">"VMware"</span>) != <span class="built_in">string</span>::npos)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> table = <span class="string">"Win32_computersystem"</span>;</span><br><span class="line">	<span class="built_in">wstring</span> wcol = <span class="string">L"Model"</span>;</span><br><span class="line">	<span class="built_in">string</span> ret;</span><br><span class="line">	ManageWMIInfo(ret, table, wcol);</span><br><span class="line">	<span class="keyword">if</span> (ret.<span class="built_in">find</span>(<span class="string">"VMware"</span>) != <span class="built_in">string</span>::npos)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> table = <span class="string">"Win32_computersystem"</span>;</span><br><span class="line">	<span class="built_in">wstring</span> wcol = <span class="string">L"Model"</span>;</span><br><span class="line">	<span class="built_in">string</span> ret;</span><br><span class="line">	ManageWMIInfo(ret, table, wcol);</span><br><span class="line">	<span class="keyword">if</span> (ret.<span class="built_in">find</span>(<span class="string">"VirtualBox"</span>) != <span class="built_in">string</span>::npos)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> table = <span class="string">"Win32_DiskDrive"</span>;</span><br><span class="line">	<span class="built_in">wstring</span> wcol = <span class="string">L"Caption"</span>;</span><br><span class="line">	<span class="built_in">string</span> ret;</span><br><span class="line">	ManageWMIInfo(ret, table, wcol);</span><br><span class="line">	<span class="keyword">if</span> (ret.<span class="built_in">find</span>(<span class="string">"VBOX"</span>) != <span class="built_in">string</span>::npos)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualPC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> table = <span class="string">"Win32_DiskDrive"</span>;</span><br><span class="line">	<span class="built_in">wstring</span> wcol = <span class="string">L"Caption"</span>;</span><br><span class="line">	<span class="built_in">string</span> ret;</span><br><span class="line">	ManageWMIInfo(ret, table, wcol);</span><br><span class="line">	<span class="keyword">if</span> (ret.<span class="built_in">find</span>(<span class="string">"Virtual HD"</span>) != <span class="built_in">string</span>::npos)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualPC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> table = <span class="string">"Win32_computersystem"</span>;</span><br><span class="line">	<span class="built_in">wstring</span> wcol = <span class="string">L"Model"</span>;</span><br><span class="line">	<span class="built_in">string</span> ret;</span><br><span class="line">	ManageWMIInfo(ret, table, wcol);</span><br><span class="line">	<span class="keyword">if</span> (ret.<span class="built_in">find</span>(<span class="string">"Virtual Machine"</span>) != <span class="built_in">string</span>::npos)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3、根据当前进程信息"><a href="#3、根据当前进程信息" class="headerlink" title="3、根据当前进程信息"></a>3、根据当前进程信息</h2><p>通过进程快照读取当前进程信息，查找是否存在虚拟机中特有的进程，如VMware中的vmware.exe和VirtualBox中的VBoxService.exe。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD ret = <span class="number">0</span>;</span><br><span class="line">	PROCESSENTRY32 pe32;</span><br><span class="line">	pe32.dwSize = <span class="keyword">sizeof</span>(pe32);</span><br><span class="line">	HANDLE hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(hProcessSnap == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	BOOL bMore = Process32First(hProcessSnap, &amp;pe32);</span><br><span class="line">	<span class="keyword">while</span>(bMore)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(pe32.szExeFile, <span class="string">"vmware.exe"</span>)==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">		bMore = Process32Next(hProcessSnap, &amp;pe32);</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(hProcessSnap);</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD ret = <span class="number">0</span>;</span><br><span class="line">	PROCESSENTRY32 pe32;</span><br><span class="line">	pe32.dwSize = <span class="keyword">sizeof</span>(pe32);</span><br><span class="line">	HANDLE hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(hProcessSnap == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	BOOL bMore = Process32First(hProcessSnap, &amp;pe32);</span><br><span class="line">	<span class="keyword">while</span>(bMore)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(pe32.szExeFile, <span class="string">"VBoxService.exe"</span>)==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">		bMore = Process32Next(hProcessSnap, &amp;pe32);</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(hProcessSnap);</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4、根据特定的文件夹或文件信息"><a href="#4、根据特定的文件夹或文件信息" class="headerlink" title="4、根据特定的文件夹或文件信息"></a>4、根据特定的文件夹或文件信息</h2><p>通过查找磁盘中是否存在特定的文件夹或文件，判断当前是否在虚拟机中。VMware虚拟机中通常会有路径C:\Program Files\VMware\VMware Tools\；VirtualBox虚拟机中通常会有路径C:\Program Files\Oracle\VirtualBox Guest Additions\。</p>
<p><img src="../res/20161016175206702.png" alt="img"></p>
<p><img src="../res/20161020193107820.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckVMware</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (PathIsDirectory(<span class="string">"C:\\Program Files\\VMware\\VMware Tools\\"</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (PathIsDirectory(<span class="string">"C:\\Program Files\\Oracle\\VirtualBox Guest Additions\\"</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5、根据特定注册表信息"><a href="#5、根据特定注册表信息" class="headerlink" title="5、根据特定注册表信息"></a>5、根据特定注册表信息</h2><p>通过读取主机具有虚拟机特性的注册表位置来判断是否处于虚拟机环境中。针对VMware可以判断注册表项HKEY_CLASSES_ROOT\Applications\VMwareHostOpen.exe；针对VirtualBox可以判断注册表项HKEY_LOCAL_MACHINE\SOFTWARE\Oracle\VirtualBox Guest Additions。当然，注册表中能被检测出的位置很多，这里只是举个例子。</p>
<p><img src="../res/20161016175120217.png" alt="img"></p>
<p><img src="../res/20161019195924802.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HKEY hkey;</span><br><span class="line">    <span class="keyword">if</span> (RegOpenKey(HKEY_CLASSES_ROOT, <span class="string">"\\Applications\\VMwareHostOpen.exe"</span>, &amp;hkey) == ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HKEY hkey;</span><br><span class="line">	<span class="keyword">if</span> (RegOpenKey(HKEY_LOCAL_MACHINE, <span class="string">"SOFTWARE\\Oracle\\VirtualBox Guest Additions"</span>, &amp;hkey) == ERROR_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6、根据特定服务名"><a href="#6、根据特定服务名" class="headerlink" title="6、根据特定服务名"></a>6、根据特定服务名</h2><p>通过获取主机当前具有VMware特性的服务信息，判断当前主机是否为虚拟机。在VMware中通常会存在VMware物理磁盘助手服务和VMware Tools服务等；在VirtualBox中通常会存在VirtualBox Guest Additions Service服务等。</p>
<p><img src="../res/20161016175531597.png" alt="img"></p>
<p><img src="../res/20161020192917319.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> menu = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//打开系统服务控制器</span></span><br><span class="line">	SC_HANDLE SCMan = OpenSCManager(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ENUMERATE_SERVICE);</span><br><span class="line">	<span class="keyword">if</span>(SCMan == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; GetLastError() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"OpenSCManager Eorror/n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//保存系统服务的结构</span></span><br><span class="line">	LPENUM_SERVICE_STATUSA service_status;</span><br><span class="line">	DWORD cbBytesNeeded = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD ServicesReturned = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD ResumeHandle = <span class="literal">NULL</span>;</span><br><span class="line">	service_status = (LPENUM_SERVICE_STATUSA)LocalAlloc(LPTR, <span class="number">1024</span> * <span class="number">64</span>);</span><br><span class="line">	<span class="comment">//获取系统服务的简单信息</span></span><br><span class="line">	<span class="keyword">bool</span> ESS = EnumServicesStatusA(SCMan, <span class="comment">//系统服务句柄</span></span><br><span class="line">		SERVICE_WIN32, <span class="comment">//服务的类型</span></span><br><span class="line">		SERVICE_STATE_ALL,  <span class="comment">//服务的状态</span></span><br><span class="line">		(LPENUM_SERVICE_STATUSA)service_status,  <span class="comment">//输出参数，系统服务的结构</span></span><br><span class="line">		<span class="number">1024</span> * <span class="number">64</span>,  <span class="comment">//结构的大小</span></span><br><span class="line">		&amp;cbBytesNeeded, <span class="comment">//输出参数，接收返回所需的服务</span></span><br><span class="line">		&amp;ServicesReturned, <span class="comment">//输出参数，接收返回服务的数量</span></span><br><span class="line">		&amp;ResumeHandle); <span class="comment">//输入输出参数，第一次调用必须为0，返回为0代表成功</span></span><br><span class="line">	<span class="keyword">if</span>(ESS == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"EnumServicesStatus Eorror/n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ServicesReturned; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strstr</span>(service_status[i].lpDisplayName, <span class="string">"VMware Tools"</span>)!=<span class="literal">NULL</span> || <span class="built_in">strstr</span>(service_status[i].lpDisplayName, <span class="string">"VMware 物理磁盘助手服务"</span>)!=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭服务管理器的句柄</span></span><br><span class="line">	CloseServiceHandle(SCMan);</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualPC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> menu = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//打开系统服务控制器</span></span><br><span class="line">	SC_HANDLE SCMan = OpenSCManager(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ENUMERATE_SERVICE);</span><br><span class="line">	<span class="keyword">if</span>(SCMan == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; GetLastError() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"OpenSCManager Eorror/n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//保存系统服务的结构</span></span><br><span class="line">	LPENUM_SERVICE_STATUSA service_status;</span><br><span class="line">	DWORD cbBytesNeeded = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD ServicesReturned = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD ResumeHandle = <span class="literal">NULL</span>;</span><br><span class="line">	service_status = (LPENUM_SERVICE_STATUSA)LocalAlloc(LPTR, <span class="number">1024</span> * <span class="number">64</span>);</span><br><span class="line">	<span class="comment">//获取系统服务的简单信息</span></span><br><span class="line">	<span class="keyword">bool</span> ESS = EnumServicesStatusA(SCMan, <span class="comment">//系统服务句柄</span></span><br><span class="line">		SERVICE_WIN32, <span class="comment">//服务的类型</span></span><br><span class="line">		SERVICE_STATE_ALL,  <span class="comment">//服务的状态</span></span><br><span class="line">		(LPENUM_SERVICE_STATUSA)service_status,  <span class="comment">//输出参数，系统服务的结构</span></span><br><span class="line">		<span class="number">1024</span> * <span class="number">64</span>,  <span class="comment">//结构的大小</span></span><br><span class="line">		&amp;cbBytesNeeded, <span class="comment">//输出参数，接收返回所需的服务</span></span><br><span class="line">		&amp;ServicesReturned, <span class="comment">//输出参数，接收返回服务的数量</span></span><br><span class="line">		&amp;ResumeHandle); <span class="comment">//输入输出参数，第一次调用必须为0，返回为0代表成功</span></span><br><span class="line">	<span class="keyword">if</span>(ESS == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"EnumServicesStatus Eorror/n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ServicesReturned; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strstr</span>(service_status[i].lpDisplayName, <span class="string">"Virtual Machine"</span>)!=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭服务管理器的句柄</span></span><br><span class="line">	CloseServiceHandle(SCMan);</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> menu = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//打开系统服务控制器</span></span><br><span class="line">	SC_HANDLE SCMan = OpenSCManager(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ENUMERATE_SERVICE);</span><br><span class="line">	<span class="keyword">if</span>(SCMan == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; GetLastError() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"OpenSCManager Eorror/n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//保存系统服务的结构</span></span><br><span class="line">	LPENUM_SERVICE_STATUSA service_status;</span><br><span class="line">	DWORD cbBytesNeeded = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD ServicesReturned = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD ResumeHandle = <span class="literal">NULL</span>;</span><br><span class="line">	service_status = (LPENUM_SERVICE_STATUSA)LocalAlloc(LPTR, <span class="number">1024</span> * <span class="number">64</span>);</span><br><span class="line">	<span class="comment">//获取系统服务的简单信息</span></span><br><span class="line">	<span class="keyword">bool</span> ESS = EnumServicesStatusA(SCMan, <span class="comment">//系统服务句柄</span></span><br><span class="line">		SERVICE_WIN32, <span class="comment">//服务的类型</span></span><br><span class="line">		SERVICE_STATE_ALL,  <span class="comment">//服务的状态</span></span><br><span class="line">		(LPENUM_SERVICE_STATUSA)service_status,  <span class="comment">//输出参数，系统服务的结构</span></span><br><span class="line">		<span class="number">1024</span> * <span class="number">64</span>,  <span class="comment">//结构的大小</span></span><br><span class="line">		&amp;cbBytesNeeded, <span class="comment">//输出参数，接收返回所需的服务</span></span><br><span class="line">		&amp;ServicesReturned, <span class="comment">//输出参数，接收返回服务的数量</span></span><br><span class="line">		&amp;ResumeHandle); <span class="comment">//输入输出参数，第一次调用必须为0，返回为0代表成功</span></span><br><span class="line">	<span class="keyword">if</span>(ESS == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"EnumServicesStatus Eorror/n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ServicesReturned; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strstr</span>(service_status[i].lpDisplayName, <span class="string">"&lt;/span&gt;VirtualBox Guest"</span>)!=<span class="literal">NULL</span>)&lt;span style=<span class="string">"font-size:10px;"</span>&gt;</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//关闭服务管理器的句柄</span></span><br><span class="line">	CloseServiceHandle(SCMan);</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7、根据时间差"><a href="#7、根据时间差" class="headerlink" title="7、根据时间差"></a>7、根据时间差</h2><p>由于在虚拟机中，代码的运行速度通常不如真实主机。所以恶意代码通过运行一段特定的代码来比较这段代码在虚拟机和真实主机之中的相对运行时间，以此来判断是否处于虚拟机之中。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		rdtsc</span><br><span class="line">		xchg ebx,eax</span><br><span class="line">		rdtsc</span><br><span class="line">		sub eax,ebx</span><br><span class="line">		cmp eax,<span class="number">0xFF</span></span><br><span class="line">		jg detected</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">detected:</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualPC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		rdtsc</span><br><span class="line">		xchg ebx,eax</span><br><span class="line">		rdtsc</span><br><span class="line">		sub eax,ebx</span><br><span class="line">		cmp eax,<span class="number">0xFF</span></span><br><span class="line">		jg detected</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">detected:</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		rdtsc</span><br><span class="line">		xchg ebx,eax</span><br><span class="line">		rdtsc</span><br><span class="line">		sub eax,ebx</span><br><span class="line">		cmp eax,<span class="number">0xFF</span></span><br><span class="line">		jg detected</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">detected:</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="二、查找漏洞指令"><a href="#二、查找漏洞指令" class="headerlink" title="二、查找漏洞指令"></a>二、查找漏洞指令</h1><p>虚拟机监视器监视虚拟机的运行，它运行在宿主操作系统，并为客户机操作系统提供一个完整的虚拟平台。与此同时，虚拟机监视器也存在一些可以被恶意代码探测到虚拟化的安全缺陷。在内核模式下，VMware使用二进制翻译技术进行指令的模拟。运行于内核态的某些特权指令被解释和模拟，所以它们不在物理处理器上运行。相反，在用户模式下，代码直接在处理器上运行，几乎所有与硬件交互的指令，要么是特权指令，要么会产生内核态陷阱指令或中断指令。VMware截获所有中断并处理它们，以便虚拟机仍然认为这是一个正常机器。然而在x86体系结构中，一些指令在获取硬件相关的信息时并不产生异常，如sidt、sgdt、sldt、cpuid等等。为了正确虚拟这些指令，VMware需要在所有指令上进行二进制翻译，因此造成巨大的性能损失。为了避免执行全指令模拟造成的巨大性能损失，VMware允许一些特定指令在没有正确虚拟化的前提下运行。最终，这意味着某些指令序列在VMware虚拟机而不是在物理机中运行时返回不同的结果。处理器使用某些关键的结构与表，它们会被加载与真实系统不同的偏移量，而这正是未进行全虚拟化的副作用。中断描述表(IDT)是CPU内部的一个数据结构，操作系统使用它来确保正确响应中断和异常。在x86体系结构下，所有的内存获取，或是通过全局描述表(GDT)获得，或是通过本地描述表(LDT)获得。这些表中包含段描述符，它们提供每一个段的详细存取信息，其中包含段基地址类型、长度，以及存取权限等等。IDT、GDT和LDT是CPU内部的寄存器，它们分别存放着各自表的基地址和大小。有三条敏感指令(sidt、sgdt和sldt)可以读取这些表的位置，并且将相应的寄存器存入内存地址。因为这些指令可以随时被用户态代码调用，且不会产生陷阱，也未被VMware正确虚拟化，所以这些异常都可能被用来探测VMware的存在。</p>
<h2 id="1、使用Red-Pill反虚拟机技术"><a href="#1、使用Red-Pill反虚拟机技术" class="headerlink" title="1、使用Red Pill反虚拟机技术"></a>1、使用Red Pill反虚拟机技术</h2><p>Red Pill通过运行sidt指令获取IDTR寄存器的值。虚拟机监视器必须重新定位Guest系统的IDTR，来避免与Host系统的IDTR冲突。因为在虚拟机中运行sidt指令时，虚拟机监视器不会得到通知，所以会返回虚拟机的IDTR。Red Pill通过测试这种差异来探测Vmware的使用。这种方法存在一个缺陷，由于IDT的值只针对处于正在运行的处理器而言，在单CPU中它是个常量，但当它处于多CPU时就可能会受到影响了，因为每个CPU都有其自己的IDT，这样问题就自然而然的产生了。针对此问题，Offensive Computing组织成员提出了两种应对方法，其中一种方法就是利用Red Pill反复地在系统上循环执行任务，以此构造出一张当前系统的IDT值变化统计图，但这会增加CPU负担；另一种方法就是windows API函数SetThreadAffinityMask()将线程限制在单处理器上执行，当执行此测试时只能准确地将线程执行环境限制在本地处理器，而对于将线程限制在VM处理器上就可能行不通了，因为VM是计划在各处理器上运行的，VM线程在不同的处理器上执行时，IDT值将会发生变化，因此此方法也很少被使用。</p>
<h2 id="2、使用No-Pill反虚拟机技术"><a href="#2、使用No-Pill反虚拟机技术" class="headerlink" title="2、使用No Pill反虚拟机技术"></a>2、使用No Pill反虚拟机技术</h2><p>sgdt和sldt指令探测VMware的技术通常被称为No Pill。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG xdt = <span class="number">0</span> ;</span><br><span class="line">    ULONG InVM = <span class="number">0</span>;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        push edx</span><br><span class="line">        sidt [esp<span class="number">-2</span>]</span><br><span class="line">        pop edx</span><br><span class="line">        nop</span><br><span class="line">        mov xdt , edx</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (xdt &gt; <span class="number">0xd0000000</span>)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">​</span><br></pre></td></tr></table></figure>
<pre><code>InVM = 1;
</code></pre><p>}<br>else<br>{<br>    InVM = 0;<br>}<br>__asm<br>{<br>    push edx<br>    sgdt [esp-2]<br>    pop edx<br>    nop<br>    mov xdt , edx<br>}<br>if (xdt &gt; 0xd0000000)<br>{<br>    InVM += 1;<br>}<br>if (InVM == 0)<br>{<br>    return FALSE;<br>}<br>else<br>{<br>    return TRUE;<br>}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">通过禁用VMware加速可以防止No Pill技术的探测。</span><br><span class="line"></span><br><span class="line">## 3、查询I/O端口</span><br><span class="line"></span><br><span class="line">VMware使用虚拟化的I/O端口完成宿主系统与虚拟机之间的通信，以便支持诸如复制和粘贴功能。这个端口可以被查询，然后与一个神秘数比较，以确定VMware的使用。</span><br><span class="line">这种技术成功的关键在于x86体系结构中的in指令，它从一个源操作数指定的端口复制数据到目的操作数指定的内存地址。VMware会监视in指令的执行，并捕获目的通信端口为0x5668(VX)的I/O。VMware会检查第二个操作数是否是VX，在这种情况发生时，EAX寄存器载入的值是0x564D5868(VMXh)，ECX寄存器必须被载入你希望在端口上执行相应操作的值，值0xA表示get VMware version type，0x14代表get the memory size。它们都可以被用来探测VMware，但0xA更受欢迎，因为它能确定VMware的版本。如代码所示setz指令在magic数与VMXh匹配时设置返回值rc为1，如果在真实的机器上运行会触发EXCEPTION_EXECUTE_HANDLER异常，在异常处理中设置返回值rc为0。</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">BOOL CheckVMWare()</span><br><span class="line">&#123;</span><br><span class="line">	bool rc = true;</span><br><span class="line">	__try</span><br><span class="line">	&#123;</span><br><span class="line">		__asm</span><br><span class="line">		&#123;</span><br><span class="line">			push   edx</span><br><span class="line">			push   ecx</span><br><span class="line">			push   ebx</span><br><span class="line">			mov    eax, &apos;VMXh&apos;</span><br><span class="line">			mov    ebx, 0</span><br><span class="line">			mov    ecx, 10</span><br><span class="line">			mov    edx, &apos;VX&apos;</span><br><span class="line">			in     eax, dx</span><br><span class="line">			cmp    ebx, &apos;VMXh&apos;</span><br><span class="line">			setz   [rc]</span><br><span class="line">			pop    ebx</span><br><span class="line">			pop    ecx</span><br><span class="line">			pop    edx</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	__except(EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">	&#123;</span><br><span class="line">		rc = false;</span><br><span class="line">	&#125;</span><br><span class="line">	return rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对付这种反虚拟化技术的最简单方法是使用NOP指令替换in指令，或修补条件跳转，使得它不论比较结果如何，都执行到未探测到虚拟机的程序分支。</p>
<h2 id="4、使用str指令"><a href="#4、使用str指令" class="headerlink" title="4、使用str指令"></a>4、使用str指令</h2><p>在保护模式下运行的所有程序在切换任务时，对于当前任务中指向TSS的段选择器将会被存储在任务寄存器中，TSS中包含有当前任务的可执行环境状态，包括通用寄存器状态，段寄存器状态，标志寄存器状态，EIP寄存器状态等等，当此项任务再次被执行时，处理器就会其原先保存的任务状态。每项任务均有其自己的TSS，而我们可以通过STR指令来获取指向当前任务中TSS的段选择器。这里STR（Store task register）指令是用于将任务寄存器 (TR) 中的段选择器存储到目标操作数，目标操作数可以是通用寄存器或内存位置，使用此指令存储的段选择器指向当前正在运行的任务的任务状态段 (TSS)。在虚拟机和真实主机之中，通过STR读取的地址是不同的，当地址等于0x0040xxxx时，说明处于虚拟机中，否则为真实主机。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckVMWare</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> mem[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    __asm str mem;</span><br><span class="line">	<span class="keyword">if</span> ((mem[<span class="number">0</span>] == <span class="number">0x00</span>) &amp;&amp; (mem[<span class="number">1</span>] == <span class="number">0x40</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在IDA PRO中，可以使用下面的脚本查找我们前面提到的指令。</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> idautils import *</span><br><span class="line"><span class="keyword">from</span> idc import *</span><br><span class="line"></span><br><span class="line">heads = Heads(SegStart(ScreenEA()), SegEnd(ScreenEA()))</span><br><span class="line">antiVM = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> heads:</span><br><span class="line">	<span class="keyword">if</span> (GetMnem(i) == <span class="string">"sidt"</span> <span class="function">or <span class="title">GetMnem</span>(<span class="params">i</span>)</span> == <span class="string">"sgdt"</span> <span class="function">or <span class="title">GetMnem</span>(<span class="params">i</span>)</span> == <span class="string">"sldt"</span> <span class="function">or <span class="title">GetMnem</span>(<span class="params">i</span>)</span> == <span class="string">"smsw"</span> <span class="function">or <span class="title">GetMnem</span>(<span class="params">i</span>)</span> == <span class="string">"str"</span> <span class="function">or <span class="title">GetMnem</span>(<span class="params">i</span>)</span> == <span class="string">"in"</span> <span class="function">or <span class="title">GetMnem</span>(<span class="params">i</span>)</span> == <span class="string">"cpuid"</span>):</span><br><span class="line">		antiVM.append(i)</span><br><span class="line"></span><br><span class="line">print <span class="string">"Number of potential Anti-VM instructions: %d"</span> % (len(antiVM))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> antiVM:</span><br><span class="line">	SetColor(i, CIC_ITEM, <span class="number">0x0000ff</span>)</span><br><span class="line">	Message(<span class="string">"Anti-VM: %08x\n"</span> % i)</span><br></pre></td></tr></table></figure>
<p>要在IDA PRO中运行脚本，选择File-&gt;Script File，可以看到下面的输出。</p>
<p><img src="../res/20161019165025407.png" alt="img"></p>
<p>这个输出表明脚本检测到了三条漏洞指令类型。滚动到IDA PRO的反汇编窗口，我们看到三条红色高亮显示的指令sidt、str和sldt。</p>
<h2 id="5、使用无效的操作码"><a href="#5、使用无效的操作码" class="headerlink" title="5、使用无效的操作码"></a>5、使用无效的操作码</h2><p>每台机器都有一组定义的指令，通常称为指令集架构(Instruction Set Architecture)。当遇到无效指令(不存在于ISA中)时，机器引发无效操作码异常。软件可以处理异常(使用通常的try/catch机制)，也可以让操作系统处理异常，或者在最坏的情况下崩溃机器。VirtualPC使用一堆无效指令来允许虚拟机和VirtualPC之间连接。当VirtualPC的虚拟机想要与VirtualPC通信时，程序设置异常处理程序(try/catch块)，在调用VM软件之前设置所需的参数，发出特殊的无效操作码指令。VM软件将识别此无效操作码并相应地操作，如果VirtualPC存在则不引起异常，并且如果VirtualPC不存在则产生异常。最后，程序的catch块将处理异常并检查返回的VM软件的参数。总之，VirtualPC使用无效的操作码机制作为后门。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">IslnsideVPC_exceptionFilter</span><span class="params">(LPEXCEPTION_POINTERS ep)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PCONTEXT ctx=ep-&gt;ContextRecord;</span><br><span class="line">	ctx-&gt;Ebx = <span class="number">-1</span>; <span class="comment">//未运行在VPC中</span></span><br><span class="line">	ctx-&gt;Eip += <span class="number">4</span>; <span class="comment">//跳过”call VPC”操作</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CheckVirtualPC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> rc = TRUE;</span><br><span class="line">	__try</span><br><span class="line">	&#123;</span><br><span class="line">		__asm</span><br><span class="line">		&#123;</span><br><span class="line">			push ebx</span><br><span class="line">			mov ebx, <span class="number">0</span></span><br><span class="line">			mov eax, <span class="number">1</span></span><br><span class="line">			__emit <span class="number">0f</span>h</span><br><span class="line">			__emit <span class="number">3f</span>h</span><br><span class="line">			__emit <span class="number">07</span>h</span><br><span class="line">			__emit <span class="number">0b</span>h</span><br><span class="line">			test ebx, ebx</span><br><span class="line">			setz[rc]</span><br><span class="line">			pop ebx</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	__except(IslnsideVPC_exceptionFilter(GetExceptionInformation()))</span><br><span class="line">	&#123;</span><br><span class="line">		rc = FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="三、基于社会工程学的技巧"><a href="#三、基于社会工程学的技巧" class="headerlink" title="三、基于社会工程学的技巧"></a>三、基于社会工程学的技巧</h1><h2 id="1、检测电脑中常用软件的使用情况"><a href="#1、检测电脑中常用软件的使用情况" class="headerlink" title="1、检测电脑中常用软件的使用情况"></a>1、检测电脑中常用软件的使用情况</h2><p>名为Intelligent Software Solutions Inc.doc的恶意软件样本文件使用了下面的反虚拟机技巧，SHA256值为048fc07fb94a74990d2d2b8e92c099f3f986af185c32d74c857b07f7fcce7f8e。</p>
<p>RecentFiles对象表示系统最近打开过的历史文档。通常，安装了word程序的用户可能会打开超过2个或更多数量的文档。然而，当该恶意软件植入到新创建的虚拟机和word环境中后，总是状况不断，不能正常运行。每次测试时手动打开一两次，总是出现程序异常。即使是保存了虚拟机镜像状态，重启调试分析后，恶意程序仍然不能正常执行。从DKTxHE函数功能可以看出，恶意软件以RecentFiles数量来判断是否身处VM环境中，如果在VM环境中，它将不会执行任何恶意行为。之后，随意创建了3个不同名称的word文档，逐一打开并关闭，让历史文档数量为3，最终成功运行并检测到了恶意软件。</p>
<h2 id="2、探测杀毒软件公司相关的IP地址"><a href="#2、探测杀毒软件公司相关的IP地址" class="headerlink" title="2、探测杀毒软件公司相关的IP地址"></a>2、探测杀毒软件公司相关的IP地址</h2><p>同样是上面的恶意软件，它在另一个子程序中使用了下面的反虚拟机技巧。首先，它通过向远程地址<a href="https://www.maxmind.com/geoip/v2.1/city/me发出某种认证请求，之后设置请求信息中的HTTP" target="_blank" rel="noopener">https://www.maxmind.com/geoip/v2.1/city/me发出某种认证请求，之后设置请求信息中的HTTP</a> Refer属性和User-Agent值，访问链接<a href="https://www.maxmind.com/en/locate-my-ip-address以此获取宿主系统的地址信息。获取信息封装于JSON格式文件中，包含国家、城市、或者与IP相关的组织机构等信息。" target="_blank" rel="noopener">https://www.maxmind.com/en/locate-my-ip-address以此获取宿主系统的地址信息。获取信息封装于JSON格式文件中，包含国家、城市、或者与IP相关的组织机构等信息。</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"location"</span>: &#123;</span><br><span class="line">    <span class="attr">"latitude"</span>: <span class="number">30.7858</span>,</span><br><span class="line">    <span class="attr">"longitude"</span>: <span class="number">-102.1232</span>,</span><br><span class="line">    <span class="attr">"metro_code"</span>: <span class="number">705</span>,</span><br><span class="line">    <span class="attr">"accuracy_radius"</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"time_zone"</span>: <span class="string">"America/Los_Angeles"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"continent"</span>: &#123;</span><br><span class="line">    <span class="attr">"names"</span>: &#123;</span><br><span class="line">      <span class="attr">"ja"</span>: <span class="string">"北アメリカ"</span>,</span><br><span class="line">      <span class="attr">"pt-BR"</span>: <span class="string">"América do Norte"</span>,</span><br><span class="line">      <span class="attr">"de"</span>: <span class="string">"Nordamerika"</span>,</span><br><span class="line">      <span class="attr">"es"</span>: <span class="string">"Norteamérica"</span>,</span><br><span class="line">      <span class="attr">"ru"</span>: <span class="string">"Северная Америка"</span>,</span><br><span class="line">      <span class="attr">"fr"</span>: <span class="string">"Amérique du Nord"</span>,</span><br><span class="line">      <span class="attr">"zh-CN"</span>: <span class="string">"北美洲"</span>,</span><br><span class="line">      <span class="attr">"en"</span>: <span class="string">"North America"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"NA"</span>,</span><br><span class="line">    <span class="attr">"geoname_id"</span>: <span class="number">6255149</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"city"</span>: &#123;</span><br><span class="line">    <span class="attr">"names"</span>: &#123;</span><br><span class="line">      <span class="attr">"pt-BR"</span>: <span class="string">"Oakland"</span>,</span><br><span class="line">      <span class="attr">"de"</span>: <span class="string">"Oakland"</span>,</span><br><span class="line">      <span class="attr">"es"</span>: <span class="string">"Oakland"</span>,</span><br><span class="line">      <span class="attr">"ja"</span>: <span class="string">"オークランド"</span>,</span><br><span class="line">      <span class="attr">"en"</span>: <span class="string">"Oakland"</span>,</span><br><span class="line">      <span class="attr">"ru"</span>: <span class="string">"Окленд"</span>,</span><br><span class="line">      <span class="attr">"fr"</span>: <span class="string">"Oakland"</span>,</span><br><span class="line">      <span class="attr">"zh-CN"</span>: <span class="string">"奥克兰"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"geoname_id"</span>: <span class="number">5378538</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"postal"</span>: &#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"94619"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"country"</span>: &#123;</span><br><span class="line">    <span class="attr">"names"</span>: &#123;</span><br><span class="line">      <span class="attr">"ru"</span>: <span class="string">"США"</span>,</span><br><span class="line">      <span class="attr">"fr"</span>: <span class="string">"états-Unis"</span>,</span><br><span class="line">      <span class="attr">"zh-CN"</span>: <span class="string">"美国"</span>,</span><br><span class="line">      <span class="attr">"en"</span>: <span class="string">"United States"</span>,</span><br><span class="line">      <span class="attr">"ja"</span>: <span class="string">"アメリカ合衆国"</span>,</span><br><span class="line">      <span class="attr">"es"</span>: <span class="string">"Estados Unidos"</span>,</span><br><span class="line">      <span class="attr">"pt-BR"</span>: <span class="string">"Estados Unidos"</span>,</span><br><span class="line">      <span class="attr">"de"</span>: <span class="string">"USA"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"iso_code"</span>: <span class="string">"US"</span>,</span><br><span class="line">    <span class="attr">"geoname_id"</span>: <span class="number">6252001</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"traits"</span>: &#123;</span><br><span class="line">    <span class="attr">"organization"</span>: <span class="string">"Comcast Cable"</span>,</span><br><span class="line">    <span class="attr">"isp"</span>: <span class="string">"Comcast Cable"</span>,</span><br><span class="line">    <span class="attr">"ip_address"</span>: <span class="string">"123.123.123.123"</span>,</span><br><span class="line">    <span class="attr">"autonomous_system_organization"</span>: <span class="string">"Comcast Cable Communications, LLC"</span>,</span><br><span class="line">    <span class="attr">"domain"</span>: <span class="string">"comcast.net"</span>,</span><br><span class="line">    <span class="attr">"autonomous_system_number"</span>: <span class="number">7922</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"registered_country"</span>: &#123;</span><br><span class="line">    <span class="attr">"geoname_id"</span>: <span class="number">6252001</span>,</span><br><span class="line">    <span class="attr">"names"</span>: &#123;</span><br><span class="line">      <span class="attr">"zh-CN"</span>: <span class="string">"美国"</span>,</span><br><span class="line">      <span class="attr">"ru"</span>: <span class="string">"США"</span>,</span><br><span class="line">      <span class="attr">"fr"</span>: <span class="string">"états-Unis"</span>,</span><br><span class="line">      <span class="attr">"en"</span>: <span class="string">"United States"</span>,</span><br><span class="line">      <span class="attr">"ja"</span>: <span class="string">"アメリカ合衆国"</span>,</span><br><span class="line">      <span class="attr">"pt-BR"</span>: <span class="string">"Estados Unidos"</span>,</span><br><span class="line">      <span class="attr">"de"</span>: <span class="string">"USA"</span>,</span><br><span class="line">      <span class="attr">"es"</span>: <span class="string">"Estados Unidos"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"iso_code"</span>: <span class="string">"US"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"subdivisions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"geoname_id"</span>: <span class="number">5332921</span>,</span><br><span class="line">      <span class="attr">"names"</span>: &#123;</span><br><span class="line">        <span class="attr">"ru"</span>: <span class="string">"Калифорния"</span>,</span><br><span class="line">        <span class="attr">"fr"</span>: <span class="string">"Californie"</span>,</span><br><span class="line">        <span class="attr">"zh-CN"</span>: <span class="string">"加利福尼亚州"</span>,</span><br><span class="line">        <span class="attr">"en"</span>: <span class="string">"California"</span>,</span><br><span class="line">        <span class="attr">"ja"</span>: <span class="string">"カリフォルニア州"</span>,</span><br><span class="line">        <span class="attr">"pt-BR"</span>: <span class="string">"Califórnia"</span>,</span><br><span class="line">        <span class="attr">"es"</span>: <span class="string">"California"</span>,</span><br><span class="line">        <span class="attr">"de"</span>: <span class="string">"Kalifornien"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"iso_code"</span>: <span class="string">"CA"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在以上示例文件中，IP信息的organization字段显示为美国Comcast宽带网络供应商。恶意软件发出访问请求后，获取到宿主系统的相关信息将存储于某个数组中。如果获取到的组织机构名称与以下JSON文件中的任何机构字符串匹配，恶意软件将发生异常并停止运行。<br>Amazon<br>anonymous<br>BitDefender<br>BlackOakComputers<br>Blue Coat<br>BlueCoat<br>Cisco<br>cloud<br>Data Center<br>DataCenter<br>DataCentre<br>dedicated<br>ESET, Spol<br>FireEye<br>ForcePoint<br>Fortinet<br>Hetzner<br>hispeed.ch<br>hosted<br>Hosting<br>Iron Port<br>IronPort<br>LeaseWeb<br>MessageLabs<br>Microsoft<br>MimeCast<br>NForce<br>Ovh Sas<br>Palo Alto<br>ProofPoint<br>Rackspace<br>security<br>Server<br>Strong Technologies<br>Trend Micro<br>TrendMicro<br>TrustWave<br>VMVault<br>Zscaler<br>当然，上述列表中的机构名称在代码中是经过混淆的。</p>
<p><img src="../res/20161020232227265.png" alt="img"></p>
<h1 id="四、虚拟机逃逸"><a href="#四、虚拟机逃逸" class="headerlink" title="四、虚拟机逃逸"></a>四、虚拟机逃逸</h1><p>VMware等软件中或多或少都存在一些安全漏洞，可以利用这些漏洞使宿主操作系统崩溃或者是在宿主操作系统中运行代码。当主机系统被感染后，一些公开可用的工具可以用来对VMware等软件进行攻击。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>当遇到的恶意代码似乎不能运行时，在使用调试或反汇编恶意代码搜索其反虚拟机探测代码之前，应该考虑使用一个卸载了VMware Tools的虚拟机。VMware中有一些未文档化的功能可以帮助减轻反虚拟机技术的探测。将下面的代码放到VMware的.vmx文件中，以减轻虚拟机被探测的可能。<br>isolation.tools.getPtrLocation.disable = “TRUE”<br>isolation.tools.setPtrLocation.disable = “TRUE”<br>isolation.tools.setVersion.disable = “TRUE”<br>isolation.tools.getVersion.disable = “TRUE”<br>monitor_control.disable_directexec = “TRUE”<br>monitor_control.disable_chksimd = “TRUE”<br>monitor_control.disable_ntreloc = “TRUE”<br>monitor_control.disable_selfmod = “TRUE”<br>monitor_control.disable_reloc = “TRUE”<br>monitor_control.disable_btinout = “TRUE”<br>monitor_control.disable_btmemspace = “TRUE”<br>monitor_control.disable_btpriv = “TRUE”<br>monitor_control.disable_btseg = “TRUE”<br>参数directexec可以使用户模式下的代码被模拟执行而不是直接在硬件上运行，因此它可以挫败一些反虚拟机技术。前四条设置被VMware后门命令使用，它们的作用是使得运行在Guest系统中的VMware Tools不能获取宿主系统的信息。这些设置会禁用VMware Tools的一些有用功能，并可能对虚拟机性能有严重负面影响。所以，仅当其他技术无效时再添加这些选项。当然，也可以将恶意代码在其他虚拟环境或者物理主机上运行。同反调试技术一样，要想发现恶意代码中的反虚拟机技术需要在长期调试过程中积累更多经验。例如，看到一个代码在一个条件跳转处过早终止，这可能就是反虚拟机技术造成的结果。一如既往地警惕这种类型的问题，然后查看其之前的代码，来确定它到底执行了什么操作。和反调试技术一样，通过修改条件跳转指令或者使用NOP指令覆盖来绕过相关探测。<br>最后让我们总结一下提到的内容。腾讯2016游戏安全技术竞赛有一道题，大概意思就是给一个exe，要求编写一个Tencent2016C.dll，并导出多个接口函数 CheckVirtualPCX、CheckVMWareX、CheckVirtualBoxX。X为1-100之间的数字。函数功能是检测自己是否处于相应的虚拟机中，是返回TRUE，否则返回FALSE。</p>
<p>函数的原型都是<code>typedef BOOL (WINAPI* Type_CheckXXXXXX)();</code>。编译好dll之后，放在Tencent2016C.exe的同目录，运行Tencent2016C.exe，点击检测按钮，在物理机中运行时函数接口输出为0，在VMware虚拟机、VirtualBox虚拟机和VirtualPC虚拟机中运行时，相关的接口输出1。我们把提到的知识综合一下完成这道题目。</p>
<p>解题的参考代码和题目相关信息：<a href="https://github.com/houjingyi233/test-virtual-machine/" target="_blank" rel="noopener">https://github.com/houjingyi233/test-virtual-machine/</a></p>
<p>参考资料：《恶意代码分析实战》第17章反虚拟机技术、freebuf<a href="http://www.freebuf.com/articles/system/115556.html" target="_blank" rel="noopener">这个恶意软件“奇葩”的反虚拟机技巧</a>、<a href="http://www.buptdubhe.com/" target="_blank" rel="noopener">天枢战队官方博客</a>、看雪学院<a href="http://bbs.pediy.com/showthread.php?t=119969" target="_blank" rel="noopener">虚拟机检测技术剖析</a>、<a href="http://www.codeproject.com/Articles/9823/Detect-if-your-program-is-running-inside-a-Virtual" target="_blank" rel="noopener">Detect-if-your-program-is-running-inside-a-Virtual</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Windows/" rel="tag"># Windows</a>
              <a href="/tags/逆向/" rel="tag"># 逆向</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/数据库/使用Sqlplus动态执行SQL命令.html" rel="next" title="使用Sqlplus动态执行SQL命令">
                  <i class="fa fa-chevron-left"></i> 使用Sqlplus动态执行SQL命令
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/Windows/Windows反调试技术.html" rel="prev" title="Windows反调试技术">
                  Windows反调试技术 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、检测虚拟机痕迹"><span class="nav-number">1.</span> <span class="nav-text">一、检测虚拟机痕迹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、根据MAC地址"><span class="nav-number">1.1.</span> <span class="nav-text">1、根据MAC地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、基于主板序列号、主机型号、系统盘所在磁盘名称等其他硬件信息"><span class="nav-number">1.2.</span> <span class="nav-text">2、基于主板序列号、主机型号、系统盘所在磁盘名称等其他硬件信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、根据当前进程信息"><span class="nav-number">1.3.</span> <span class="nav-text">3、根据当前进程信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、根据特定的文件夹或文件信息"><span class="nav-number">1.4.</span> <span class="nav-text">4、根据特定的文件夹或文件信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、根据特定注册表信息"><span class="nav-number">1.5.</span> <span class="nav-text">5、根据特定注册表信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6、根据特定服务名"><span class="nav-number">1.6.</span> <span class="nav-text">6、根据特定服务名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7、根据时间差"><span class="nav-number">1.7.</span> <span class="nav-text">7、根据时间差</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、查找漏洞指令"><span class="nav-number">2.</span> <span class="nav-text">二、查找漏洞指令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、使用Red-Pill反虚拟机技术"><span class="nav-number">2.1.</span> <span class="nav-text">1、使用Red Pill反虚拟机技术</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、使用No-Pill反虚拟机技术"><span class="nav-number">2.2.</span> <span class="nav-text">2、使用No Pill反虚拟机技术</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、使用str指令"><span class="nav-number">2.3.</span> <span class="nav-text">4、使用str指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、使用无效的操作码"><span class="nav-number">2.4.</span> <span class="nav-text">5、使用无效的操作码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、基于社会工程学的技巧"><span class="nav-number">3.</span> <span class="nav-text">三、基于社会工程学的技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、检测电脑中常用软件的使用情况"><span class="nav-number">3.1.</span> <span class="nav-text">1、检测电脑中常用软件的使用情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、探测杀毒软件公司相关的IP地址"><span class="nav-number">3.2.</span> <span class="nav-text">2、探测杀毒软件公司相关的IP地址</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、虚拟机逃逸"><span class="nav-number">4.</span> <span class="nav-text">四、虚拟机逃逸</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Gowa2017 Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">331</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">136</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gowa2017" title="GitHub → https://github.com/gowa2017" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shouzheng.zhang@gmail.com" title="E-Mail → mailto:shouzheng.zhang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-json"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gowa2017 Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js"></script><script src="/js/algolia-search.js"></script>














  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://gowa-1.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://gowa.club/Windows/Windows反虚拟机技术.html",
            identifier: "Windows/Windows反虚拟机技术.html",
            title: "Windows反虚拟机技术"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://gowa-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    window.addEventListener('load', loadComments, false);
</script>

</body>
</html>
