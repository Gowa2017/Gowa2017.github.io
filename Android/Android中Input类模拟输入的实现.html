<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="退思园" type="application/atom+xml">
  <meta name="google-site-verification" content="EDvvZZUFkxy_QUzZTaqwsG_9VHqFthY-NhQE4j6WL-s">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: 'LHD9LWONQ3',
      apiKey: '23a113c49e36d8cc93f61239cb530b43',
      indexName: 'gowa.club',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="我们在用 adb 进行调试的时候，可以使用类似 adb shell input ... 的形式来进行模拟输入，输入的不止是文字，还可以是模拟按键等内容，我们来看一下其是如何实现的。我们已经看到了 InputService-安卓的输入系统 对 InputManagerService 是如何启动了。">
<meta name="keywords" content="Android,逆向,Android Input">
<meta property="og:type" content="article">
<meta property="og:title" content="Android中Input类模拟输入的实现">
<meta property="og:url" content="https://gowa.club/Android/Android中Input类模拟输入的实现.html">
<meta property="og:site_name" content="退思园">
<meta property="og:description" content="我们在用 adb 进行调试的时候，可以使用类似 adb shell input ... 的形式来进行模拟输入，输入的不止是文字，还可以是模拟按键等内容，我们来看一下其是如何实现的。我们已经看到了 InputService-安卓的输入系统 对 InputManagerService 是如何启动了。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-11-13T14:29:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android中Input类模拟输入的实现">
<meta name="twitter:description" content="我们在用 adb 进行调试的时候，可以使用类似 adb shell input ... 的形式来进行模拟输入，输入的不止是文字，还可以是模拟按键等内容，我们来看一下其是如何实现的。我们已经看到了 InputService-安卓的输入系统 对 InputManagerService 是如何启动了。">

<link rel="canonical" href="https://gowa.club/Android/Android中Input类模拟输入的实现.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Android中Input类模拟输入的实现 | 退思园</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137245514-1"></script>
    <script>
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-137245514-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">退思园</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">烦恼一般都是想太多了。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-soft">

    <a href="/soft/" rel="section"><i class="fa fa-fw fa-rocket"></i>soft</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input" id="search-input"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gowa.club/Android/Android中Input类模拟输入的实现.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Gowa2017 Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="退思园">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android中Input类模拟输入的实现
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-13 22:29:54" itemprop="dateCreated datePublished" datetime="2019-11-13T22:29:54+08:00">2019-11-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Android/Android中Input类模拟输入的实现.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Android/Android中Input类模拟输入的实现.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>我们在用 adb 进行调试的时候，可以使用类似 <code>adb shell input ...</code> 的形式来进行模拟输入，输入的不止是文字，还可以是模拟按键等内容，我们来看一下其是如何实现的。我们已经看到了 <a href="/Android/InputService-安卓的输入系统.html" title="InputService-安卓的输入系统">InputService-安卓的输入系统</a> 对 InputManagerService 是如何启动了。</p>
<a id="more"></a>
<p>input 命令，本身是一个 shell 脚本，位于 /system/bin/input ，打开可以看到其内容非常的简单，通过 app_process 命令启动了一个类而已。<strong>com.android.commands.input.Input</strong> 在 SDK 内有，但是并不是公开的类，所以需要自己想办法查看后使用。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">base=/system</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$base</span>/framework/input.jar</span><br><span class="line"><span class="built_in">exec</span> app_process <span class="variable">$base</span>/bin com.android.commands.input.Input <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure>
<p>那么，这个过程到底是怎么样的呢？我们在 <a href="/Android/InputService-安卓的输入系统.html" title="InputService-安卓的输入系统">InputService-安卓的输入系统</a> 一文中曾经介绍过系统的启动流程，我们的 Zygote 也是用这个命令来进行启动的。其启动的参数如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</span><br></pre></td></tr></table></figure>
<p>而我们的 input 是不带任何参数，只传递了一个类名，这个过程就要简单一些了。</p>
<h1 id="app-process-main"><a href="#app-process-main" class="headerlink" title="app_process.main"></a>app_process.main</h1><p>通过对参数的解析，app_process 来进行不同的启动模式。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        zygote = <span class="literal">true</span>;</span><br><span class="line">        niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        startSystemServer = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        application = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">    <span class="comment">// 解析出要启动的类名</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        className.setTo(arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        --i;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Vector&lt;String8&gt; args;</span><br><span class="line"><span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">    <span class="comment">// We're not in zygote mode, the only argument we need to pass</span></span><br><span class="line">    <span class="comment">// to RuntimeInit is the application argument.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The Remainder of args get passed to startup class main(). Make</span></span><br><span class="line">    <span class="comment">// copies of them before we overwrite them with the process name.</span></span><br><span class="line">    args.add(application ? String8(<span class="string">"application"</span>) : String8(<span class="string">"tool"</span>));</span><br><span class="line">    runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!LOG_NDEBUG) &#123;</span><br><span class="line">      String8 restOfArgs;</span><br><span class="line">      <span class="keyword">char</span>* <span class="keyword">const</span>* argv_new = argv + i;</span><br><span class="line">      <span class="keyword">int</span> argc_new = argc - i;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; argc_new; ++k) &#123;</span><br><span class="line">        restOfArgs.append(<span class="string">"\""</span>);</span><br><span class="line">        restOfArgs.append(argv_new[k]);</span><br><span class="line">        restOfArgs.append(<span class="string">"\" "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      ALOGV(<span class="string">"Class name = %s, args = %s"</span>, className.<span class="built_in">string</span>(), restOfArgs.<span class="built_in">string</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// systemserver 的参数逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">    runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line"><span class="comment">// 最终我们会执行到这里。</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">    runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">    app_usage();</span><br><span class="line">    LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们知道，app_process 会构造一个 AppRuntime(AndroidRuntime)，然后在这个运行环境中启动相关的类，调用启动类的 main() 方法。在我们启动 input 命令的时候，实际上调用  <code>AppRuntime.setClassNameAndArgs()</code> 已经设置了要启动的内容。</p>
<h1 id="RuntimeInit-main"><a href="#RuntimeInit-main" class="headerlink" title="RuntimeInit.main()"></a>RuntimeInit.main()</h1><p>安卓运行时的启动。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">    enableDdms();</span><br><span class="line">    <span class="keyword">if</span> (argv.length == <span class="number">2</span> &amp;&amp; argv[<span class="number">1</span>].equals(<span class="string">"application"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application"</span>);</span><br><span class="line">        redirectLogStreams();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting tool"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    commonInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Now that we're running in interpreted code, call back into native code</span></span><br><span class="line"><span class="comment">     * to run the system.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    nativeFinishInit();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Leaving RuntimeInit!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当 Java 层面调用完 <code>commonInit()</code> 后，那么就会在 AndroidRuntime 内进行初始化了。</p>
<h1 id="nativeFinishInit"><a href="#nativeFinishInit" class="headerlink" title="nativeFinishInit()"></a>nativeFinishInit()</h1><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">com_android_internal_os_RuntimeInit_nativeFinishInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gCurRuntime-&gt;onStarted();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">com_android_internal_os_ZygoteInit_nativeZygoteInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gCurRuntime-&gt;onZygoteInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而这两个虚函数，是在我们的 AppRuntime 内实现的。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">    ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">    proc-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">    AndroidRuntime* ar = AndroidRuntime::getRuntime();</span><br><span class="line">    ar-&gt;callMain(mClassName, mClass, mArgs);</span><br><span class="line"></span><br><span class="line">    IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">    hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">    ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">    proc-&gt;startThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里就直接通过JNI 反射，调用我们的要启动的类的 main 方法：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">status_t</span> AndroidRuntime::callMain(<span class="keyword">const</span> String8&amp; className, jclass clazz,</span><br><span class="line">    <span class="keyword">const</span> Vector&lt;String8&gt;&amp; args)</span><br><span class="line">&#123;</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    jmethodID methodId;</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"Calling main entry %s"</span>, className.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    env = getJNIEnv();</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span> || env == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    methodId = env-&gt;GetStaticMethodID(clazz, <span class="string">"main"</span>, <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">    <span class="keyword">if</span> (methodId == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"ERROR: could not find method %s.main(String[])\n"</span>, className.<span class="built_in">string</span>());</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We want to call main() with a String array with our arguments in it.</span></span><br><span class="line"><span class="comment">     * Create an array and populate it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> numArgs = args.size();</span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">    strArray = env-&gt;NewObjectArray(numArgs, stringClass, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; numArgs; i++) &#123;</span><br><span class="line">        jstring argStr = env-&gt;NewStringUTF(args[i].<span class="built_in">string</span>());</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i, argStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    env-&gt;CallStaticVoidMethod(clazz, methodId, strArray);</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="com-android-commands-input-Input"><a href="#com-android-commands-input-Input" class="headerlink" title="com.android.commands.input.Input"></a>com.android.commands.input.Input</h1><p>在这里就会构造出对应的命令了，包括 source，command，等了，根据命令的不同，来执行不同的方法。</p>
<p>回顾之前我们的过程，其实就是开启一个进程，然后打开 AndroidRuntime，然后在这运行时里面执行我们指定类的 main 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Command-line entry point.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args The command-line arguments</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    (<span class="keyword">new</span> Input()).run(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        showUsage();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    String command = args[index];</span><br><span class="line">    <span class="keyword">int</span> inputSource = InputDevice.SOURCE_UNKNOWN;</span><br><span class="line">    <span class="keyword">if</span> (SOURCES.containsKey(command)) &#123;</span><br><span class="line">        inputSource = SOURCES.get(command);</span><br><span class="line">        index++;</span><br><span class="line">        command = args[index];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> length = args.length - index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (command.equals(<span class="string">"text"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (length == <span class="number">2</span>) &#123;</span><br><span class="line">                inputSource = getSource(inputSource, InputDevice.SOURCE_KEYBOARD);</span><br><span class="line">                sendText(inputSource, args[index+<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"keyevent"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> longpress = <span class="string">"--longpress"</span>.equals(args[index + <span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> start = longpress ? index + <span class="number">2</span> : index + <span class="number">1</span>;</span><br><span class="line">                inputSource = getSource(inputSource, InputDevice.SOURCE_KEYBOARD);</span><br><span class="line">                <span class="keyword">if</span> (args.length &gt; start) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; args.length; i++) &#123;</span><br><span class="line">                        <span class="keyword">int</span> keyCode = KeyEvent.keyCodeFromString(args[i]);</span><br><span class="line">                        <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_UNKNOWN) &#123;</span><br><span class="line">                            keyCode = KeyEvent.keyCodeFromString(<span class="string">"KEYCODE_"</span> + args[i]);</span><br><span class="line">                        &#125;</span><br><span class="line">                        sendKeyEvent(inputSource, keyCode, longpress);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"tap"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (length == <span class="number">3</span>) &#123;</span><br><span class="line">                inputSource = getSource(inputSource, InputDevice.SOURCE_TOUCHSCREEN);</span><br><span class="line">                sendTap(inputSource, Float.parseFloat(args[index+<span class="number">1</span>]),</span><br><span class="line">                        Float.parseFloat(args[index+<span class="number">2</span>]));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"swipe"</span>)) &#123;</span><br><span class="line">            <span class="keyword">int</span> duration = -<span class="number">1</span>;</span><br><span class="line">            inputSource = getSource(inputSource, InputDevice.SOURCE_TOUCHSCREEN);</span><br><span class="line">            <span class="keyword">switch</span> (length) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    duration = Integer.parseInt(args[index+<span class="number">5</span>]);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    sendSwipe(inputSource,</span><br><span class="line">                            Float.parseFloat(args[index+<span class="number">1</span>]), Float.parseFloat(args[index+<span class="number">2</span>]),</span><br><span class="line">                            Float.parseFloat(args[index+<span class="number">3</span>]), Float.parseFloat(args[index+<span class="number">4</span>]),</span><br><span class="line">                            duration);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"draganddrop"</span>)) &#123;</span><br><span class="line">            <span class="keyword">int</span> duration = -<span class="number">1</span>;</span><br><span class="line">            inputSource = getSource(inputSource, InputDevice.SOURCE_TOUCHSCREEN);</span><br><span class="line">            <span class="keyword">switch</span> (length) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    duration = Integer.parseInt(args[index+<span class="number">5</span>]);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    sendDragAndDrop(inputSource,</span><br><span class="line">                            Float.parseFloat(args[index+<span class="number">1</span>]), Float.parseFloat(args[index+<span class="number">2</span>]),</span><br><span class="line">                            Float.parseFloat(args[index+<span class="number">3</span>]), Float.parseFloat(args[index+<span class="number">4</span>]),</span><br><span class="line">                            duration);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"press"</span>)) &#123;</span><br><span class="line">            inputSource = getSource(inputSource, InputDevice.SOURCE_TRACKBALL);</span><br><span class="line">            <span class="keyword">if</span> (length == <span class="number">1</span>) &#123;</span><br><span class="line">                sendTap(inputSource, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"roll"</span>)) &#123;</span><br><span class="line">            inputSource = getSource(inputSource, InputDevice.SOURCE_TRACKBALL);</span><br><span class="line">            <span class="keyword">if</span> (length == <span class="number">3</span>) &#123;</span><br><span class="line">                sendMove(inputSource, Float.parseFloat(args[index+<span class="number">1</span>]),</span><br><span class="line">                        Float.parseFloat(args[index+<span class="number">2</span>]));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">"Error: Unknown command: "</span> + command);</span><br><span class="line">            showUsage();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    System.err.println(INVALID_ARGUMENTS + command);</span><br><span class="line">    showUsage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="sendText"><a href="#sendText" class="headerlink" title="sendText"></a>sendText</h2><p>这个方法实际上是将我们要发送的字符串转换成虚拟按键对应的按键码发送过去。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert the characters of string text into key event's and send to</span></span><br><span class="line"><span class="comment"> * device.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text is a string of characters you want to input to the device.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendText</span><span class="params">(<span class="keyword">int</span> source, String text)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    StringBuffer buff = <span class="keyword">new</span> StringBuffer(text);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> escapeFlag = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;buff.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (escapeFlag) &#123;</span><br><span class="line">            escapeFlag = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (buff.charAt(i) == <span class="string">'s'</span>) &#123;</span><br><span class="line">                buff.setCharAt(i, <span class="string">' '</span>);</span><br><span class="line">                buff.deleteCharAt(--i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (buff.charAt(i) == <span class="string">'%'</span>) &#123;</span><br><span class="line">            escapeFlag = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>[] chars = buff.toString().toCharArray();</span><br><span class="line"></span><br><span class="line">    KeyCharacterMap kcm = KeyCharacterMap.load(KeyCharacterMap.VIRTUAL_KEYBOARD);</span><br><span class="line">    KeyEvent[] events = kcm.getEvents(chars);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; events.length; i++) &#123;</span><br><span class="line">        KeyEvent e = events[i];</span><br><span class="line">        <span class="keyword">if</span> (source != e.getSource()) &#123;</span><br><span class="line">            e.setSource(source);</span><br><span class="line">        &#125;</span><br><span class="line">        injectKeyEvent(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="InputManager-与-InputManagerService"><a href="#InputManager-与-InputManagerService" class="headerlink" title="InputManager 与 InputManagerService"></a>InputManager 与 InputManagerService</h2><p>InputManager   用来获取 输入设备的信息以及可用的键盘布局。</p>
<p>而 InputManagerService 是对 C 层的 InputManagerService 的一个包装，提供了服务的回调。其实现 了 InputManager  需要的 IInputManager 接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InputManagerService</span> <span class="keyword">extends</span> <span class="title">IInputManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"InputManager"</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="injectKeyEvent"><a href="#injectKeyEvent" class="headerlink" title="injectKeyEvent"></a>injectKeyEvent</h2><p>实际上，下面的代码中，会获取到 InputManagerService </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">injectKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</span><br><span class="line">    Log.i(TAG, <span class="string">"injectKeyEvent: "</span> + event);</span><br><span class="line">    InputManager.getInstance().injectInputEvent(event,</span><br><span class="line">            InputManager.INJECT_INPUT_EVENT_MODE_WAIT_FOR_FINISH);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Injects an input event into the event system on behalf of an application.</span></span><br><span class="line"><span class="comment"> * The synchronization mode determines whether the method blocks while waiting for</span></span><br><span class="line"><span class="comment"> * input injection to proceed.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Requires &#123;<span class="doctag">@link</span> android.Manifest.permission.INJECT_EVENTS&#125; to inject into</span></span><br><span class="line"><span class="comment"> * windows that are owned by other applications.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;&lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Make sure you correctly set the event time and input source of the event</span></span><br><span class="line"><span class="comment"> * before calling this method.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> event The event to inject.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mode The synchronization mode.  One of:</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #INJECT_INPUT_EVENT_MODE_ASYNC&#125;,</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #INJECT_INPUT_EVENT_MODE_WAIT_FOR_RESULT&#125;, or</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #INJECT_INPUT_EVENT_MODE_WAIT_FOR_FINISH&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> True if input event injection succeeded.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">injectInputEvent</span><span class="params">(InputEvent event, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"event must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mode != INJECT_INPUT_EVENT_MODE_ASYNC</span><br><span class="line">            &amp;&amp; mode != INJECT_INPUT_EVENT_MODE_WAIT_FOR_FINISH</span><br><span class="line">            &amp;&amp; mode != INJECT_INPUT_EVENT_MODE_WAIT_FOR_RESULT) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"mode is invalid"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mIm.injectInputEvent(event, mode);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里用到了 InputManager 这个类来进行初步的注入流程，最终还是通过 InputManagerService 来实现的。</p>
<h3 id="InputManager"><a href="#InputManager" class="headerlink" title="InputManager"></a>InputManager</h3><p>这段代码看起来有点难懂，关键在于理解 IInputManager 到底是什么。通过 ServiceManager 获得 INPUT_SERVICE 的 Binder，然后构造 InputManager。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ServiceManager.getServiceOrThrow(Context.INPUT_SERVICE)</span><br></pre></td></tr></table></figure>
<p>会返回一个 IBinder，然后将此 IBinder 作为 IInputManager  的实现，进而交给 InputManager 进行引用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InputManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (InputManager<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sInstance = <span class="keyword">new</span> InputManager(IInputManager.Stub</span><br><span class="line">                        .asInterface(ServiceManager.getServiceOrThrow(Context.INPUT_SERVICE)));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServiceNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IInputManager"><a href="#IInputManager" class="headerlink" title="IInputManager"></a>IInputManager</h3><p>这是一个 AIDL 定义的接口 其是，具体文档参考 <a href="https://developer.android.com/guide/components/aidl" target="_blank" rel="noopener">https://developer.android.com/guide/components/aidl</a>。</p>
<blockquote>
<p>Android SDK 工具会生成以 <code>.aidl</code> 文件命名的 <code>.java</code> 接口文件。生成的接口包含一个名为 <code>Stub</code> 的子类（例如，<code>YourInterface.Stub</code>），该子类是其父接口的抽象实现，并且会声明 <code>.aidl</code> 文件中的所有方法</p>
<p><strong>注意：</strong><code>Stub</code> 还会定义几个辅助方法，其中最值得注意的是 <code>asInterface()</code>，该方法会接收 <code>IBinder</code>（通常是传递给客户端 <code>onServiceConnected()</code> 回调方法的参数），并返回 Stub 接口的实例。如需了解如何进行此转换的更多详情，请参阅<a href="https://developer.android.com/guide/components/aidl#Calling" target="_blank" rel="noopener">调用 IPC 方法</a>部分。</p>
</blockquote>
<p>我们可以理解，InputManager 获得的底层是引用 InputManagerService 的 Binder 进行处理的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/ServiceManager.java</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a reference to a service with the given name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the service to get</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a reference to the service, or &lt;code&gt;null&lt;/code&gt; if the service doesn't exist</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            IBinder service = sCache.get(name);</span><br><span class="line">            <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> service;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Binder.allowBlocking(rawGetService(name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"error in getService"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="InputManagerService-injectInputEvent"><a href="#InputManagerService-injectInputEvent" class="headerlink" title="InputManagerService.injectInputEvent()"></a>InputManagerService.injectInputEvent()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/input/InputManagerService.java</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// Binder call</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">injectInputEvent</span><span class="params">(InputEvent event, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> injectInputEventInternal(event, Display.DEFAULT_DISPLAY, mode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">injectInputEventInternal</span><span class="params">(InputEvent event, <span class="keyword">int</span> displayId, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"event must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mode != InputManager.INJECT_INPUT_EVENT_MODE_ASYNC</span><br><span class="line">                &amp;&amp; mode != InputManager.INJECT_INPUT_EVENT_MODE_WAIT_FOR_FINISH</span><br><span class="line">                &amp;&amp; mode != InputManager.INJECT_INPUT_EVENT_MODE_WAIT_FOR_RESULT) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"mode is invalid"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = nativeInjectInputEvent(mPtr, event, displayId, pid, uid, mode,</span><br><span class="line">                    INJECTION_TIMEOUT_MILLIS, WindowManagerPolicy.FLAG_DISABLE_KEY_REPEAT);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (result) &#123;</span><br><span class="line">            <span class="keyword">case</span> INPUT_EVENT_INJECTION_PERMISSION_DENIED:</span><br><span class="line">                Slog.w(TAG, <span class="string">"Input event injection from pid "</span> + pid + <span class="string">" permission denied."</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                        <span class="string">"Injecting to another application requires INJECT_EVENTS permission"</span>);</span><br><span class="line">            <span class="keyword">case</span> INPUT_EVENT_INJECTION_SUCCEEDED:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> INPUT_EVENT_INJECTION_TIMED_OUT:</span><br><span class="line">                Slog.w(TAG, <span class="string">"Input event injection from pid "</span> + pid + <span class="string">" timed out."</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">case</span> INPUT_EVENT_INJECTION_FAILED:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.w(TAG, <span class="string">"Input event injection from pid "</span> + pid + <span class="string">" failed."</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>不出意外，最终还是走到了 native 层去</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">nativeInjectInputEvent</span><span class="params">(JNIEnv* env, jclass <span class="comment">/* clazz */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong ptr, jobject inputEventObj, jint displayId, jint injectorPid, jint injectorUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint syncMode, jint timeoutMillis, jint policyFlags)</span> </span>&#123;</span><br><span class="line">    NativeInputManager* im = <span class="keyword">reinterpret_cast</span>&lt;NativeInputManager*&gt;(ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;IsInstanceOf(inputEventObj, gKeyEventClassInfo.clazz)) &#123;</span><br><span class="line">        KeyEvent keyEvent;</span><br><span class="line">        <span class="keyword">status_t</span> status = android_view_KeyEvent_toNative(env, inputEventObj, &amp; keyEvent);</span><br><span class="line">        <span class="keyword">if</span> (status) &#123;</span><br><span class="line">            jniThrowRuntimeException(env, <span class="string">"Could not read contents of KeyEvent object."</span>);</span><br><span class="line">            <span class="keyword">return</span> INPUT_EVENT_INJECTION_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (jint) im-&gt;getInputManager()-&gt;getDispatcher()-&gt;injectInputEvent(</span><br><span class="line">                &amp; keyEvent, displayId, injectorPid, injectorUid, syncMode, timeoutMillis,</span><br><span class="line">                <span class="keyword">uint32_t</span>(policyFlags));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (env-&gt;IsInstanceOf(inputEventObj, gMotionEventClassInfo.clazz)) &#123;</span><br><span class="line">        <span class="keyword">const</span> MotionEvent* motionEvent = android_view_MotionEvent_getNativePtr(env, inputEventObj);</span><br><span class="line">        <span class="keyword">if</span> (!motionEvent) &#123;</span><br><span class="line">            jniThrowRuntimeException(env, <span class="string">"Could not read contents of MotionEvent object."</span>);</span><br><span class="line">            <span class="keyword">return</span> INPUT_EVENT_INJECTION_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (jint) im-&gt;getInputManager()-&gt;getDispatcher()-&gt;injectInputEvent(</span><br><span class="line">                motionEvent, displayId, injectorPid, injectorUid, syncMode, timeoutMillis,</span><br><span class="line">                <span class="keyword">uint32_t</span>(policyFlags));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jniThrowRuntimeException(env, <span class="string">"Invalid input event type."</span>);</span><br><span class="line">        <span class="keyword">return</span> INPUT_EVENT_INJECTION_FAILED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键代码是通过  NativeInputManager 来获取到 InputDispacher，然后通过 InputDispathcer 进行事件的注入。</p>
<h3 id="InputDispatcher-injectInputEvent"><a href="#InputDispatcher-injectInputEvent" class="headerlink" title="InputDispatcher::injectInputEvent"></a>InputDispatcher::injectInputEvent</h3><p>在这里还会检测是否拥有注入权限，然后将事件封装为 EventEntry 然后放到 InputDispatcher 的队列当中去，等待 InputDispatcherThread 来进行分发事件过去。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/inputflinger/InputDispatcher.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int32_t</span> InputDispatcher::injectInputEvent(<span class="keyword">const</span> InputEvent* event, <span class="keyword">int32_t</span> displayId,</span><br><span class="line">        <span class="keyword">int32_t</span> injectorPid, <span class="keyword">int32_t</span> injectorUid, <span class="keyword">int32_t</span> syncMode, <span class="keyword">int32_t</span> timeoutMillis,</span><br><span class="line">        <span class="keyword">uint32_t</span> policyFlags) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_INBOUND_EVENT_DETAILS</span></span><br><span class="line">    ALOGD(<span class="string">"injectInputEvent - eventType=%d, injectorPid=%d, injectorUid=%d, "</span></span><br><span class="line">            <span class="string">"syncMode=%d, timeoutMillis=%d, policyFlags=0x%08x, displayId=%d"</span>,</span><br><span class="line">            event-&gt;getType(), injectorPid, injectorUid, syncMode, timeoutMillis, policyFlags,</span><br><span class="line">            displayId);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">nsecs_t</span> endTime = now() + milliseconds_to_nanoseconds(timeoutMillis);</span><br><span class="line"></span><br><span class="line">    policyFlags |= POLICY_FLAG_INJECTED;</span><br><span class="line">    <span class="keyword">if</span> (hasInjectionPermission(injectorPid, injectorUid)) &#123;</span><br><span class="line">        policyFlags |= POLICY_FLAG_TRUSTED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EventEntry* firstInjectedEntry;</span><br><span class="line">    EventEntry* lastInjectedEntry;</span><br><span class="line">    <span class="keyword">switch</span> (event-&gt;getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> AINPUT_EVENT_TYPE_KEY: &#123;</span><br><span class="line">        <span class="keyword">const</span> KeyEvent* keyEvent = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> KeyEvent*&gt;(event);</span><br><span class="line">        <span class="keyword">int32_t</span> action = keyEvent-&gt;getAction();</span><br><span class="line">        <span class="keyword">if</span> (! validateKeyEvent(action)) &#123;</span><br><span class="line">            <span class="keyword">return</span> INPUT_EVENT_INJECTION_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int32_t</span> flags = keyEvent-&gt;getFlags();</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; AKEY_EVENT_FLAG_VIRTUAL_HARD_KEY) &#123;</span><br><span class="line">            policyFlags |= POLICY_FLAG_VIRTUAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(policyFlags &amp; POLICY_FLAG_FILTERED)) &#123;</span><br><span class="line">            android::base::Timer t;</span><br><span class="line">            mPolicy-&gt;interceptKeyBeforeQueueing(keyEvent, <span class="comment">/*byref*/</span> policyFlags);</span><br><span class="line">            <span class="keyword">if</span> (t.duration() &gt; SLOW_INTERCEPTION_THRESHOLD) &#123;</span><br><span class="line">                ALOGW(<span class="string">"Excessive delay in interceptKeyBeforeQueueing; took %s ms"</span>,</span><br><span class="line">                        <span class="built_in">std</span>::to_string(t.duration().count()).c_str());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLock.lock();</span><br><span class="line">        firstInjectedEntry = <span class="keyword">new</span> KeyEntry(keyEvent-&gt;getEventTime(),</span><br><span class="line">                keyEvent-&gt;getDeviceId(), keyEvent-&gt;getSource(),</span><br><span class="line">                policyFlags, action, flags,</span><br><span class="line">                keyEvent-&gt;getKeyCode(), keyEvent-&gt;getScanCode(), keyEvent-&gt;getMetaState(),</span><br><span class="line">                keyEvent-&gt;getRepeatCount(), keyEvent-&gt;getDownTime());</span><br><span class="line">        lastInjectedEntry = firstInjectedEntry;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> AINPUT_EVENT_TYPE_MOTION: &#123;</span><br><span class="line">        <span class="keyword">const</span> MotionEvent* motionEvent = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> MotionEvent*&gt;(event);</span><br><span class="line">        <span class="keyword">int32_t</span> action = motionEvent-&gt;getAction();</span><br><span class="line">        <span class="keyword">size_t</span> pointerCount = motionEvent-&gt;getPointerCount();</span><br><span class="line">        <span class="keyword">const</span> PointerProperties* pointerProperties = motionEvent-&gt;getPointerProperties();</span><br><span class="line">        <span class="keyword">int32_t</span> actionButton = motionEvent-&gt;getActionButton();</span><br><span class="line">        <span class="keyword">if</span> (! validateMotionEvent(action, actionButton, pointerCount, pointerProperties)) &#123;</span><br><span class="line">            <span class="keyword">return</span> INPUT_EVENT_INJECTION_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(policyFlags &amp; POLICY_FLAG_FILTERED)) &#123;</span><br><span class="line">            <span class="keyword">nsecs_t</span> eventTime = motionEvent-&gt;getEventTime();</span><br><span class="line">            android::base::Timer t;</span><br><span class="line">            mPolicy-&gt;interceptMotionBeforeQueueing(eventTime, <span class="comment">/*byref*/</span> policyFlags);</span><br><span class="line">            <span class="keyword">if</span> (t.duration() &gt; SLOW_INTERCEPTION_THRESHOLD) &#123;</span><br><span class="line">                ALOGW(<span class="string">"Excessive delay in interceptMotionBeforeQueueing; took %s ms"</span>,</span><br><span class="line">                        <span class="built_in">std</span>::to_string(t.duration().count()).c_str());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLock.lock();</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">nsecs_t</span>* sampleEventTimes = motionEvent-&gt;getSampleEventTimes();</span><br><span class="line">        <span class="keyword">const</span> PointerCoords* samplePointerCoords = motionEvent-&gt;getSamplePointerCoords();</span><br><span class="line">        firstInjectedEntry = <span class="keyword">new</span> MotionEntry(*sampleEventTimes,</span><br><span class="line">                motionEvent-&gt;getDeviceId(), motionEvent-&gt;getSource(), policyFlags,</span><br><span class="line">                action, actionButton, motionEvent-&gt;getFlags(),</span><br><span class="line">                motionEvent-&gt;getMetaState(), motionEvent-&gt;getButtonState(),</span><br><span class="line">                motionEvent-&gt;getEdgeFlags(),</span><br><span class="line">                motionEvent-&gt;getXPrecision(), motionEvent-&gt;getYPrecision(),</span><br><span class="line">                motionEvent-&gt;getDownTime(), displayId,</span><br><span class="line">                <span class="keyword">uint32_t</span>(pointerCount), pointerProperties, samplePointerCoords,</span><br><span class="line">                motionEvent-&gt;getXOffset(), motionEvent-&gt;getYOffset());</span><br><span class="line">        lastInjectedEntry = firstInjectedEntry;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = motionEvent-&gt;getHistorySize(); i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">            sampleEventTimes += <span class="number">1</span>;</span><br><span class="line">            samplePointerCoords += pointerCount;</span><br><span class="line">            MotionEntry* nextInjectedEntry = <span class="keyword">new</span> MotionEntry(*sampleEventTimes,</span><br><span class="line">                    motionEvent-&gt;getDeviceId(), motionEvent-&gt;getSource(), policyFlags,</span><br><span class="line">                    action, actionButton, motionEvent-&gt;getFlags(),</span><br><span class="line">                    motionEvent-&gt;getMetaState(), motionEvent-&gt;getButtonState(),</span><br><span class="line">                    motionEvent-&gt;getEdgeFlags(),</span><br><span class="line">                    motionEvent-&gt;getXPrecision(), motionEvent-&gt;getYPrecision(),</span><br><span class="line">                    motionEvent-&gt;getDownTime(), displayId,</span><br><span class="line">                    <span class="keyword">uint32_t</span>(pointerCount), pointerProperties, samplePointerCoords,</span><br><span class="line">                    motionEvent-&gt;getXOffset(), motionEvent-&gt;getYOffset());</span><br><span class="line">            lastInjectedEntry-&gt;next = nextInjectedEntry;</span><br><span class="line">            lastInjectedEntry = nextInjectedEntry;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ALOGW(<span class="string">"Cannot inject event of type %d"</span>, event-&gt;getType());</span><br><span class="line">        <span class="keyword">return</span> INPUT_EVENT_INJECTION_FAILED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    InjectionState* injectionState = <span class="keyword">new</span> InjectionState(injectorPid, injectorUid);</span><br><span class="line">    <span class="keyword">if</span> (syncMode == INPUT_EVENT_INJECTION_SYNC_NONE) &#123;</span><br><span class="line">        injectionState-&gt;injectionIsAsync = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    injectionState-&gt;refCount += <span class="number">1</span>;</span><br><span class="line">    lastInjectedEntry-&gt;injectionState = injectionState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> needWake = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (EventEntry* entry = firstInjectedEntry; entry != <span class="literal">NULL</span>; ) &#123;</span><br><span class="line">        EventEntry* nextEntry = entry-&gt;next;</span><br><span class="line">        needWake |= enqueueInboundEventLocked(entry);</span><br><span class="line">        entry = nextEntry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLock.unlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">        mLooper-&gt;wake();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> injectionResult;</span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (syncMode == INPUT_EVENT_INJECTION_SYNC_NONE) &#123;</span><br><span class="line">            injectionResult = INPUT_EVENT_INJECTION_SUCCEEDED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                injectionResult = injectionState-&gt;injectionResult;</span><br><span class="line">                <span class="keyword">if</span> (injectionResult != INPUT_EVENT_INJECTION_PENDING) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">nsecs_t</span> remainingTimeout = endTime - now();</span><br><span class="line">                <span class="keyword">if</span> (remainingTimeout &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_INJECTION</span></span><br><span class="line">                    ALOGD(<span class="string">"injectInputEvent - Timed out waiting for injection result "</span></span><br><span class="line">                            <span class="string">"to become available."</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                    injectionResult = INPUT_EVENT_INJECTION_TIMED_OUT;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mInjectionResultAvailableCondition.waitRelative(mLock, remainingTimeout);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (injectionResult == INPUT_EVENT_INJECTION_SUCCEEDED</span><br><span class="line">                    &amp;&amp; syncMode == INPUT_EVENT_INJECTION_SYNC_WAIT_FOR_FINISHED) &#123;</span><br><span class="line">                <span class="keyword">while</span> (injectionState-&gt;pendingForegroundDispatches != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_INJECTION</span></span><br><span class="line">                    ALOGD(<span class="string">"injectInputEvent - Waiting for %d pending foreground dispatches."</span>,</span><br><span class="line">                            injectionState-&gt;pendingForegroundDispatches);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                    <span class="keyword">nsecs_t</span> remainingTimeout = endTime - now();</span><br><span class="line">                    <span class="keyword">if</span> (remainingTimeout &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_INJECTION</span></span><br><span class="line">                    ALOGD(<span class="string">"injectInputEvent - Timed out waiting for pending foreground "</span></span><br><span class="line">                            <span class="string">"dispatches to finish."</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                        injectionResult = INPUT_EVENT_INJECTION_TIMED_OUT;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    mInjectionSyncFinishedCondition.waitRelative(mLock, remainingTimeout);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        injectionState-&gt;release();</span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_INJECTION</span></span><br><span class="line">    ALOGD(<span class="string">"injectInputEvent - Finished with result %d.  "</span></span><br><span class="line">            <span class="string">"injectorPid=%d, injectorUid=%d"</span>,</span><br><span class="line">            injectionResult, injectorPid, injectorUid);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> injectionResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> InputDispatcher::hasInjectionPermission(<span class="keyword">int32_t</span> injectorPid, <span class="keyword">int32_t</span> injectorUid) &#123;</span><br><span class="line">    <span class="keyword">return</span> injectorUid == <span class="number">0</span></span><br><span class="line">            || mPolicy-&gt;checkInjectEventsPermissionNonReentrant(injectorPid, injectorUid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p> InputManagerService 是从 SystemServer 启动的，我们在一个新的进程中是如何获取到其 Binder 的呢？</p>
<p>事实上这和在进程进行启动的时候，打开了 binder 机制有关。</p>
<h1 id="AppRuntime"><a href="#AppRuntime" class="headerlink" title="AppRuntime"></a>AppRuntime</h1><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">       ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">       proc-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">       AndroidRuntime* ar = AndroidRuntime::getRuntime();</span><br><span class="line">       ar-&gt;callMain(mClassName, mClass, mArgs);</span><br><span class="line"></span><br><span class="line">       IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">       hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">       ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">       proc-&gt;startThreadPool();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在 AndroidRuntime 建立后都会回调这两个方法之一，然后建立 ProcessState 对象：</p>
<h1 id="ProcessState"><a href="#ProcessState" class="headerlink" title="ProcessState"></a>ProcessState</h1><p>这个会与 /dev/binder 驱动间建立联系，将自己的文件描述符映射过去。</p>
<h2 id="ProcessState-self"><a href="#ProcessState-self" class="headerlink" title="ProcessState::self()"></a>ProcessState::self()</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">sp&lt;ProcessState&gt; ProcessState::self()</span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(gProcessMutex);</span><br><span class="line">    <span class="keyword">if</span> (gProcess != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> gProcess;</span><br><span class="line">    &#125;</span><br><span class="line">    gProcess = <span class="keyword">new</span> ProcessState(<span class="string">"/dev/binder"</span>);</span><br><span class="line">    <span class="keyword">return</span> gProcess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ProcessState::ProcessState(<span class="keyword">const</span> <span class="keyword">char</span> *driver)</span><br><span class="line">    : mDriverName(String8(driver))</span><br><span class="line">    , mDriverFD(open_driver(driver))</span><br><span class="line">    , mVMStart(MAP_FAILED)</span><br><span class="line">    , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER)</span><br><span class="line">    , mThreadCountDecrement(PTHREAD_COND_INITIALIZER)</span><br><span class="line">    , mExecutingThreadsCount(<span class="number">0</span>)</span><br><span class="line">    , mMaxThreads(DEFAULT_MAX_BINDER_THREADS)</span><br><span class="line">    , mStarvationStartTimeMs(<span class="number">0</span>)</span><br><span class="line">    , mManagesContexts(<span class="literal">false</span>)</span><br><span class="line">    , mBinderContextCheckFunc(<span class="literal">NULL</span>)</span><br><span class="line">    , mBinderContextUserData(<span class="literal">NULL</span>)</span><br><span class="line">    , mThreadPoolStarted(<span class="literal">false</span>)</span><br><span class="line">    , mThreadPoolSeq(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDriverFD &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span></span><br><span class="line">        mVMStart = mmap(<span class="number">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (mVMStart == MAP_FAILED) &#123;</span><br><span class="line">            <span class="comment">// *sigh*</span></span><br><span class="line">            ALOGE(<span class="string">"Using %s failed: unable to mmap transaction memory.\n"</span>, mDriverName.c_str());</span><br><span class="line">            close(mDriverFD);</span><br><span class="line">            mDriverFD = <span class="number">-1</span>;</span><br><span class="line">            mDriverName.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mDriverFD &lt; <span class="number">0</span>, <span class="string">"Binder driver could not be opened.  Terminating."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">open_driver</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(driver, O_RDWR | O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> vers = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">status_t</span> result = ioctl(fd, BINDER_VERSION, &amp;vers);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Binder ioctl to obtain version failed: %s"</span>, strerror(errno));</span><br><span class="line">            close(fd);</span><br><span class="line">            fd = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span> || vers != BINDER_CURRENT_PROTOCOL_VERSION) &#123;</span><br><span class="line">          ALOGE(<span class="string">"Binder driver protocol(%d) does not match user space protocol(%d)! ioctl() return value: %d"</span>,</span><br><span class="line">                vers, BINDER_CURRENT_PROTOCOL_VERSION, result);</span><br><span class="line">            close(fd);</span><br><span class="line">            fd = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">size_t</span> maxThreads = DEFAULT_MAX_BINDER_THREADS;</span><br><span class="line">        result = ioctl(fd, BINDER_SET_MAX_THREADS, &amp;maxThreads);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Binder ioctl to set max threads failed: %s"</span>, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGW(<span class="string">"Opening '%s' failed: %s\n"</span>, driver, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ServiceManager"><a href="#ServiceManager" class="headerlink" title="ServiceManager"></a>ServiceManager</h1><p>我们所有通过 Binder 机制来通信的都会通过这个服务来进行，这个服务，是由 init 进程启动的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># init.rc</span><br><span class="line">    # Start essential services.</span><br><span class="line">    start servicemanager</span><br><span class="line">    start hwservicemanager</span><br><span class="line">    start vndservicemanager</span><br></pre></td></tr></table></figure>
<h2 id="service-manager-c"><a href="#service-manager-c" class="headerlink" title="service_manager.c"></a>service_manager.c</h2><p>这里面重要的是打开了 binder 驱动后，调用的 <code>binder_become_context_manager</code> 成为了整个 Binder 的上下文管理者，整个驱动只有一个。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/service_manager.c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span> *<span class="title">bs</span>;</span></span><br><span class="line">    <span class="keyword">union</span> selinux_callback cb;</span><br><span class="line">    <span class="keyword">char</span> *driver;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        driver = argv[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        driver = <span class="string">"/dev/binder"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bs = binder_open(driver, <span class="number">128</span>*<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">if</span> (!bs) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VENDORSERVICEMANAGER</span></span><br><span class="line">        ALOGW(<span class="string">"failed to open binder driver %s\n"</span>, driver);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            sleep(UINT_MAX);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        ALOGE(<span class="string">"failed to open binder driver %s\n"</span>, driver);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (binder_become_context_manager(bs)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"cannot become context manager (%s)\n"</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cb.func_audit = audit_callback;</span><br><span class="line">    selinux_set_callback(SELINUX_CB_AUDIT, cb);</span><br><span class="line">    cb.func_log = selinux_log_callback;</span><br><span class="line">    selinux_set_callback(SELINUX_CB_LOG, cb);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VENDORSERVICEMANAGER</span></span><br><span class="line">    sehandle = selinux_android_vendor_service_context_handle();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    sehandle = selinux_android_service_context_handle();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    selinux_status_open(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sehandle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"SELinux: Failed to acquire sehandle. Aborting.\n"</span>);</span><br><span class="line">        <span class="built_in">abort</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getcon(&amp;service_manager_context) != <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"SELinux: Failed to acquire service_manager context. Aborting.\n"</span>);</span><br><span class="line">        <span class="built_in">abort</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    binder_loop(bs, svcmgr_handler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ServiceManager-java"><a href="#ServiceManager-java" class="headerlink" title="ServiceManager.java"></a>ServiceManager.java</h2><p>这是一个单例服务，当我们添加或者注册服务时，需要找到C 层的 ServiceManager</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/os/ServiceManager.java</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sServiceManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> sServiceManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the service manager</span></span><br><span class="line">        sServiceManager = ServiceManagerNative</span><br><span class="line">                .asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));</span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ServiceManagerProxy"><a href="#ServiceManagerProxy" class="headerlink" title="ServiceManagerProxy"></a>ServiceManagerProxy</h3><p>上面的代码中 ServiceManagerNative 实际上会在拿到了 ServiceManager 的 Binder 后建立一个代理类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IServiceManager in =</span><br><span class="line">        (IServiceManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ServiceManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_util_Binder.cpp#977</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">android_os_BinderInternal_getContextObject</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::self()-&gt;getContextObject(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> javaObjectForIBinder(env, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/ProcessState.cpp#110</span></span><br><span class="line">sp&lt;IBinder&gt; ProcessState::getContextObject(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; <span class="comment">/*caller*/</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> getStrongProxyForHandle(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(<span class="keyword">int32_t</span> handle)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;IBinder&gt; result;</span><br><span class="line"></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">    handle_entry* e = lookupHandleLocked(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// We need to create a new BpBinder if there isn't currently one, OR we</span></span><br><span class="line">        <span class="comment">// are unable to acquire a weak reference on this current one.  See comment</span></span><br><span class="line">        <span class="comment">// in getWeakProxyForHandle() for more info about this.</span></span><br><span class="line">        IBinder* b = e-&gt;binder;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span> || !e-&gt;refs-&gt;attemptIncWeak(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (handle == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Special case for context manager...</span></span><br><span class="line">                <span class="comment">// The context manager is the only object for which we create</span></span><br><span class="line">                <span class="comment">// a BpBinder proxy without already holding a reference.</span></span><br><span class="line">                <span class="comment">// Perform a dummy transaction to ensure the context manager</span></span><br><span class="line">                <span class="comment">// is registered before we create the first local reference</span></span><br><span class="line">                <span class="comment">// to it (which will occur when creating the BpBinder).</span></span><br><span class="line">                <span class="comment">// If a local reference is created for the BpBinder when the</span></span><br><span class="line">                <span class="comment">// context manager is not present, the driver will fail to</span></span><br><span class="line">                <span class="comment">// provide a reference to the context manager, but the</span></span><br><span class="line">                <span class="comment">// driver API does not return status.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Note that this is not race-free if the context manager</span></span><br><span class="line">                <span class="comment">// dies while this code runs.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> add a driver API to wait for context manager, or</span></span><br><span class="line">                <span class="comment">// stop special casing handle 0 for context manager and add</span></span><br><span class="line">                <span class="comment">// a driver API to get a handle to the context manager with</span></span><br><span class="line">                <span class="comment">// proper reference counting.</span></span><br><span class="line"></span><br><span class="line">                Parcel data;</span><br><span class="line">                <span class="keyword">status_t</span> status = IPCThreadState::self()-&gt;transact(</span><br><span class="line">                        <span class="number">0</span>, IBinder::PING_TRANSACTION, data, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (status == DEAD_OBJECT)</span><br><span class="line">                   <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            b = BpBinder::create(handle);</span><br><span class="line">            e-&gt;binder = b;</span><br><span class="line">            <span class="keyword">if</span> (b) e-&gt;refs = b-&gt;getWeakRefs();</span><br><span class="line">            result = b;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This little bit of nastyness is to allow us to add a primary</span></span><br><span class="line">            <span class="comment">// reference to the remote proxy when this team doesn't have one</span></span><br><span class="line">            <span class="comment">// but another team is sending the handle to us.</span></span><br><span class="line">            result.force_set(b);</span><br><span class="line">            e-&gt;refs-&gt;decWeak(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里 handler = 0 表示要查找的是 ServiceManager 的句柄，那么就会查找到已经运行的ServiceManager 的，并建立一个代理 BpBinder。</p>
<h3 id="addService"><a href="#addService" class="headerlink" title="addService"></a>addService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Place a new <span class="doctag">@a</span> service called <span class="doctag">@a</span> name into the service</span></span><br><span class="line"><span class="comment"> * manager.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name the name of the new service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> service the service object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getIServiceManager().addService(name, service, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"error in addService"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本质上是调用的是 ServiceManagerProxy 的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service, <span class="keyword">boolean</span> allowIsolated)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">    data.writeString(name);</span><br><span class="line">    data.writeStrongBinder(service);</span><br><span class="line">    data.writeInt(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    mRemote.transact(ADD_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.recycle();</span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单l的说，就是像 servicemanager 的文件描述符里面写入数据。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_add_service</span><span class="params">(struct binder_state *bs, <span class="keyword">const</span> <span class="keyword">uint16_t</span> *s, <span class="keyword">size_t</span> len, <span class="keyword">uint32_t</span> handle,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">uid_t</span> uid, <span class="keyword">int</span> allow_isolated, <span class="keyword">uint32_t</span> dumpsys_priority, <span class="keyword">pid_t</span> spid)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ALOGI("add_service('%s',%x,%s) uid=%d\n", str8(s, len), handle,</span></span><br><span class="line">    <span class="comment">//        allow_isolated ? "allow_isolated" : "!allow_isolated", uid);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!handle || (len == <span class="number">0</span>) || (len &gt; <span class="number">127</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!svc_can_register(s, len, spid, uid)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"add_service('%s',%x) uid=%d - PERMISSION DENIED\n"</span>,</span><br><span class="line">             str8(s, len), handle, uid);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    si = find_svc(s, len);</span><br><span class="line">    <span class="keyword">if</span> (si) &#123;</span><br><span class="line">        <span class="keyword">if</span> (si-&gt;handle) &#123;</span><br><span class="line">            ALOGE(<span class="string">"add_service('%s',%x) uid=%d - ALREADY REGISTERED, OVERRIDE\n"</span>,</span><br><span class="line">                 str8(s, len), handle, uid);</span><br><span class="line">            svcinfo_death(bs, si);</span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        si = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*si) + (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (!si) &#123;</span><br><span class="line">            ALOGE(<span class="string">"add_service('%s',%x) uid=%d - OUT OF MEMORY\n"</span>,</span><br><span class="line">                 str8(s, len), handle, uid);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">        si-&gt;len = len;</span><br><span class="line">        <span class="built_in">memcpy</span>(si-&gt;name, s, (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        si-&gt;name[len] = <span class="string">'\0'</span>;</span><br><span class="line">        si-&gt;death.func = (<span class="keyword">void</span>*) svcinfo_death;</span><br><span class="line">        si-&gt;death.ptr = si;</span><br><span class="line">        si-&gt;allow_isolated = allow_isolated;</span><br><span class="line">        si-&gt;dumpsys_priority = dumpsys_priority;</span><br><span class="line">        si-&gt;next = svclist;</span><br><span class="line">        svclist = si;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binder_acquire(bs, handle);</span><br><span class="line">    binder_link_to_death(bs, handle, &amp;si-&gt;death);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/逆向/" rel="tag"># 逆向</a>
              <a href="/tags/Android-Input/" rel="tag"># Android Input</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/Lua/Lua中的协程.html" rel="next" title="Lua中的协程">
                  <i class="fa fa-chevron-left"></i> Lua中的协程
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/Cocos-Creator/Cocos-Creator安卓下的启动流程.html" rel="prev" title="Cocos-Creator安卓下的启动流程">
                  Cocos-Creator安卓下的启动流程 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#app-process-main"><span class="nav-number">1.</span> <span class="nav-text">app_process.main</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RuntimeInit-main"><span class="nav-number">2.</span> <span class="nav-text">RuntimeInit.main()</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nativeFinishInit"><span class="nav-number">3.</span> <span class="nav-text">nativeFinishInit()</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#com-android-commands-input-Input"><span class="nav-number">4.</span> <span class="nav-text">com.android.commands.input.Input</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#sendText"><span class="nav-number">4.1.</span> <span class="nav-text">sendText</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#InputManager-与-InputManagerService"><span class="nav-number">4.2.</span> <span class="nav-text">InputManager 与 InputManagerService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#injectKeyEvent"><span class="nav-number">4.3.</span> <span class="nav-text">injectKeyEvent</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#InputManager"><span class="nav-number">4.3.1.</span> <span class="nav-text">InputManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IInputManager"><span class="nav-number">4.3.2.</span> <span class="nav-text">IInputManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InputManagerService-injectInputEvent"><span class="nav-number">4.3.3.</span> <span class="nav-text">InputManagerService.injectInputEvent()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InputDispatcher-injectInputEvent"><span class="nav-number">4.3.4.</span> <span class="nav-text">InputDispatcher::injectInputEvent</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#问题"><span class="nav-number">5.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AppRuntime"><span class="nav-number">6.</span> <span class="nav-text">AppRuntime</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ProcessState"><span class="nav-number">7.</span> <span class="nav-text">ProcessState</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ProcessState-self"><span class="nav-number">7.1.</span> <span class="nav-text">ProcessState::self()</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ServiceManager"><span class="nav-number">8.</span> <span class="nav-text">ServiceManager</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#service-manager-c"><span class="nav-number">8.1.</span> <span class="nav-text">service_manager.c</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ServiceManager-java"><span class="nav-number">8.2.</span> <span class="nav-text">ServiceManager.java</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceManagerProxy"><span class="nav-number">8.2.1.</span> <span class="nav-text">ServiceManagerProxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#addService"><span class="nav-number">8.2.2.</span> <span class="nav-text">addService</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Gowa2017 Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">325</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">135</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gowa2017" title="GitHub → https://github.com/gowa2017" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shouzheng.zhang@gmail.com" title="E-Mail → mailto:shouzheng.zhang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-json"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gowa2017 Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js"></script><script src="/js/algolia-search.js"></script>














  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://gowa-1.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://gowa.club/Android/Android中Input类模拟输入的实现.html",
            identifier: "Android/Android中Input类模拟输入的实现.html",
            title: "Android中Input类模拟输入的实现"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://gowa-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    window.addEventListener('load', loadComments, false);
</script>

</body>
</html>
