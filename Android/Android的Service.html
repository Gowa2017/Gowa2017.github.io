<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="退思园" type="application/atom+xml">
  <meta name="google-site-verification" content="EDvvZZUFkxy_QUzZTaqwsG_9VHqFthY-NhQE4j6WL-s">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: 'LHD9LWONQ3',
      apiKey: '23a113c49e36d8cc93f61239cb530b43',
      indexName: 'gowa.club',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Service 是安卓的四大组件之一，其官方的介绍  https://developer.android.com/guide/components/services 上有一个应用上的介绍。但是，我想要的是从代码层面来看一下一个服务，是如何启动，如何提供服务的呢。">
<meta name="keywords" content="Android,Service">
<meta property="og:type" content="article">
<meta property="og:title" content="Android的Service">
<meta property="og:url" content="https://gowa.club/Android/Android的Service.html">
<meta property="og:site_name" content="退思园">
<meta property="og:description" content="Service 是安卓的四大组件之一，其官方的介绍  https://developer.android.com/guide/components/services 上有一个应用上的介绍。但是，我想要的是从代码层面来看一下一个服务，是如何启动，如何提供服务的呢。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-12-05T02:53:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android的Service">
<meta name="twitter:description" content="Service 是安卓的四大组件之一，其官方的介绍  https://developer.android.com/guide/components/services 上有一个应用上的介绍。但是，我想要的是从代码层面来看一下一个服务，是如何启动，如何提供服务的呢。">

<link rel="canonical" href="https://gowa.club/Android/Android的Service.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Android的Service | 退思园</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137245514-1"></script>
    <script>
      var host = window.location.hostname;
      if (host !== "localhost" || !true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-137245514-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">退思园</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">烦恼一般都是想太多了。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-soft">

    <a href="/soft/" rel="section"><i class="fa fa-fw fa-rocket"></i>soft</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input" id="search-input"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://gowa.club/Android/Android的Service.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Gowa2017 Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="退思园">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android的Service
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-05 10:53:36" itemprop="dateCreated datePublished" datetime="2019-12-05T10:53:36+08:00">2019-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Android/Android的Service.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Android/Android的Service.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Service 是安卓的四大组件之一，其官方的介绍  <a href="https://developer.android.com/guide/components/services" target="_blank" rel="noopener">https://developer.android.com/guide/components/services</a> 上有一个应用上的介绍。但是，我想要的是从代码层面来看一下一个服务，是如何启动，如何提供服务的呢。</p>
<a id="more"></a>
<h1 id="服务状态"><a href="#服务状态" class="headerlink" title="服务状态"></a>服务状态</h1><p>根据官方文档，服务会有两种状态：</p>
<ul>
<li>启动状态：以无限期运行</li>
<li>绑定状态：当应用组件通过调用 <code>bindService()</code> 绑定到服务时，服务即处于<em>绑定</em>状态。绑定服务会提供客户端-服务器接口，以便组件与服务进行交互、发送请求、接收结果，甚至是利用进程间通信 (IPC) 跨进程执行这些操作。仅当与另一个应用组件绑定时，绑定服务才会运行。多个组件可同时绑定到该服务，但全部取消绑定后，该服务即会被销毁。</li>
</ul>
<blockquote>
<p>无论服务是处于启动状态还是绑定状态（或同时处于这两种状态），任何应用组件均可像使用 Activity 那样，通过调用 <code>Intent</code> 来使用服务（即使此服务来自另一应用）。不过，您可以通过清单文件将服务声明为<em>私有</em>服务，并阻止其他应用访问该服务。<a href="https://developer.android.com/guide/components/services#Declaring" target="_blank" rel="noopener">使用清单文件声明服务</a>部分将对此做更详尽的阐述。</p>
<p><strong>注意：</strong>服务在其托管进程的主线程中运行，它既<strong>不</strong>创建自己的线程，也<strong>不</strong>在单独的进程中运行（除非另行指定）。如果服务将执行任何 CPU 密集型工作或阻止性操作（例如 MP3 播放或联网），则应通过在服务内创建新线程来完成这项工作。通过使用单独的线程，您可以降低发生“应用无响应”(ANR) 错误的风险，而应用的主线程仍可继续专注于运行用户与 Activity 之间的交互。</p>
</blockquote>
<p>服务处于什么状态，在于其是否实现了一组回调方法：</p>
<ul>
<li><code>onStartCommand()</code>（让组件启动服务）当另一个组件（如 Activity）请求启动服务时，系统会通过调用 <code>startService()</code> 来调用此方法。执行此方法时，服务即会启动并可在后台无限期运行。如果您实现此方法，则在服务工作完成后，您需负责通过调用 <code>stopSelf()</code> 或 <code>stopService()</code> 来停止服务。（如果您只想提供绑定，则无需实现此方法。）</li>
<li><code>onBind()</code>（实现服务绑定）。当另一个组件想要与服务绑定（例如执行 RPC）时，系统会通过调用 <code>bindService()</code> 来调用此方法。在此方法的实现中，您必须通过返回 <code>IBinder</code> 提供一个接口，以供客户端用来与服务进行通信。请务必实现此方法；但是，如果您并不希望允许绑定，则应返回 null。</li>
</ul>
<p>其他回调：</p>
<ul>
<li><code>onCreate()</code> 系统会（在调用 <code>onStartCommand()</code> 或 <code>onBind()</code> 之前）调用此方法来执行一次性设置程序。如果服务已在运行，则不会调用此方法。</li>
<li><code>onDestroy()</code> 当不再使用服务且准备将其销毁时，系统会调用此方法。服务应通过实现此方法来清理任何资源，如线程、注册的侦听器、接收器等。这是服务接收的最后一个调用。</li>
</ul>
<p>任何一个 Service 都是类  <strong>android.app.Service</strong> 的子类，所以我们可以从这个方面来看一下。任何 <strong>启动</strong> 服务，都是由另外一个组件调用  <code>startService()</code> 方法来实现的。比如我们在 Activity 里面启动一个服务。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, HelloService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">startService(intent);</span><br></pre></td></tr></table></figure>
<p>我们知道 Activity 继承于 Context ，而 Context 的实现在  ContextImpl 中，</p>
<h1 id="ContextImpl"><a href="#ContextImpl" class="headerlink" title="ContextImpl"></a>ContextImpl</h1><p>在这里需要注意 <code>mMainThread.getApplicationThread()</code>  这个代表了什么呢，这个是 IApplicationThread.Stub 的子类，ApplicationThread。而 mMainThread 代表的是 ActivityThread。</p>
<ul>
<li>ActivityThread 负责管理应用进程内主线程的执行，调度和执行 activities，广播 和其他 AMS （Activity Manager Service ）请求的操作。此线程也是运行在 SystemServer 内。</li>
<li>ApplicationThread 从表示上来看，其并不是一个线程对象，其更像是一个桥梁，用来将消息发往 ActivityThread 的 Handler 去。</li>
</ul>
<h2 id="startService"><a href="#startService" class="headerlink" title="startService"></a>startService</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line">    warnIfCallingFromSystemProcess(); <span class="comment">//如果是系统进程直接调用记录警告日志</span></span><br><span class="line">    <span class="keyword">return</span> startServiceCommon(service, <span class="keyword">false</span>, mUser); <span class="comment">// 不非前台服务启动</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ComponentName <span class="title">startServiceCommon</span><span class="params">(Intent service, <span class="keyword">boolean</span> requireForeground,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        validateServiceIntent(service); <span class="comment">// Service 在高版本上，必须是显式指定的，低版本上会记录警告日志</span></span><br><span class="line">        service.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line">     	<span class="comment">// 启动后会返回一个 ComponentName。</span></span><br><span class="line">      <span class="comment">// 利用 AMS 进行启动的</span></span><br><span class="line">        ComponentName cn = ActivityManager.getService().startService(</span><br><span class="line">            mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</span><br><span class="line">                        getContentResolver()), requireForeground,</span><br><span class="line">                        getOpPackageName(), user.getIdentifier());</span><br><span class="line">        <span class="keyword">if</span> (cn != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!"</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                        <span class="string">"Not allowed to start service "</span> + service</span><br><span class="line">                        + <span class="string">" without permission "</span> + cn.getClassName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!!"</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                        <span class="string">"Unable to start service "</span> + service</span><br><span class="line">                        + <span class="string">": "</span> + cn.getClassName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"?"</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                        <span class="string">"Not allowed to start service "</span> + service + <span class="string">": "</span> + cn.getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cn;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很不意外的，走到了 ActivityManager 来。最终是将 ActivityManagerService 的 Binder 引入了进来。</p>
<h1 id="ActivityManagerService"><a href="#ActivityManagerService" class="headerlink" title="ActivityManagerService"></a>ActivityManagerService</h1><p>这个使用 ActiveServices 来启动服务。我们知道 ，AMS 实际上是运行在 system-server 中的服务，所以这里面的 ActiveServices 代表了所有活跃的服务。</p>
<h2 id="startService-1"><a href="#startService-1" class="headerlink" title="startService"></a>startService</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(IApplicationThread caller, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">boolean</span> requireForeground, String callingPackage, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"startService"</span>);</span><br><span class="line">    <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">            <span class="string">"*** startService: "</span> + service + <span class="string">" type="</span> + resolvedType + <span class="string">" fg="</span> + requireForeground);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="comment">// 获取调用进程 pid 和 uid </span></span><br><span class="line">      <span class="comment">// 然后 userId 是存储在 userHandler 里面的 整型 id 数。</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        ComponentName res;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            res = mServices.startServiceLocked(caller, service,</span><br><span class="line">                    resolvedType, callingPid, callingUid,</span><br><span class="line">                    requireForeground, callingPackage, userId);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ActiveServices"><a href="#ActiveServices" class="headerlink" title="ActiveServices"></a>ActiveServices</h1><h2 id="startServiceLocked"><a href="#startServiceLocked" class="headerlink" title="startServiceLocked"></a>startServiceLocked</h2><p>这里面做的工作太多，我们简要说明就行了，首先通过 IApplicationThread caller 从 AMS 获取到对应的 APP 的进程记录。来决定是否需要进行前台启动。</p>
<p>接着通过  retrieveServiceLocked 来查看一下这个服务是否已经启动，如果没有启动，那么就会构建一个服务。然后调用 startServiceInnerLocked 进行下一步动作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceLocked</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">boolean</span> fgRequired, String callingPackage, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"startService: "</span> + service</span><br><span class="line">            + <span class="string">" type="</span> + resolvedType + <span class="string">" args="</span> + service.getExtras());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> callerFg;</span><br><span class="line">  	<span class="comment">// 调用方 app 线程不为 null</span></span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">      	<span class="comment">// 获取进程记录</span></span><br><span class="line">        <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                    <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                    + <span class="string">" (pid="</span> + callingPid</span><br><span class="line">                    + <span class="string">") when starting service "</span> + service);</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// 确定一下调用 app 是否是在前台的</span></span><br><span class="line">        callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        callerFg = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 查找 是否有已经启动的 Service 存在</span></span><br><span class="line">    ServiceLookupResult res =</span><br><span class="line">        retrieveServiceLocked(service, resolvedType, callingPackage,</span><br><span class="line">                callingPid, callingUid, userId, <span class="keyword">true</span>, callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (res.record == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!"</span>, res.permission != <span class="keyword">null</span></span><br><span class="line">                ? res.permission : <span class="string">"private to package"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ServiceRecord r = res.record;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mAm.mUserController.exists(r.userId)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Trying to start service with non-existent user! "</span> + r.userId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're starting indirectly (e.g. from PendingIntent), figure out whether</span></span><br><span class="line">    <span class="comment">// we're launching into an app in a background state.  This keys off of the same</span></span><br><span class="line">    <span class="comment">// idleness state tracking as e.g. O+ background service start policy.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> bgLaunch = !mAm.isUidActiveLocked(r.appInfo.uid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the app has strict background restrictions, we treat any bg service</span></span><br><span class="line">    <span class="comment">// start analogously to the legacy-app forced-restrictions case, regardless</span></span><br><span class="line">    <span class="comment">// of its target SDK version.</span></span><br><span class="line">    <span class="keyword">boolean</span> forcedStandby = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (bgLaunch &amp;&amp; appRestrictedAnyInBackground(r.appInfo.uid, r.packageName)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_FOREGROUND_SERVICE) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Forcing bg-only service start only for "</span> + r.shortName</span><br><span class="line">                    + <span class="string">" : bgLaunch="</span> + bgLaunch + <span class="string">" callerFg="</span> + callerFg);</span><br><span class="line">        &#125;</span><br><span class="line">        forcedStandby = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this is a direct-to-foreground start, make sure it is allowed as per the app op.</span></span><br><span class="line">    <span class="keyword">boolean</span> forceSilentAbort = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> mode = mAm.mAppOpsService.checkOperation(</span><br><span class="line">                AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName);</span><br><span class="line">        <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">            <span class="keyword">case</span> AppOpsManager.MODE_ALLOWED:</span><br><span class="line">            <span class="keyword">case</span> AppOpsManager.MODE_DEFAULT:</span><br><span class="line">                <span class="comment">// All okay.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AppOpsManager.MODE_IGNORED:</span><br><span class="line">                <span class="comment">// Not allowed, fall back to normal start service, failing siliently</span></span><br><span class="line">                <span class="comment">// if background check restricts that.</span></span><br><span class="line">                Slog.w(TAG, <span class="string">"startForegroundService not allowed due to app op: service "</span></span><br><span class="line">                        + service + <span class="string">" to "</span> + r.name.flattenToShortString()</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid + <span class="string">" uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" pkg="</span> + callingPackage);</span><br><span class="line">                fgRequired = <span class="keyword">false</span>;</span><br><span class="line">                forceSilentAbort = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!!"</span>, <span class="string">"foreground not allowed as per app op"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this isn't a direct-to-foreground start, check our ability to kick off an</span></span><br><span class="line">    <span class="comment">// arbitrary service</span></span><br><span class="line">    <span class="keyword">if</span> (forcedStandby || (!r.startRequested &amp;&amp; !fgRequired)) &#123;</span><br><span class="line">        <span class="comment">// Before going further -- if this app is not allowed to start services in the</span></span><br><span class="line">        <span class="comment">// background, then at this point we aren't going to let it period.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> allowed = mAm.getAppStartModeLocked(r.appInfo.uid, r.packageName,</span><br><span class="line">                r.appInfo.targetSdkVersion, callingPid, <span class="keyword">false</span>, <span class="keyword">false</span>, forcedStandby);</span><br><span class="line">        <span class="keyword">if</span> (allowed != ActivityManager.APP_START_MODE_NORMAL) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Background start not allowed: service "</span></span><br><span class="line">                    + service + <span class="string">" to "</span> + r.name.flattenToShortString()</span><br><span class="line">                    + <span class="string">" from pid="</span> + callingPid + <span class="string">" uid="</span> + callingUid</span><br><span class="line">                    + <span class="string">" pkg="</span> + callingPackage + <span class="string">" startFg?="</span> + fgRequired);</span><br><span class="line">            <span class="keyword">if</span> (allowed == ActivityManager.APP_START_MODE_DELAYED || forceSilentAbort) &#123;</span><br><span class="line">                <span class="comment">// In this case we are silently disabling the app, to disrupt as</span></span><br><span class="line">                <span class="comment">// little as possible existing apps.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (forcedStandby) &#123;</span><br><span class="line">                <span class="comment">// This is an O+ app, but we might be here because the user has placed</span></span><br><span class="line">                <span class="comment">// it under strict background restrictions.  Don't punish the app if it's</span></span><br><span class="line">                <span class="comment">// trying to do the right thing but we're denying it for that reason.</span></span><br><span class="line">                <span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_BACKGROUND_CHECK) &#123;</span><br><span class="line">                        Slog.v(TAG, <span class="string">"Silently dropping foreground service launch due to FAS"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// This app knows it is in the new model where this operation is not</span></span><br><span class="line">            <span class="comment">// allowed, so tell it what has happened.</span></span><br><span class="line">            UidRecord uidRec = mAm.mActiveUids.get(r.appInfo.uid);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"?"</span>, <span class="string">"app is in background uid "</span> + uidRec);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// At this point we've applied allowed-to-start policy based on whether this was</span></span><br><span class="line">    <span class="comment">// an ordinary startService() or a startForegroundService().  Now, only require that</span></span><br><span class="line">    <span class="comment">// the app follow through on the startForegroundService() -&gt; startForeground()</span></span><br><span class="line">    <span class="comment">// contract if it actually targets O+.</span></span><br><span class="line">    <span class="keyword">if</span> (r.appInfo.targetSdkVersion &lt; Build.VERSION_CODES.O &amp;&amp; fgRequired) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BACKGROUND_CHECK || DEBUG_FOREGROUND_SERVICE) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"startForegroundService() but host targets "</span></span><br><span class="line">                    + r.appInfo.targetSdkVersion + <span class="string">" - not requiring startForeground()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fgRequired = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NeededUriGrants neededGrants = mAm.checkGrantUriPermissionFromIntentLocked(</span><br><span class="line">            callingUid, r.packageName, service, service.getFlags(), <span class="keyword">null</span>, r.userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If permissions need a review before any of the app components can run,</span></span><br><span class="line">    <span class="comment">// we do not start the service and launch a review activity if the calling app</span></span><br><span class="line">    <span class="comment">// is in the foreground passing it a pending intent to start the service when</span></span><br><span class="line">    <span class="comment">// review is completed.</span></span><br><span class="line">    <span class="keyword">if</span> (mAm.mPermissionReviewRequired) &#123;</span><br><span class="line">        <span class="comment">// XXX This is not dealing with fgRequired!</span></span><br><span class="line">        <span class="keyword">if</span> (!requestStartTargetPermissionsReviewIfNeededLocked(r, callingPackage,</span><br><span class="line">                callingUid, service, callerFg, userId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unscheduleServiceRestartLocked(r, callingUid, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"START SERVICE WHILE RESTART PENDING: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">    r.startRequested = <span class="keyword">true</span>;</span><br><span class="line">    r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line">    r.fgRequired = fgRequired;</span><br><span class="line">    r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</span><br><span class="line">            service, neededGrants, callingUid));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">        <span class="comment">// We are now effectively running a foreground service.</span></span><br><span class="line">        mAm.mAppOpsService.startOperation(AppOpsManager.getToken(mAm.mAppOpsService),</span><br><span class="line">                AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ServiceMap smap = getServiceMapLocked(r.userId);</span><br><span class="line">    <span class="keyword">boolean</span> addToStarting = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!callerFg &amp;&amp; !fgRequired &amp;&amp; r.app == <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line">        ProcessRecord proc = mAm.getProcessRecordLocked(r.processName, r.appInfo.uid, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.curProcState &gt; ActivityManager.PROCESS_STATE_RECEIVER) &#123;</span><br><span class="line">            <span class="comment">// If this is not coming from a foreground caller, then we may want</span></span><br><span class="line">            <span class="comment">// to delay the start if there are already other background services</span></span><br><span class="line">            <span class="comment">// that are starting.  This is to avoid process start spam when lots</span></span><br><span class="line">            <span class="comment">// of applications are all handling things like connectivity broadcasts.</span></span><br><span class="line">            <span class="comment">// We only do this for cached processes, because otherwise an application</span></span><br><span class="line">            <span class="comment">// can have assumptions about calling startService() for a service to run</span></span><br><span class="line">            <span class="comment">// in its own process, and for that process to not be killed before the</span></span><br><span class="line">            <span class="comment">// service is started.  This is especially the case for receivers, which</span></span><br><span class="line">            <span class="comment">// may start a service in onReceive() to do some additional work and have</span></span><br><span class="line">            <span class="comment">// initialized some global state as part of that.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Potential start delay of "</span></span><br><span class="line">                    + r + <span class="string">" in "</span> + proc);</span><br><span class="line">            <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">                <span class="comment">// This service is already scheduled for a delayed start; just leave</span></span><br><span class="line">                <span class="comment">// it still waiting.</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"Continuing to delay: "</span> + r);</span><br><span class="line">                <span class="keyword">return</span> r.name;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (smap.mStartingBackground.size() &gt;= mMaxStartingBackground) &#123;</span><br><span class="line">                <span class="comment">// Something else is starting, delay!</span></span><br><span class="line">                Slog.i(TAG_SERVICE, <span class="string">"Delaying start of: "</span> + r);</span><br><span class="line">                smap.mDelayedStartList.add(r);</span><br><span class="line">                r.delayed = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">return</span> r.name;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"Not delaying: "</span> + r);</span><br><span class="line">            addToStarting = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc.curProcState &gt;= ActivityManager.PROCESS_STATE_SERVICE) &#123;</span><br><span class="line">            <span class="comment">// We slightly loosen when we will enqueue this new service as a background</span></span><br><span class="line">            <span class="comment">// starting service we are waiting for, to also include processes that are</span></span><br><span class="line">            <span class="comment">// currently running other services or receivers.</span></span><br><span class="line">            addToStarting = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Not delaying, but counting as bg: "</span> + r);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">            sb.append(<span class="string">"Not potential delay (state="</span>).append(proc.curProcState)</span><br><span class="line">                    .append(<span class="string">' '</span>).append(proc.adjType);</span><br><span class="line">            String reason = proc.makeAdjReason();</span><br><span class="line">            <span class="keyword">if</span> (reason != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">' '</span>);</span><br><span class="line">                sb.append(reason);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(<span class="string">"): "</span>);</span><br><span class="line">            sb.append(r.toString());</span><br><span class="line">            Slog.v(TAG_SERVICE, sb.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line">        <span class="keyword">if</span> (callerFg || fgRequired) &#123;</span><br><span class="line">            Slog.v(TAG_SERVICE, <span class="string">"Not potential delay (callerFg="</span> + callerFg + <span class="string">" uid="</span></span><br><span class="line">                    + callingUid + <span class="string">" pid="</span> + callingPid + <span class="string">" fgRequired="</span> + fgRequired + <span class="string">"): "</span> + r);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.v(TAG_SERVICE, <span class="string">"Not potential delay (cur app="</span> + r.app + <span class="string">"): "</span> + r);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Not potential delay (user "</span> + r.userId + <span class="string">" not started): "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ComponentName cmp = startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line">    <span class="keyword">return</span> cmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="retrieveServiceLocked"><a href="#retrieveServiceLocked" class="headerlink" title="retrieveServiceLocked"></a>retrieveServiceLocked</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ServiceLookupResult <span class="title">retrieveServiceLocked</span><span class="params">(Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, String callingPackage, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> createIfNeeded, <span class="keyword">boolean</span> callingFromFg, <span class="keyword">boolean</span> isBindExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> allowInstant)</span> </span>&#123;</span><br><span class="line">    ServiceRecord r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"retrieveServiceLocked: "</span> + service</span><br><span class="line">            + <span class="string">" type="</span> + resolvedType + <span class="string">" callingUid="</span> + callingUid);</span><br><span class="line"></span><br><span class="line">    userId = mAm.mUserController.handleIncomingUser(callingPid, callingUid, userId, <span class="keyword">false</span>,</span><br><span class="line">            ActivityManagerService.ALLOW_NON_FULL_IN_PROFILE, <span class="string">"service"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    ServiceMap smap = getServiceMapLocked(userId);</span><br><span class="line">    <span class="keyword">final</span> ComponentName comp = service.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r = smap.mServicesByName.get(comp);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE &amp;&amp; r != <span class="keyword">null</span>) Slog.v(TAG_SERVICE, <span class="string">"Retrieved by component: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span> &amp;&amp; !isBindExternal) &#123;</span><br><span class="line">        Intent.FilterComparison filter = <span class="keyword">new</span> Intent.FilterComparison(service);</span><br><span class="line">        r = smap.mServicesByIntent.get(filter);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE &amp;&amp; r != <span class="keyword">null</span>) Slog.v(TAG_SERVICE, <span class="string">"Retrieved by intent: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; (r.serviceInfo.flags &amp; ServiceInfo.FLAG_EXTERNAL_SERVICE) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; !callingPackage.equals(r.packageName)) &#123;</span><br><span class="line">        <span class="comment">// If an external service is running within its own package, other packages</span></span><br><span class="line">        <span class="comment">// should not bind to that instance.</span></span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Whoops, can't use existing external service"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> flags = ActivityManagerService.STOCK_PM_FLAGS</span><br><span class="line">                    | PackageManager.MATCH_DEBUG_TRIAGED_MISSING;</span><br><span class="line">            <span class="keyword">if</span> (allowInstant) &#123;</span><br><span class="line">                flags |= PackageManager.MATCH_INSTANT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> come back and remove this assumption to triage all services</span></span><br><span class="line">            ResolveInfo rInfo = mAm.getPackageManagerInternalLocked().resolveService(service,</span><br><span class="line">                    resolvedType, flags, userId, callingUid);</span><br><span class="line">            ServiceInfo sInfo =</span><br><span class="line">                rInfo != <span class="keyword">null</span> ? rInfo.serviceInfo : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (sInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG_SERVICE, <span class="string">"Unable to start service "</span> + service + <span class="string">" U="</span> + userId +</span><br><span class="line">                      <span class="string">": not found"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ComponentName name = <span class="keyword">new</span> ComponentName(</span><br><span class="line">                    sInfo.applicationInfo.packageName, sInfo.name);</span><br><span class="line">            <span class="keyword">if</span> ((sInfo.flags &amp; ServiceInfo.FLAG_EXTERNAL_SERVICE) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBindExternal) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!sInfo.exported) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                                <span class="string">" is not exported"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((sInfo.flags &amp; ServiceInfo.FLAG_ISOLATED_PROCESS) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                                <span class="string">" is not an isolatedProcess"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Run the service under the calling package's application.</span></span><br><span class="line">                    ApplicationInfo aInfo = AppGlobals.getPackageManager().getApplicationInfo(</span><br><span class="line">                            callingPackage, ActivityManagerService.STOCK_PM_FLAGS, userId);</span><br><span class="line">                    <span class="keyword">if</span> (aInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> +</span><br><span class="line">                                <span class="string">"could not resolve client package "</span> + callingPackage);</span><br><span class="line">                    &#125;</span><br><span class="line">                    sInfo = <span class="keyword">new</span> ServiceInfo(sInfo);</span><br><span class="line">                    sInfo.applicationInfo = <span class="keyword">new</span> ApplicationInfo(sInfo.applicationInfo);</span><br><span class="line">                    sInfo.applicationInfo.packageName = aInfo.packageName;</span><br><span class="line">                    sInfo.applicationInfo.uid = aInfo.uid;</span><br><span class="line">                    name = <span class="keyword">new</span> ComponentName(aInfo.packageName, name.getClassName());</span><br><span class="line">                    service.setComponent(name);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE required for "</span> +</span><br><span class="line">                            name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBindExternal) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                        <span class="string">" is not an externalService"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mAm.isSingleton(sInfo.processName, sInfo.applicationInfo,</span><br><span class="line">                        sInfo.name, sInfo.flags)</span><br><span class="line">                        &amp;&amp; mAm.isValidSingletonCall(callingUid, sInfo.applicationInfo.uid)) &#123;</span><br><span class="line">                    userId = <span class="number">0</span>;</span><br><span class="line">                    smap = getServiceMapLocked(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                sInfo = <span class="keyword">new</span> ServiceInfo(sInfo);</span><br><span class="line">                sInfo.applicationInfo = mAm.getAppInfoForUser(sInfo.applicationInfo, userId);</span><br><span class="line">            &#125;</span><br><span class="line">            r = smap.mServicesByName.get(name);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE &amp;&amp; r != <span class="keyword">null</span>) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Retrieved via pm by intent: "</span> + r);</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span> &amp;&amp; createIfNeeded) &#123;</span><br><span class="line">                <span class="keyword">final</span> Intent.FilterComparison filter</span><br><span class="line">                        = <span class="keyword">new</span> Intent.FilterComparison(service.cloneFilter());</span><br><span class="line">                <span class="keyword">final</span> ServiceRestarter res = <span class="keyword">new</span> ServiceRestarter();</span><br><span class="line">                <span class="keyword">final</span> BatteryStatsImpl.Uid.Pkg.Serv ss;</span><br><span class="line">                <span class="keyword">final</span> BatteryStatsImpl stats = mAm.mBatteryStatsService.getActiveStatistics();</span><br><span class="line">                <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">                    ss = stats.getServiceStatsLocked(</span><br><span class="line">                            sInfo.applicationInfo.uid, sInfo.packageName,</span><br><span class="line">                            sInfo.name);</span><br><span class="line">                &#125;</span><br><span class="line">                r = <span class="keyword">new</span> ServiceRecord(mAm, ss, name, filter, sInfo, callingFromFg, res);</span><br><span class="line">                res.setService(r);</span><br><span class="line">                smap.mServicesByName.put(name, r);</span><br><span class="line">                smap.mServicesByIntent.put(filter, r);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Make sure this component isn't in the pending list.</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=mPendingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ServiceRecord pr = mPendingServices.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (pr.serviceInfo.applicationInfo.uid == sInfo.applicationInfo.uid</span><br><span class="line">                            &amp;&amp; pr.name.equals(name)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Remove pending: "</span> + pr);</span><br><span class="line">                        mPendingServices.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Retrieve created new service: "</span> + r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="comment">// pm is in same process, this will never happen.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAm.checkComponentPermission(r.permission,</span><br><span class="line">                callingPid, callingUid, r.appInfo.uid, r.exported) != PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!r.exported) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Permission Denial: Accessing service "</span> + r.name</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                        + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" that is not exported from uid "</span> + r.appInfo.uid);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(<span class="keyword">null</span>, <span class="string">"not exported from uid "</span></span><br><span class="line">                        + r.appInfo.uid);</span><br><span class="line">            &#125;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Permission Denial: Accessing service "</span> + r.name</span><br><span class="line">                    + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                    + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                    + <span class="string">" requires "</span> + r.permission);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(<span class="keyword">null</span>, r.permission);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.permission != <span class="keyword">null</span> &amp;&amp; callingPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> opCode = AppOpsManager.permissionToOpCode(r.permission);</span><br><span class="line">            <span class="keyword">if</span> (opCode != AppOpsManager.OP_NONE &amp;&amp; mAm.mAppOpsService.noteOperation(</span><br><span class="line">                    opCode, callingUid, callingPackage) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Appop Denial: Accessing service "</span> + r.name</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                        + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" requires appop "</span> + AppOpsManager.opToName(opCode));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mAm.mIntentFirewall.checkService(r.name, service, callingUid, callingPid,</span><br><span class="line">                resolvedType, r.appInfo)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(r, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="startServiceInnerLocked"><a href="#startServiceInnerLocked" class="headerlink" title="startServiceInnerLocked"></a>startServiceInnerLocked</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> callerFg, <span class="keyword">boolean</span> addToStarting)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    ServiceState stracker = r.getTracker();</span><br><span class="line">    <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">        stracker.setStarted(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</span><br><span class="line">    &#125;</span><br><span class="line">    r.callStart = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">        r.stats.startRunningLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    String error = bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!!"</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.startRequested &amp;&amp; addToStarting) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> first = smap.mStartingBackground.size() == <span class="number">0</span>;</span><br><span class="line">        smap.mStartingBackground.add(r);</span><br><span class="line">        r.startingBgTimeout = SystemClock.uptimeMillis() + mAm.mConstants.BG_START_TIMEOUT;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DELAYED_SERVICE) &#123;</span><br><span class="line">            RuntimeException here = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">            here.fillInStackTrace();</span><br><span class="line">            Slog.v(TAG_SERVICE, <span class="string">"Starting background (first="</span> + first + <span class="string">"): "</span> + r, here);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line">            Slog.v(TAG_SERVICE, <span class="string">"Starting background (first="</span> + first + <span class="string">"): "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (first) &#123;</span><br><span class="line">            smap.rescheduleDelayedStartsLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerFg || r.fgRequired) &#123;</span><br><span class="line">        smap.ensureNotStartingBackgroundLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r.name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bringUpServiceLocked"><a href="#bringUpServiceLocked" class="headerlink" title="bringUpServiceLocked"></a>bringUpServiceLocked</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> whileRestarting, <span class="keyword">boolean</span> permissionsReviewRequired)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    <span class="comment">//Slog.i(TAG, "Bring up service:");</span></span><br><span class="line">    <span class="comment">//r.dump("  ");</span></span><br><span class="line"><span class="comment">// 如果 r 中的 app（代表了 r 运行在哪个进程，及 进程中的 线程不为空，表示是已经启动过了的，直接重新传参数过去即可 否则流程继续往下走</span></span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sendServiceArgsLocked(r, execInFg, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!whileRestarting &amp;&amp; mRestartingServices.contains(r)) &#123;</span><br><span class="line">        <span class="comment">// If waiting for a restart, then do nothing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) &#123;</span><br><span class="line">        Slog.v(TAG_SERVICE, <span class="string">"Bringing up "</span> + r + <span class="string">" "</span> + r.intent + <span class="string">" fg="</span> + r.fgRequired);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We are now bringing the service up, so no longer in the</span></span><br><span class="line">    <span class="comment">// restarting state.</span></span><br><span class="line">    <span class="keyword">if</span> (mRestartingServices.remove(r)) &#123;</span><br><span class="line">        clearRestartingIfNeededLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure this service is no longer considered delayed, we are starting it now.</span></span><br><span class="line">    <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (bring up): "</span> + r);</span><br><span class="line">        getServiceMapLocked(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">        r.delayed = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure that the user who owns this service is started.  If not,</span></span><br><span class="line">    <span class="comment">// we don't want to allow it to run.</span></span><br><span class="line">    <span class="keyword">if</span> (!mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line">        String msg = <span class="string">"Unable to launch app "</span></span><br><span class="line">                + r.appInfo.packageName + <span class="string">"/"</span></span><br><span class="line">                + r.appInfo.uid + <span class="string">" for service "</span></span><br><span class="line">                + r.intent.getIntent() + <span class="string">": user "</span> + r.userId + <span class="string">" is stopped"</span>;</span><br><span class="line">        Slog.w(TAG, msg);</span><br><span class="line">        bringDownServiceLocked(r);</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Service is now being launched, its package can't be stopped.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">                r.packageName, <span class="keyword">false</span>, r.userId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed trying to unstop package "</span></span><br><span class="line">                + r.packageName + <span class="string">": "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isolated = (r.serviceInfo.flags&amp;ServiceInfo.FLAG_ISOLATED_PROCESS) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> String procName = r.processName;</span><br><span class="line">    String hostingType = <span class="string">"service"</span>;</span><br><span class="line">    ProcessRecord app;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 非隔离启动，会在与 proName 同一个进程进行执行。</span></span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">      	<span class="comment">// 根据 packagename 和 uid 来获取执行中的进程信息</span></span><br><span class="line">        app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"bringUpServiceLocked: appInfo.uid="</span> + r.appInfo.uid</span><br><span class="line">                    + <span class="string">" app="</span> + app);</span><br><span class="line">      	<span class="comment">// 如果 app 是启动的那就 启动好服务咯</span></span><br><span class="line">        <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                app.addPackage(r.appInfo.packageName, r.appInfo.longVersionCode, mAm.mProcessStats);</span><br><span class="line">                realStartServiceLocked(r, app, execInFg);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Exception when starting service "</span> + r.shortName, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">            <span class="comment">// restart the application.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If this service runs in an isolated process, then each time</span></span><br><span class="line">        <span class="comment">// we call startProcessLocked() we will get a new isolated</span></span><br><span class="line">        <span class="comment">// process, starting another process if we are currently waiting</span></span><br><span class="line">        <span class="comment">// for a previous process to come up.  To deal with this, we store</span></span><br><span class="line">        <span class="comment">// in the service any current isolated process it is running in or</span></span><br><span class="line">        <span class="comment">// waiting to have come up.</span></span><br><span class="line">        app = r.isolatedProc;</span><br><span class="line">        <span class="keyword">if</span> (WebViewZygote.isMultiprocessEnabled()</span><br><span class="line">                &amp;&amp; r.serviceInfo.packageName.equals(WebViewZygote.getPackageName())) &#123;</span><br><span class="line">            hostingType = <span class="string">"webview_service"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Not running -- get it started, and enqueue this service record</span></span><br><span class="line">    <span class="comment">// to be executed when the app comes up.</span></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span> &amp;&amp; !permissionsReviewRequired) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((app=mAm.startProcessLocked(procName, r.appInfo, <span class="keyword">true</span>, intentFlags,</span><br><span class="line">                hostingType, r.name, <span class="keyword">false</span>, isolated, <span class="keyword">false</span>)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String msg = <span class="string">"Unable to launch app "</span></span><br><span class="line">                    + r.appInfo.packageName + <span class="string">"/"</span></span><br><span class="line">                    + r.appInfo.uid + <span class="string">" for service "</span></span><br><span class="line">                    + r.intent.getIntent() + <span class="string">": process is bad"</span>;</span><br><span class="line">            Slog.w(TAG, msg);</span><br><span class="line">            bringDownServiceLocked(r);</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">            r.isolatedProc = app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.fgRequired) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_FOREGROUND_SERVICE) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"Whitelisting "</span> + UserHandle.formatUid(r.appInfo.uid)</span><br><span class="line">                    + <span class="string">" for fg-service launch"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mAm.tempWhitelistUidLocked(r.appInfo.uid,</span><br><span class="line">                SERVICE_START_FOREGROUND_TIMEOUT, <span class="string">"fg-service-launch"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mPendingServices.contains(r)) &#123;</span><br><span class="line">        mPendingServices.add(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line">        <span class="comment">// Oh and hey we've already been asked to stop!</span></span><br><span class="line">        r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Applying delayed stop (in bring up): "</span> + r);</span><br><span class="line">            stopServiceLocked(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="realStartServiceLocked"><a href="#realStartServiceLocked" class="headerlink" title="realStartServiceLocked"></a>realStartServiceLocked</h2><p>这里会将逻辑交给 app.thread 也就是调用进程（线程）进行调度，建立好服务。</p>
<p>然后再发送参数过去，进行启动，触发调用  <code>onStartCommand</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProcessRecord app, <span class="keyword">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU)</span><br><span class="line">        Slog.v(TAG_MU, <span class="string">"realStartServiceLocked, ServiceRecord.uid = "</span> + r.appInfo.uid</span><br><span class="line">                + <span class="string">", ProcessRecord.uid = "</span> + app.uid);</span><br><span class="line">    r.app = app;</span><br><span class="line">    r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</span><br><span class="line">    bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</span><br><span class="line">    mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    updateServiceForegroundLocked(r.app, <span class="comment">/* oomAdj= */</span> <span class="keyword">false</span>);</span><br><span class="line">    mAm.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG_SERVICE_START_STOP) &#123;</span><br><span class="line">            String nameTerm;</span><br><span class="line">            <span class="keyword">int</span> lastPeriod = r.shortName.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">            nameTerm = lastPeriod &gt;= <span class="number">0</span> ? r.shortName.substring(lastPeriod) : r.shortName;</span><br><span class="line">            EventLogTags.writeAmCreateService(</span><br><span class="line">                    r.userId, System.identityHashCode(r), nameTerm, r.app.uid, r.app.pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">            r.stats.startLaunchedLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        mAm.notifyPackageUse(r.serviceInfo.packageName,</span><br><span class="line">                             PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</span><br><span class="line">        app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line">                app.repProcState);</span><br><span class="line">        r.postNotification();</span><br><span class="line">        created = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Application dead when creating service "</span> + r);</span><br><span class="line">        mAm.appDiedLocked(app);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!created) &#123;</span><br><span class="line">            <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Cleanup.</span></span><br><span class="line">            <span class="keyword">if</span> (newService) &#123;</span><br><span class="line">                app.services.remove(r);</span><br><span class="line">                r.app = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Retry.</span></span><br><span class="line">            <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line">                scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">        app.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    requestServiceBindingsLocked(r, execInFg);</span><br><span class="line"></span><br><span class="line">    updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the service is in the started state, and there are no</span></span><br><span class="line">    <span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></span><br><span class="line">    <span class="comment">// be called.</span></span><br><span class="line">    <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (new proc): "</span> + r);</span><br><span class="line">        getServiceMapLocked(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">        r.delayed = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line">        <span class="comment">// Oh and hey we've already been asked to stop!</span></span><br><span class="line">        r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Applying delayed stop (from start): "</span> + r);</span><br><span class="line">            stopServiceLocked(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="requestServiceBindingsLocked"><a href="#requestServiceBindingsLocked" class="headerlink" title="requestServiceBindingsLocked"></a>requestServiceBindingsLocked</h2><h2 id="updateServiceClientActivitiesLocked"><a href="#updateServiceClientActivitiesLocked" class="headerlink" title="updateServiceClientActivitiesLocked"></a>updateServiceClientActivitiesLocked</h2><h2 id="sendServiceArgsLocked"><a href="#sendServiceArgsLocked" class="headerlink" title="sendServiceArgsLocked"></a>sendServiceArgsLocked</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sendServiceArgsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> oomAdjusted)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = r.pendingStarts.size();</span><br><span class="line">    <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;ServiceStartArgs&gt; args = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (r.pendingStarts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ServiceRecord.StartItem si = r.pendingStarts.remove(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) &#123;</span><br><span class="line">            Slog.v(TAG_SERVICE, <span class="string">"Sending arguments to: "</span></span><br><span class="line">                    + r + <span class="string">" "</span> + r.intent + <span class="string">" args="</span> + si.intent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (si.intent == <span class="keyword">null</span> &amp;&amp; N &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// If somehow we got a dummy null intent in the middle,</span></span><br><span class="line">            <span class="comment">// then skip it.  DO NOT skip a null intent when it is</span></span><br><span class="line">            <span class="comment">// the only one in the list -- this is to support the</span></span><br><span class="line">            <span class="comment">// onStartCommand(null) case.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        si.deliveredTime = SystemClock.uptimeMillis();</span><br><span class="line">        r.deliveredStarts.add(si);</span><br><span class="line">        si.deliveryCount++;</span><br><span class="line">        <span class="keyword">if</span> (si.neededGrants != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mAm.grantUriPermissionUncheckedFromIntentLocked(si.neededGrants,</span><br><span class="line">                    si.getUriPermissionsLocked());</span><br><span class="line">        &#125;</span><br><span class="line">        mAm.grantEphemeralAccessLocked(r.userId, si.intent,</span><br><span class="line">                r.appInfo.uid, UserHandle.getAppId(si.callingId));</span><br><span class="line">        bumpServiceExecutingLocked(r, execInFg, <span class="string">"start"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!oomAdjusted) &#123;</span><br><span class="line">            oomAdjusted = <span class="keyword">true</span>;</span><br><span class="line">            mAm.updateOomAdjLocked(r.app, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r.fgRequired &amp;&amp; !r.fgWaiting) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!r.isForeground) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_BACKGROUND_CHECK) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Launched service must call startForeground() within timeout: "</span> + r);</span><br><span class="line">                &#125;</span><br><span class="line">                scheduleServiceForegroundTransitionTimeoutLocked(r);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_BACKGROUND_CHECK) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Service already foreground; no new timeout: "</span> + r);</span><br><span class="line">                &#125;</span><br><span class="line">                r.fgRequired = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (si.deliveryCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            flags |= Service.START_FLAG_RETRY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (si.doneExecutingCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            flags |= Service.START_FLAG_REDELIVERY;</span><br><span class="line">        &#125;</span><br><span class="line">        args.add(<span class="keyword">new</span> ServiceStartArgs(si.taskRemoved, si.id, flags, si.intent));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ParceledListSlice&lt;ServiceStartArgs&gt; slice = <span class="keyword">new</span> ParceledListSlice&lt;&gt;(args);</span><br><span class="line">    slice.setInlineCountLimit(<span class="number">4</span>);</span><br><span class="line">    Exception caughtException = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        r.app.thread.scheduleServiceArgs(r, slice);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Transaction too large for "</span> + args.size()</span><br><span class="line">                + <span class="string">" args, first: "</span> + args.get(<span class="number">0</span>).args);</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed delivering service starts"</span>, e);</span><br><span class="line">        caughtException = e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// Remote process gone...  we'll let the normal cleanup take care of this.</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while sending args: "</span> + r);</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed delivering service starts"</span>, e);</span><br><span class="line">        caughtException = e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">        caughtException = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (caughtException != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Keep nesting count correct</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.size(); i++) &#123;</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (caughtException <span class="keyword">instanceof</span> TransactionTooLargeException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (TransactionTooLargeException)caughtException;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ApplicationThread"><a href="#ApplicationThread" class="headerlink" title="ApplicationThread"></a>ApplicationThread</h1><h2 id="scheduleCreateService"><a href="#scheduleCreateService" class="headerlink" title="scheduleCreateService"></a>scheduleCreateService</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState)</span> </span>&#123;</span><br><span class="line">    updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line">    CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</span><br><span class="line">    s.token = token;</span><br><span class="line">    s.info = info;</span><br><span class="line">    s.compatInfo = compatInfo;</span><br><span class="line">    sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="scheduleServiceArgs"><a href="#scheduleServiceArgs" class="headerlink" title="scheduleServiceArgs"></a>scheduleServiceArgs</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleServiceArgs</span><span class="params">(IBinder token, ParceledListSlice args)</span> </span>&#123;</span><br><span class="line">    List&lt;ServiceStartArgs&gt; list = args.getList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">        ServiceStartArgs ssa = list.get(i);</span><br><span class="line">        ServiceArgsData s = <span class="keyword">new</span> ServiceArgsData();</span><br><span class="line">        s.token = token;</span><br><span class="line">        s.taskRemoved = ssa.taskRemoved;</span><br><span class="line">        s.startId = ssa.startId;</span><br><span class="line">        s.flags = ssa.flags;</span><br><span class="line">        s.args = ssa.args;</span><br><span class="line">        sendMessage(H.SERVICE_ARGS, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ActivityThread-H"><a href="#ActivityThread-H" class="headerlink" title="ActivityThread.H"></a>ActivityThread.H</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj)</span> </span>&#123;</span><br><span class="line">    sendMessage(what, obj, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1)</span> </span>&#123;</span><br><span class="line">    sendMessage(what, obj, arg1, <span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2)</span> </span>&#123;</span><br><span class="line">    sendMessage(what, obj, arg1, arg2, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(</span><br><span class="line">        TAG, <span class="string">"SCHEDULE "</span> + what + <span class="string">" "</span> + mH.codeToString(what)</span><br><span class="line">        + <span class="string">": "</span> + arg1 + <span class="string">" / "</span> + obj);</span><br><span class="line">    Message msg = Message.obtain();</span><br><span class="line">    msg.what = what;</span><br><span class="line">    msg.obj = obj;</span><br><span class="line">    msg.arg1 = arg1;</span><br><span class="line">    msg.arg2 = arg2;</span><br><span class="line">    <span class="keyword">if</span> (async) &#123;</span><br><span class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mH.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="handleMessage"><a href="#handleMessage" class="headerlink" title="handleMessage"></a>handleMessage</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> CREATE_SERVICE:</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (<span class="string">"serviceCreate: "</span> + String.valueOf(msg.obj)));</span><br><span class="line">            handleCreateService((CreateServiceData)msg.obj);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> SERVICE_ARGS:</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (<span class="string">"serviceStart: "</span> + String.valueOf(msg.obj)));</span><br><span class="line">            handleServiceArgs((ServiceArgsData)msg.obj);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">    Object obj = msg.obj;</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> SomeArgs) &#123;</span><br><span class="line">        ((SomeArgs) obj).recycle();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&lt;&lt;&lt; done: "</span> + codeToString(msg.what));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="handleCreateService"><a href="#handleCreateService" class="headerlink" title="handleCreateService"></a>handleCreateService</h3><p>这里才真正的构建服务。</p>
<ol>
<li>通过 classloader 来初始化类。</li>
<li>设置上下文</li>
<li>设置 ActivityThread 和 AMS</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">    <span class="comment">// we are back active so skip it.</span></span><br><span class="line">    unscheduleGcIdler();</span><br><span class="line"></span><br><span class="line">    LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">            data.info.applicationInfo, data.compatInfo);</span><br><span class="line">    Service service = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = packageInfo.getClassLoader();</span><br><span class="line">        service = packageInfo.getAppFactory()</span><br><span class="line">                .instantiateService(cl, data.info.name, data.intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate service "</span> + data.info.name</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Creating service "</span> + data.info.name);</span><br><span class="line">				<span class="comment">// 主要的启动逻辑就在这里了</span></span><br><span class="line">        ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</span><br><span class="line">        context.setOuterContext(service);</span><br><span class="line"></span><br><span class="line">        Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</span><br><span class="line">                ActivityManager.getService());</span><br><span class="line">      	<span class="comment">// 调用  onCreate</span></span><br><span class="line">        service.onCreate();</span><br><span class="line">      	<span class="comment">// 放入本地服务列表中</span></span><br><span class="line">        mServices.put(data.token, service);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          	<span class="comment">// 通知 AMS </span></span><br><span class="line">            ActivityManager.getService().serviceDoneExecuting(</span><br><span class="line">                    data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to create service "</span> + data.info.name</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="handleServiceArgs"><a href="#handleServiceArgs" class="headerlink" title="handleServiceArgs"></a>handleServiceArgs</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleServiceArgs</span><span class="params">(ServiceArgsData data)</span> </span>&#123;</span><br><span class="line">    Service s = mServices.get(data.token);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data.args != <span class="keyword">null</span>) &#123;</span><br><span class="line">                data.args.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">                data.args.prepareToEnterProcess();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> res;</span><br><span class="line">            <span class="keyword">if</span> (!data.taskRemoved) &#123;</span><br><span class="line">                res = s.onStartCommand(data.args, data.flags, data.startId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                s.onTaskRemoved(data.args);</span><br><span class="line">                res = Service.START_TASK_REMOVED_COMPLETE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            QueuedWork.waitToFinish();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManager.getService().serviceDoneExecuting(</span><br><span class="line">                        data.token, SERVICE_DONE_EXECUTING_START, data.startId, res);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">            ensureJitEnabled();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to start service "</span> + s</span><br><span class="line">                        + <span class="string">" with "</span> + data.args + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ActivityManagerService-1"><a href="#ActivityManagerService-1" class="headerlink" title="ActivityManagerService"></a>ActivityManagerService</h1><h2 id="serviceDoneExecuting"><a href="#serviceDoneExecuting" class="headerlink" title="serviceDoneExecuting"></a>serviceDoneExecuting</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceDoneExecuting</span><span class="params">(IBinder token, <span class="keyword">int</span> type, <span class="keyword">int</span> startId, <span class="keyword">int</span> res)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"serviceDoneExecuting: Invalid service token="</span> + token);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mServices.serviceDoneExecutingLocked((ServiceRecord)token, type, startId, res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ActiveServices-1"><a href="#ActiveServices-1" class="headerlink" title="ActiveServices"></a>ActiveServices</h1><h2 id="serviceDoneExecutingLocked"><a href="#serviceDoneExecutingLocked" class="headerlink" title="serviceDoneExecutingLocked"></a>serviceDoneExecutingLocked</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> type, <span class="keyword">int</span> startId, <span class="keyword">int</span> res)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == ActivityThread.SERVICE_DONE_EXECUTING_START) &#123;</span><br><span class="line">            <span class="comment">// This is a call from a service start...  take care of</span></span><br><span class="line">            <span class="comment">// book-keeping.</span></span><br><span class="line">            r.callStart = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">switch</span> (res) &#123;</span><br><span class="line">                <span class="keyword">case</span> Service.START_STICKY_COMPATIBILITY:</span><br><span class="line">                <span class="keyword">case</span> Service.START_STICKY: &#123;</span><br><span class="line">                    <span class="comment">// We are done with the associated start arguments.</span></span><br><span class="line">                    r.findDeliveredStart(startId, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// Don't stop if killed.</span></span><br><span class="line">                    r.stopIfKilled = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> Service.START_NOT_STICKY: &#123;</span><br><span class="line">                    <span class="comment">// We are done with the associated start arguments.</span></span><br><span class="line">                    r.findDeliveredStart(startId, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (r.getLastStartId() == startId) &#123;</span><br><span class="line">                        <span class="comment">// There is no more work, and this service</span></span><br><span class="line">                        <span class="comment">// doesn't want to hang around if killed.</span></span><br><span class="line">                        r.stopIfKilled = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> Service.START_REDELIVER_INTENT: &#123;</span><br><span class="line">                    <span class="comment">// We'll keep this item until they explicitly</span></span><br><span class="line">                    <span class="comment">// call stop for it, but keep track of the fact</span></span><br><span class="line">                    <span class="comment">// that it was delivered.</span></span><br><span class="line">                    ServiceRecord.StartItem si = r.findDeliveredStart(startId, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (si != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        si.deliveryCount = <span class="number">0</span>;</span><br><span class="line">                        si.doneExecutingCount++;</span><br><span class="line">                        <span class="comment">// Don't stop if killed.</span></span><br><span class="line">                        r.stopIfKilled = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> Service.START_TASK_REMOVED_COMPLETE: &#123;</span><br><span class="line">                    <span class="comment">// Special processing for onTaskRemoved().  Don't</span></span><br><span class="line">                    <span class="comment">// impact normal onStartCommand() processing.</span></span><br><span class="line">                    r.findDeliveredStart(startId, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                            <span class="string">"Unknown service start result: "</span> + res);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (res == Service.START_STICKY_COMPATIBILITY) &#123;</span><br><span class="line">                r.callStart = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == ActivityThread.SERVICE_DONE_EXECUTING_STOP) &#123;</span><br><span class="line">            <span class="comment">// This is the final call from destroying the service...  we should</span></span><br><span class="line">            <span class="comment">// actually be getting rid of the service at this point.  Do some</span></span><br><span class="line">            <span class="comment">// validation of its state, and ensure it will be fully removed.</span></span><br><span class="line">            <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line">                <span class="comment">// Not sure what else to do with this...  if it is not actually in the</span></span><br><span class="line">                <span class="comment">// destroying list, we don't need to make sure to remove it from it.</span></span><br><span class="line">                <span class="comment">// If the app is null, then it was probably removed because the process died,</span></span><br><span class="line">                <span class="comment">// otherwise wtf</span></span><br><span class="line">                <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Service done with onDestroy, but not inDestroying: "</span></span><br><span class="line">                            + r + <span class="string">", app="</span> + r.app);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.executeNesting != <span class="number">1</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Service done with onDestroy, but executeNesting="</span></span><br><span class="line">                        + r.executeNesting + <span class="string">": "</span> + r);</span><br><span class="line">                <span class="comment">// Fake it to keep from ANR due to orphaned entry.</span></span><br><span class="line">                r.executeNesting = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Done executing unknown service from pid "</span></span><br><span class="line">                + Binder.getCallingPid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="serviceDoneExecutingLocked-1"><a href="#serviceDoneExecutingLocked-1" class="headerlink" title="serviceDoneExecutingLocked"></a>serviceDoneExecutingLocked</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> inDestroying,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> finishing)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r</span><br><span class="line">            + <span class="string">": nesting="</span> + r.executeNesting</span><br><span class="line">            + <span class="string">", inDestroying="</span> + inDestroying + <span class="string">", app="</span> + r.app);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</span><br><span class="line">            <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r.shortName);</span><br><span class="line">    r.executeNesting--;</span><br><span class="line">    <span class="keyword">if</span> (r.executeNesting &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Nesting at 0 of "</span> + r.shortName);</span><br><span class="line">            r.app.execServicesFg = <span class="keyword">false</span>;</span><br><span class="line">            r.app.executingServices.remove(r);</span><br><span class="line">            <span class="keyword">if</span> (r.app.executingServices.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE || DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</span><br><span class="line">                        <span class="string">"No more executingServices of "</span> + r.shortName);</span><br><span class="line">                mAm.mHandler.removeMessages(ActivityManagerService.SERVICE_TIMEOUT_MSG, r.app);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.executeFg) &#123;</span><br><span class="line">                <span class="comment">// Need to re-evaluate whether the app still needs to be in the foreground.</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=r.app.executingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.app.executingServices.valueAt(i).executeFg) &#123;</span><br><span class="line">                        r.app.execServicesFg = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (inDestroying) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">                        <span class="string">"doneExecuting remove destroying "</span> + r);</span><br><span class="line">                mDestroyingServices.remove(r);</span><br><span class="line">                r.bindings.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            mAm.updateOomAdjLocked(r.app, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        r.executeFg = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.tracker.setExecuting(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                r.tracker.clearCurrentOwner(r, <span class="keyword">false</span>);</span><br><span class="line">                r.tracker = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; !r.app.persistent) &#123;</span><br><span class="line">                r.app.services.remove(r);</span><br><span class="line">                <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">                    updateWhitelistManagerLocked(r.app);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            r.app = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>若我们在 Activity 里面进行启动服务，那么会通过 AMS 的 binder 将消息发送过去。</li>
<li>AMS 通过其中的 ActiveServices 来进行启动检查。</li>
<li>将服务参数传递给调用进程的 ApplicationThread 进行调度。</li>
<li>ApplicationThread 将消息发给 ActivityThread。</li>
<li>告知 AMS 已经构建服务完毕。AMS 执行了一系列的操作后，会再次往 ApplicationThread  发送启动消息。</li>
<li>ActivityThread 由其调用 onStartCommand 回调进行启动逻辑，完毕后告知 AMS。</li>
<li>启动完毕。</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/Service/" rel="tag"># Service</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/Android/androLuaPro的架构解析.html" rel="next" title="androLuaPro的架构解析">
                  <i class="fa fa-chevron-left"></i> androLuaPro的架构解析
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/Android/Android的Launcher启动流程代码.html" rel="prev" title="Android的Launcher启动流程代码">
                  Android的Launcher启动流程代码 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#服务状态"><span class="nav-number">1.</span> <span class="nav-text">服务状态</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ContextImpl"><span class="nav-number">2.</span> <span class="nav-text">ContextImpl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#startService"><span class="nav-number">2.1.</span> <span class="nav-text">startService</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ActivityManagerService"><span class="nav-number">3.</span> <span class="nav-text">ActivityManagerService</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#startService-1"><span class="nav-number">3.1.</span> <span class="nav-text">startService</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ActiveServices"><span class="nav-number">4.</span> <span class="nav-text">ActiveServices</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#startServiceLocked"><span class="nav-number">4.1.</span> <span class="nav-text">startServiceLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#retrieveServiceLocked"><span class="nav-number">4.2.</span> <span class="nav-text">retrieveServiceLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#startServiceInnerLocked"><span class="nav-number">4.3.</span> <span class="nav-text">startServiceInnerLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bringUpServiceLocked"><span class="nav-number">4.4.</span> <span class="nav-text">bringUpServiceLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#realStartServiceLocked"><span class="nav-number">4.5.</span> <span class="nav-text">realStartServiceLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#requestServiceBindingsLocked"><span class="nav-number">4.6.</span> <span class="nav-text">requestServiceBindingsLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#updateServiceClientActivitiesLocked"><span class="nav-number">4.7.</span> <span class="nav-text">updateServiceClientActivitiesLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sendServiceArgsLocked"><span class="nav-number">4.8.</span> <span class="nav-text">sendServiceArgsLocked</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ApplicationThread"><span class="nav-number">5.</span> <span class="nav-text">ApplicationThread</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#scheduleCreateService"><span class="nav-number">5.1.</span> <span class="nav-text">scheduleCreateService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#scheduleServiceArgs"><span class="nav-number">5.2.</span> <span class="nav-text">scheduleServiceArgs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActivityThread-H"><span class="nav-number">5.3.</span> <span class="nav-text">ActivityThread.H</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#handleMessage"><span class="nav-number">5.3.1.</span> <span class="nav-text">handleMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#handleCreateService"><span class="nav-number">5.3.2.</span> <span class="nav-text">handleCreateService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#handleServiceArgs"><span class="nav-number">5.3.3.</span> <span class="nav-text">handleServiceArgs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ActivityManagerService-1"><span class="nav-number">6.</span> <span class="nav-text">ActivityManagerService</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#serviceDoneExecuting"><span class="nav-number">6.1.</span> <span class="nav-text">serviceDoneExecuting</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ActiveServices-1"><span class="nav-number">7.</span> <span class="nav-text">ActiveServices</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#serviceDoneExecutingLocked"><span class="nav-number">7.1.</span> <span class="nav-text">serviceDoneExecutingLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serviceDoneExecutingLocked-1"><span class="nav-number">7.2.</span> <span class="nav-text">serviceDoneExecutingLocked</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Gowa2017 Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">356</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gowa2017" title="GitHub → https://github.com/gowa2017" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shouzheng.zhang@gmail.com" title="E-Mail → mailto:shouzheng.zhang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-json"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gowa2017 Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js"></script><script src="/js/algolia-search.js"></script>














  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://gowa-1.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://gowa.club/Android/Android的Service.html",
            identifier: "Android/Android的Service.html",
            title: "Android的Service"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://gowa-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    window.addEventListener('load', loadComments, false);
</script>

</body>
</html>
